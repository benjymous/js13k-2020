<body style="background: #000;cursor: none">
  <!-- 
    
    TODO 
  
    * Tutorial stage explaining locks and combos
    * Max combo - actually do something, take locks into account
    * Backgrounds for abandoned bases, ruins and crashsites
    * more enemy wave types
    * hyperspace sequence
    * varying fuel prices
    * location clues
    * actual endgame
    * better gameover
    * handle long menus (pagninate?)
  
  -->

  <!--
  ///#define _decompose_ d
  ///#define _update_ u
  ///#define _show_ s
  ///#define _hide_ h
  ///#define _textwidget_ t
  ///#define _addMenu_ am
  ///#define _hideMenu_ hm
  ///#define _endMenu_ em
  ///#define _critter_ a
  ///#define _dead_ d
  ///#define _items_ it
  ///#define _temp_ p

  ///#define _getWeighted_ az
  ///#define _showmap_ bz
  ///#define _showorbit_ cz
  ///#define _showgame_ dz
  ///#define _updatemap_ ez
  ///#define _showtitle_ fz
  ///#define _showwarp_ gz
  ///#define _calcfuel_ hz
  ///#define _clamp_ iz
  ///#define _showtrade_ lz
  ///#define _entersystem_ mz
  ///#define _calcdistance_ nz
  
  ///#define _inventory_ pz

  ///#define _sqr_ qz

  ///#define _place_ p
  ///#define _visited_ v
  ///#define _explored_ e
  ///#define _scanned_ n
  ///#define _economy_ t

  ///#define _factionmap_ fmp

  ///#define _lock_ fx1
  ///#define _explosion_ fx2
  ///#define _shoot_ fx3
  ///#define _wave1_ fx4
  ///#define _zap_ fx5
  ///#define _shields_ fx6
  ///#define _gameover_ fx7
  ///#define zzfx fx

  ///#define _songdata_ fx0

  ///#define _sci_ x
  ///#define _trade_ y
  ///#define _war_ z
  ///#define _salvage_ s
  ///#define _research_ r
  -->

  <svg id="c" viewBox="0 0 640 640" style="position:absolute;top:0;left:0;height:100%;width:100%">
    <style>
      .heavy {
        font: bold 20px monospace;
      }
      .big {
        font: 25px monospace;
      }
      .bigger {
        font: 40px monospace;
      }
    </style>
    <clipPath id="clip">
      <path d="M0 0h640v640H0z"/>
    </clipPath>
    <filter id="g" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="z1"/>
      <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="z2"/>
      <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="z3"/>
      <feMerge>
        <feMergeNode in="z1"/>
        <feMergeNode in="z2"/>
        <feMergeNode in="z3"/>
      </feMerge>
    </filter>
    <filter id="f1" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1"/>
    </filter>
    <filter id="f3" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="3"/>
    </filter>
    <filter id="f10" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="10"/>
    </filter>

    <g clip-path="url(#clip)">

      <g id="orbit" filter="url(#f1)">

        <circle fill="#000" stroke-width="1.5" id="orbit_planet"/>
        <circle fill="#000" stroke-width="1.5" id="orbit_moon"/>

        <text x=20 y=40 fill="#fff" class="big">Currently in orbit at</text>
        <text id="orbitcoords" x=400 y=40 fill="#fff" class="big">[0:0]</text>

        <text x=20 y=500 fill="#fff" class="big">System Information</text>
        <text x=60 y=530 fill="#fff" class="big">Faction:</text>
        <text id="infofaction" x=300 y=530 fill="#fff" class="big"/>
        <text x=60 y=560 fill="#fff" class="big">Economy:</text>
        <text id="infotrade" x=300 y=560 fill="#fff" class="big"/>
        <text x=60 y=590 fill="#fff" class="big">Discovery:</text>
        <text id="infopoi" x=300 y=590 fill="#fff" class="big"/>
      </g>
      <g id="base" filter="url(#f1)">
        <circle id="base_moon" stroke="#fff" stroke-width="1.5" fill="#000"/>
        <ellipse id="base_planet" stroke="#fff" ry="200" rx="500" cy="478" cx="320" stroke-width="1.5" fill="#000"/>
        
        <path id="base_sc1" transform="translate(-320,300)" stroke-width="1.5" stroke="#555" d="m0 50 h470 l -10 -200  h-10 v-10 h100 v10 h-10 l-10 200 h470  v400 h-1000 z"/>
        <path id="base_sc2" transform="translate(50,300)" stroke-width="1.5" stroke="#888" d="m0 0 h225 v60 h10 v-50 h30 v70 h10 v-90 l100 10 v40 h150 v100 h10 v-200 h50 v130 h20 v-50 l100 -10 v30 h10 v-40 h60 v60 h5 v-100 h220    v400 h-1000 z"/> 
        <path id="base_sc3" transform="translate(-150,300)" stroke-width="1.5" stroke="#bbb" d="m0 10 h190 v100 h90 v-36 h70 v50 h185 v-90 l60 -20 v40 h25 v60 h40 v-100 h50 v130 h20 v-50 l10 5 v30 h10 v-40 h20 v60 h45 v-100 h180    v400 h-1000 z"/> 
        <path id="base_sc4" transform="translate(-150, 300)" stroke-width="1.5" stroke="#eee" d="m0 180 h440    l 10 -80   l 50 -20 l50 20   l10 80 h440    v400 h-1000 z"/>

        <text x=20 y=40 fill="#fff" class="big">Discovered</text>
        <text id="tradename" x=200 y=40 fill="#fff" class="big">???</text> 
      </g>
      <g id="game">
        <g filter="url(#g)" id="l1">
          <g id="l10">.</g> <!-- landscape -->
          <g id="l11">.</g> <!-- missiles and targets -->
          <path d="M0 0 H640 V640 H-640 Z" fill="#000" fill-opacity="0.1"/>

          <g id="l12">.</g> <!-- enemies -->
          <g id="ship">
            <path id="shipd" d="M0 0" stroke-width="0.2" stroke="#fff" fill-opacity="0"/>
            <circle id="ships" x="0" y="0" r="6" stroke="#00f" stroke-width="0.2" fill-opacity="0.3" fill="#00f" transform="translate(0,4)"/>
          </g>
          

          <path id="combocount" stroke-width="1" stroke="#fff" fill-opacity="0"/>
          <text id="combocounttext" x=550 y=90 fill="#fff" class="bigger" text-anchor="middle"/>

        </g>
      </g>

      <g filter="url(#f1)" id="map">
        <path d="M0 0 h640 v640 h-640 z" fill="#000"/>
        <path id="galaxy" filter="url(#f10)" fill="#fff1" d="M-20 355c0-160 125-310 300-310 135 0 245 95 245 230 0 85-65 175-165 175-90 0-135-55-135-125-15 0-25 25-25 50 0 65 80 135 170 135 120 0 250-110 250-275 0-100-50-190-90-240 50 45 130 130 130 270 0 160-125 310-295 310-135 0-245-95-245-230 0-85 65-175 165-175 90 0 135 55 135 125 15 0 25-25 25-50 0-65-80-135-170-135-120 0-250 110-250 275 0 100 50 190 90 240C55 580-20 495-20 355z"/>
        <g id="mapexit" transform="translate(0 0)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000"/>
          <text id="mapexittext"  x=10 y=25 fill="#fff" class="big">&lt; Cancel</text>
        </g>
      </g>

      <g id="title" filter="url(#f1)">
        <path fill="#000" d="M0 0h640v640H0"/>
        <text x=320 y=100 fill="#fff" class="bigger" text-anchor="middle">The Legend of Yeti-404</text>
        <text x=300 y=150 fill="#fff" class="big">#js13k 2020</text>
        <text x=320 y=550 fill="#fff" class="bigger" text-anchor="middle">A game by Richard Munn</text>

      </g>

      <g id="menu" filter="url(#f1)">
        <g id="menuitem0" transform="translate(0 80)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem0text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem1" transform="translate(0 110)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem1text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem2" transform="translate(0 140)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem2text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem3" transform="translate(0 170)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem3text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem4" transform="translate(0 200)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem4text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem5" transform="translate(0 230)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem5text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem6" transform="translate(0 260)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem6text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem7" transform="translate(0 290)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem7text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem8" transform="translate(0 320)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem8text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem9" transform="translate(0 350)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem9text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem10" transform="translate(0 380)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem10text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem11" transform="translate(0 410)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem11text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem12" transform="translate(0 440)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem12text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem13" transform="translate(0 470)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem13text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem14" transform="translate(0 500)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem14text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem15" transform="translate(0 530)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem15text" x=50 y=25 fill="#fff" class="big"/>
        </g>

        <g id="menuitem16" transform="translate(0 560)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="menuitem16text" x=50 y=25 fill="#fff" class="big"/>
        </g>
      </g>

      <text filter="url(#f1)" id="bottomtext" x=10 y=630 fill="#ff0" class="heavy"/>
   
      <path id="vsync" filter="url(#f10)" d="M-10 0 H650 V200 H-640 Z" fill="#303" fill-opacity="0.2" style="pointer-events:none"/>

      <g id="cursor" style="pointer-events:none">
        <path filter="url(#g)" d="M-5 0 h-30 m40 0 h30 m-35 5 v30 m0 -40 v-30" stroke-width="0.7" stroke="#fff" fill-opacity="0"/>
        <text filter="url(#f1)" id="cursorText1" x=8 y=20 fill="#ff0" class="heavy"/>
        <text filter="url(#f1)" id="cursorText2" x=8 y=40 fill="#ff0" class="heavy"/>
        <text filter="url(#f1)" id="cursorText3" x=8 y=60 fill="#ff0" class="heavy"/>
        <text filter="url(#f1)" id="cursorText4" x=8 y=80 fill="#ff0" class="heavy"/>
      </g>
      <g style="visibility:hidden">
        <path id="star" d="M-2 -2h2v2h-2z"/>
        <path id="box" d="M-10 -10h20v20h-20z" fill-opacity="0"/>
        <path id="enemybox" d="M0 0"/>
        <path id="mapcell" d="M0 0h12v12h-12z" fill-opacity="0"/>
        <path id="ground" d="M0 0" stroke-width="0.6" stroke="#fff" fill-opacity="0"/>
      </g>
    </g>
  </svg>

  <script>
    // adapted from https://gist.github.com/banksean/304522
    SN = function (t) { 
      null == t && (t = Math), 
      this.g3 = [[1, 1, 0], [-1, 1, 0], [1, -1, 0], [-1, -1, 0], [1, 0, 1], [-1, 0, 1], [1, 0, -1], [-1, 0, -1], [0, 1, 1], [0, -1, 1], [0, 1, -1], [0, -1, -1]], this.p = []; for (var r = 0; r < 256; r++)this.p[r] = Math.floor(256 * t.random()); this.m = []; for (r = 0; r < 512; r++)this.m[r] = this.p[255 & r] 
    }; 
    SN.prototype.n = function(t, r) { 
      var i, h, o = (t + r) * (.5 * (Math.sqrt(3) - 1)), s = Math.floor(t + o), e = Math.floor(r + o), p = (3 - Math.sqrt(3)) / 6, a = (s + e) * p, m = t - (s - a), n = r - (e - a); m > n ? (i = 1, h = 0) : (i = 0, h = 1); var d = m - i + p, f = n - h + p, l = m - 1 + 2 * p, u = n - 1 + 2 * p, M = 255 & s, g = 255 & e, v = this.m[M + this.m[g]] % 12, c = this.m[M + i + this.m[g + h]] % 12, x = this.m[M + 1 + this.m[g + 1]] % 12, N = .5 - m * m - n * n, S = .5 - d * d - f * f, q = .5 - l * l - u * u; return 70 * ((N < 0 ? 0 : (N *= N) * N * dot(this.g3[v], m, n)) + (S < 0 ? 0 : (S *= S) * S * dot(this.g3[c], d, f)) + (q < 0 ? 0 : (q *= q) * q * dot(this.g3[x], l, u))) 
    };
    sn = new SN();

    // adapted from https://stackoverflow.com/a/18473154
    function p2c(a,r,n,o){var t=(o-90)*Math.PI/180;return{x:a+n*Math.cos(t),y:r+n*Math.sin(t)}};
    function arc(a,r,n,o,t){var i=p2c(a,r,n,t),e=p2c(a,r,n,o),s=t-o<=180?"0":"1";return["M",i.x,i.y,"A",n,n,0,s,0,e.x,e.y].join(" ")};

    kr = decodeURI("%E2%93%9A");

    // adapted from https://www.dwitter.net/d/3078
    _critter_ = _ => {p="";f=m=>p+=`M${((i>>5&1)-X*m/7)} ${(j>>8)-4+Y}h1v1h-1v-1  `;for(j=30;j--;Math.random()>(X**2+(Y-4)**2)**.5/5&&f(7)+f(-7))X=j&3,Y=j>>2&7;return p};

    // decompose a critter into individual 'pixels'
    _decompose_ = o => {
      s = o.getAttribute("d").split("  ");
      for (i=0; i<s.length; ++i) {
        p=o.cloneNode();
        p.removeAttribute("id");
        p.setAttribute("d", s[i]);
        p.d = {x: o.d.x, ry: o.d.ry, r: o.d.r, s: o.d.s, z: o.d.z, dx: o.d.dx + Math.random()*6-3, dy: o.d.dy + Math.random()*6-3, a: 1, _temp_: true};
        p.d._update_ = (o, g) => {
          o.d.x += o.d.dx;
          o.d.ry += o.d.dy;
          o.d.y = 250 - o.d.ry + gh * (o.d.z * 2);
          o.d.a-=0.01;
          if (o.d.a<=0)  {
            o.d._dead_ = true
          };
          o.setAttribute("fill-opacity", o.d.a);
          _update_(o)
        };
        l12.appendChild(p);
        objects.push(p)
      }
    };

    _clamp_ = (i, n, x) => i < n ? n : i > x ? x : i;
    dot = (t, r, i) => t[0] * r + t[1] * i;
    _sqr_ = x => x * x;

    itemvalue = (item, f) => (item._war_*f._war_) + (item._trade_*f._trade_)+ (item._sci_*f._sci_);

    _addMenu_ = (text, i, d, f) => {
      if (i > 16) return;
      item = document.getElementById(`menuitem${i}`);
      _show_(item);
      itemtext = document.getElementById(`menuitem${i}text`);
      itemtext.textContent = text;
      item.d = d;
      _textwidget_(item, itemtext, f == null ? null : _ => {
        d = _.target.parentElement.d;
        f(d)
      })
    };

    _hideMenu_ = i => {
      if (i > 16) return;
      item = document.getElementById(`menuitem${i}`);
      _hide_(item)
    };

    _endMenu_ = i => {
      while(i < 17) {
        _hideMenu_(i++)
      }
    };

    _update_ = o => o.setAttribute("transform", "translate(" + o.d.x + " " + o.d.y + ") rotate(" + o.d.r + ") scale(" + o.d.z + ")");
    _show_ = o => o.removeAttribute("style");
    _hide_ = o => o.setAttribute("style", "visibility:hidden");
    text = o => bottomtext.textContent = o;
    clearcursor = _ => {
      cursorText1.textContent = "";
      cursorText2.textContent = "";
      cursorText3.textContent = "";
      cursorText4.textContent = ""
    };
    _showtitle_ = _ => { gameloop = false; _endMenu_(0); _hide_(game); _hide_(orbit); _hide_(map); _show_(title); _hide_(base); text() };
    _showmap_ = _ => { gameloop = false; _endMenu_(0); _hide_(game); _hide_(orbit); _show_(map); _hide_(title); _hide_(base); text() };
    _showgame_ = _ => { 
      gameloop = true; _endMenu_(0);_show_(game); _hide_(orbit); _hide_(map); _hide_(title); _hide_(base); text();

      combocount.d.v = 0; combocount.d.c = 0;
      maxlock = ship.d.weapons;

      f = _factionmap_[ship.d.my][ship.d.mx];
      waves = f._explored_? 0 : 1+f._war_ * f._war_;
      wavecount = 0;
      enemies = 0;
      missiles = 0;
      maxmissiles = 8;
      targetc = 0;
      maxlock = 4;
      wavetime = 100

      ///#if 0
      console.log("waves: "+waves);
      ///#endif
    };
    _entersystem_ = _ => {
      if (ship.d.scanner > 0) lrs(ship.d.mx, ship.d.my, ship.d.scanner+1);
      _showorbit_()
    };
    _showorbit_ = _ => { 
      gameloop = false; clearcursor(); _hide_(game); _show_(orbit); _hide_(map); _hide_(title); _hide_(base); text(); orbitcoords.textContent = `[${ship.d.mx},${ship.d.my}]`;
      f = _factionmap_[ship.d.my][ship.d.mx];
      f._visited_ = true;

      orbit_planet.setAttribute("cx", Math.random()*640);
      orbit_planet.setAttribute("cy", Math.random()*640);
      orbit_planet.setAttribute("r", f.pradius);
      orbit_planet.setAttribute("stroke", f.pcol);
      orbit_moon.setAttribute("cx", Math.random()*640);
      orbit_moon.setAttribute("cy", Math.random()*640);
      orbit_moon.setAttribute("r", f.mradius);
      orbit_moon.setAttribute("stroke", f.mcol);

      if (f._scanned_) {
        infofaction.textContent = factions[f.faction].name;

        infotrade.textContent = f._economy_;
        infopoi.textContent = f._explored_ ? places[f._place_].name : "???"

        ///#if 0
        console.log(`sci:${f._sci_} trade:${f._trade_} war:${f._war_} salvage:${f._salvage_}`);
        console.log(`Place: ${places[f._place_].name}`);
        console.log("Items:");
        for (i=0; i<f._items_.length; ++i) {
          item = _items_[f._items_[i]]
          console.log("+ "+item.name+ " value:"+itemvalue(item, f))
        }
        ///#endif

      } else {
        infofaction.textContent = "Unknown";
        infotrade.textContent = "Unknown";
        infopoi.textContent =  "Unknown"
      };
      _updatemap_(ship.d.mx, ship.d.my);

      next = 0;
      
      _addMenu_("> Galaxy Map", next++, {}, _ => _showmap_());
      _hideMenu_(next++);
      if (!f._scanned_) {
        _addMenu_("> Scan System", next++, {}, _ => { 
          _factionmap_[ship.d.my][ship.d.mx]._scanned_ = true; 
          _updatemap_(ship.d.mx, ship.d.my);
          _showorbit_() 
        });
        _hideMenu_(next++)
      };
      _addMenu_("> Enter Atmosphere", next++, {}, _ => /*_showtrade_());*/ _showgame_());
      _hideMenu_(next++);
      _addMenu_("> Ship status", next++, {}, _ => {
        next = 0;
        _addMenu_("< Exit", next++, {}, _ => _showorbit_());
        _hideMenu_(next++);
        _addMenu_(`Weapons: ${ship.d.weapons}`, next++);
        _addMenu_(`Shields: ${ship.d.shields}`, next++);
        _addMenu_(`Engines: ${ship.d.engines}`, next++);
        _addMenu_(`Scanner: ${ship.d.scanner}`, next++);
        _addMenu_(`Science: ${ship.d.science}`, next++);
        _endMenu_(next)
      });

      _hideMenu_(next++);

      skip = 0;
      for (var i=0; i<_inventory_.length; ++i) {
        if (_items_[_inventory_[i]].action != null) {
          skip ++;
          _addMenu_(`> Install ${_items_[_inventory_[i]].name}`, next++, {i: _inventory_[i]}, d => {
            _items_[d.i].action();
            _inventory_.splice(_inventory_.indexOf(d.i), 1);
            _showorbit_()
          });
          if (skip==3) break
        }
      };

      if (skip>0) _hideMenu_(next++);

      if (research != null) {
        if (researchtime > 0) {
          j = _clamp_(Math.floor(researchtime/500), 1, 20);
          _addMenu_(`Researching ${_items_[research].name} ${"#".repeat(j)}`, next++)
        } else {
          _addMenu_("> Research complete!", next++, {}, _ => {
            next = 0;
            _addMenu_("< Exit", next++, {}, _ => _showorbit_());
            _hideMenu_(next++);

            w = _clamp_(25 - _items_[research]._research_ - ship.d.science, 4, 20);

            k = _getWeighted_(_items_, w);

            if (k == null) {
              _addMenu_("Discovered nothing of value", next++)
            } else {
              _addMenu_(`Discovered ${_items_[k].name}`, next++);
              _inventory_.push(k)
            };

            _endMenu_(next);
            research = null
          })
        }
      } else {
        i=0;
        seen = [];
        for (j=0; j<_inventory_.length; ++j) {
          if (_items_[_inventory_[j]]._research_ <= ship.d.science && !seen.includes(_inventory_[j])) {
            _addMenu_ (`> Research ${_items_[_inventory_[j]].name}`, next++, {i: _inventory_[j]}, d => {
              research = d.i;
              _inventory_.splice(_inventory_.indexOf(d.i), 1);
              researchtime = _items_[d.i]._research_ * 1000;
              _showorbit_()
            });
            i++;
            seen.push(_inventory_[j]);
            if (i==3) break
          }
        }
      };

      _endMenu_(next)

    };
    _showwarp_ = _ => _entersystem_();

    _showtrade_ = _ => { 
      gameloop = false; clearcursor(); _hide_(game); _hide_(orbit); _hide_(map); _hide_(title); _show_(base); text();

      f = _factionmap_[ship.d.my][ship.d.mx];
      f._explored_ = true;
      next = 0;

      base_planet.setAttribute("rx", f.pradius * 5);
      base_planet.setAttribute("stroke", f.pcol);
      base_moon.setAttribute("cx", Math.random()*640);
      base_moon.setAttribute("cy", Math.random()*340);
      base_moon.setAttribute("r", f.mradius*2);
      base_moon.setAttribute("stroke", f.mcol);

      base_sc1.setAttribute("transform", `translate(${-5 -(Math.random()*315)} 300)`); // tower
      base_sc2.setAttribute("transform", `translate(${-5 -(Math.random()*315)} 300)`); // skyline1
      base_sc3.setAttribute("transform", `translate(${-5 -(Math.random()*315)} 300)`); // skyline2
      base_sc4.setAttribute("transform", `translate(${-5 -(Math.random()*315)} 300)`); // hut

      _hide_(base_sc1);_hide_(base_sc2);_hide_(base_sc3);_hide_(base_sc4);

      if (f._trade_ >=1 ) _show_(base_sc4);
      if (f._trade_ >=3 ) _show_(base_sc2);
      if (f._trade_ >=5 ) _show_(base_sc3);
      if (f._trade_ >=8 ) _show_(base_sc1);

      tradename.textContent = places[f._place_].name;

      _inventory_.sort((a, b) => itemvalue(_items_[b], f) - itemvalue(_items_[a], f));

      text(`kredits: ${kr} ${kredits}   fuel: ${fuel}/${maxfuel}`);

      _addMenu_("< Return to orbit", next++, {}, _ => _showorbit_());
      _hideMenu_(next++);

      if (f._trade_ == 0) {
        _addMenu_("Search for scrap", next++, {}, _ => {

          next = 2;

          for (i=0; i<f._items_.length; ++i) {
            _addMenu_(`Found ${_items_[f._items_[i]].name}!`, next++);
            _inventory_.push(f._items_[i])
          };

          f._items_ = []

        });

        _hideMenu_(next++)

      } else {

        if (fuel < maxfuel) {
          fuelcost = 10;
          _addMenu_(`> Buy fuel : ${kr} ${fuelcost}`, next++, {v: fuelcost}, d => {
            if (kredits >= d.v) {
              kredits -= d.v;
              fuel++;
              _showtrade_()
            }
          })
        };

        for (i=0; i<f._items_.length; ++i) {
          v = itemvalue(_items_[f._items_[i]], f);
          _addMenu_(`> Buy ${_items_[f._items_[i]].name} : ${kr} ${v}`, next++, {i: f._items_[i], v: v}, d => {
            if (kredits >= d.v) {
              _inventory_.push(d.i);
              kredits -= d.v;
              f._items_.splice(f._items_.indexOf(d.i), 1);
              _showtrade_()
            }
          })
        };

        if (f._items_.length > 0) _hideMenu_(next++);

        for (i=0; i<_inventory_.length; ++i) {
          v = Math.round(itemvalue(_items_[_inventory_[i]], f) * 0.8);
          _addMenu_(`> Sell ${_items_[_inventory_[i]].name} : ${kr} ${v}`, next++, {i: _inventory_[i], v: v}, d => {
            kredits += d.v;
            _inventory_.splice(_inventory_.indexOf(d.i), 1);
            _showtrade_()
          })
        }
      };

      _endMenu_(next)

    };

    cols = ["#f00", "#f70", "#ff0", "#7f0", "#0f0", "#0f7", "#0ff", "#07f", "#00f", "#70f", "#f0f", "#f07"];
    factionCol = ["#333", "#f0f", "#ff0", "#05f"];
    factions = [
      {name:"Unclaimed sector",    _sci_:1, _trade_:1, _war_:1},
      {name:"Trade Federation",    _sci_:3, _trade_:6, _war_:1},
      {name:"Union of Science",    _sci_:5, _trade_:4, _war_:1},
      {name:"The Empire",          _sci_:1, _trade_:3, _war_:6}
    ];

    _items_ = [

      {w:1,   name:"Weapons upgrade",        _sci_:4, _trade_:4, _war_:8, action: _ => { ship.d.weapons++ }},
      {w:2,   name:"Shields upgrade",        _sci_:6, _trade_:4, _war_:6, action: _ => { ship.d.shields++ }},
      {w:3,   name:"Science upgrade",        _sci_:8, _trade_:4, _war_:4, action: _ => { ship.d.science++ }},
      {w:4,   name:"Engines upgrade",        _sci_:5, _trade_:6, _war_:5, action: _ => { ship.d.engines++ }},
      {w:5,   name:"Scanner upgrade",        _sci_:8, _trade_:4, _war_:4, action: _ => { ship.d.engines++ }},

      {w:30,  name:"Assorted junk",          _sci_:1, _trade_:1, _war_:1, _research_:1},
      {w:40,  name:"Salvage",                _sci_:2, _trade_:2, _war_:1, _research_:2},
      {w:45,  name:"Strange foodstuffs",     _sci_:1, _trade_:2, _war_:1},
      {w:60,  name:"Mysterious boxes",       _sci_:6, _trade_:3, _war_:1, _research_:3},
      {w:63,  name:"Odd trinkets",           _sci_:1, _trade_:4, _war_:1},
      {w:65,  name:"Small furry creatures",  _sci_:5, _trade_:7, _war_:1},
      {w:68,  name:"Lab grown meat",         _sci_:3, _trade_:2, _war_:4},
      {w:72,  name:"Service robots",         _sci_:5, _trade_:4, _war_:2},
      {w:75,  name:"Entertainment devices",  _sci_:2, _trade_:6, _war_:2},
      {w:78,  name:"Medical supplies",       _sci_:4, _trade_:6, _war_:6},
      {w:80,  name:"Exotic weapons",         _sci_:4, _trade_:6, _war_:9, _research_:6},

      {w:90,  name:"Luxury goods",           _sci_:4, _trade_:8, _war_:5},
      {w:100, name:"Advanced technology",    _sci_:7, _trade_:9, _war_:8, _research_:10}

      
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0}
    ];

    places = [      
      {w:50,  name:"Trading Post", _trade_:1, _salvage_: 0, _sci_:1},
      {w:70,  name:"Abandoned colony", _trade_:0, _salvage_: 2, _sci_:1},
      {w:80,  name:"Small colony", _trade_:2, _salvage_: 0,_sci_:1},
      {w:89,  name:"Crashsite", _trade_:0, _salvage_: 3, _sci_:1},
      {w:95,  name:"Medium colony", _trade_:3, _salvage_: 0,_sci_:1},
      {w:98,  name:"Ancient Ruins", _trade_:0, _salvage_: 5, _sci_:1},
      {w:100, name:"Large colony", _trade_:4, _salvage_: 0,_sci_:1}
    ];

    _getWeighted_ = (i,x) => {
      r = Math.random() * (x==null ? 100 : x);
      for (j=0; j<i.length; ++j) {
        if (i[j].w>r) return j
      };
      return null
    };

    targets = []; shipcell = null;

    objects = []; fxobjects = []; _inventory_ = [];

    mousedown = false;

    kredits = 25;
    shields = 100;
    shieldhit = 0;
    research = null;
    researchtime = 0;
    fuel = 25;
    maxfuel = 50;
    warprange = 5;
    warpdistance = 0;

    _calcfuel_ = d => _sqr_(Math.abs(d.x - ship.d.mx)) + _sqr_(Math.abs(d.y - ship.d.my));
    _calcdistance_ = (x,y) => Math.sqrt((x-ship.d.mx)*(x-ship.d.mx)+(y-ship.d.my)*(y-ship.d.my));

    music = null;    

    title.onclick = _ => {
      // music = zzfxP(..._songdata_);        // Play the song
      _entersystem_()
    };

    _endMenu_(0);

    ship.d = { r: 0, x: 320, y: 550, z: 10, mx: 10 + Math.floor(Math.random() * 12), my: 10 + Math.floor(Math.random() * 12),
      weapons: 2 + Math.floor(Math.random()*3),
      shields: 1 + Math.floor(Math.random()*1),
      science: 1 + Math.floor(Math.random()*3),
      engines: 1 + Math.floor(Math.random()*3),
      scanner: 0 + Math.floor(Math.random()*3)
     };
    ship.d._update_ = (o, g) => {
      o.d.x = (o.d.x * 0.8 + (320 + (mx * 320)) * 0.2);
      o.d.y = (o.d.y * 0.8 + (400 + (my * 100)) * 0.2);
      gh = 27.5 - (my * 12.5);
      gx -= ((o.d.x - 320) / 3000);
      shipd.setAttribute("d", `M${(320 - o.d.x) / 100} ${(o.d.y - 400) / 50} L-5 4 L0 8 L5 4 Z M-5 4 L0 1 L5 4`);
      if (shieldhit>0 || shields <= 10) {
        _show_(ships);
        if (shields >= 10) {
          ships.setAttribute("stroke", "#00f");
          ships.setAttribute("fill", "#00f")
        } else {
          ships.setAttribute("stroke", "#f00");
          ships.setAttribute("fill", "#f00")
        };
        shieldhit--
      } else {
        _hide_(ships)
      };
      _update_(o)
    };
    objects.push(ship);
    _update_(ship);

    combocount.d = { v:0, c:0 };
    combocount.d._update_ = (o,g) => {
      if (o.d.v <= 0) {
        combocount.setAttribute("d", "");
        combocounttext.textContent = "";
        o.d.c = 0
      } else {
        combocount.setAttribute("d", arc(550, 80, 40, 360-o.d.v, 359.9));
        combocounttext.textContent = `x${o.d.c}`
      };
      o.d.v-= ((targetc+missiles == 0) ? 5 : 0.5) // combo counter drops faster when no lock or missiles
    };
    objects.push(combocount);

    _factionmap_ = [];

    for (y = 0; y < 32; ++y) {
      _factionmap_[y] = [];
      for (x = 0; x < 32; ++x) {
        dist=_calcdistance_(x,y);
        f = {
          faction:0, _visited_: false, _explored_: false, _scanned_: dist<5, 
          _place_: _getWeighted_(places),
          _items_: [],
          pradius: 100+Math.random()*300,
          pcol: cols[Math.floor(Math.random()*cols.length)],    
          mradius: 10+Math.random()*100,
          mcol: cols[Math.floor(Math.random()*cols.length)],
          lsx: 0.5 + Math.random(),
          lsy: 0.5 + Math.random()
        };

        f._sci_ = Math.floor(Math.random()*3 * factions[f.faction]._sci_ * places[f._place_]._sci_);
        f._trade_ = Math.round((1+Math.random()*2) * factions[f.faction]._trade_ * places[f._place_]._trade_);
        f._war_ = Math.floor(Math.random()*3* factions[f.faction]._war_);
        f._salvage_ = Math.round(Math.random()*3 * factions[f.faction]._trade_ * places[f._place_]._salvage_);

        if (f._sci_ == f._trade_ && f._sci_ == f._war_) {
          f._economy_ = "Balanced"
        } else if (f._sci_ == f._trade_ && f._sci_ > f._war_) {
          f._economy_ = "Technology"
        } else if (f._sci_ > f._trade_ && f._sci_ > f._war_) {
          f._economy_ = "Science"
        } else if (f._trade_ > f._sci_ && f._trade_ > f._war_) {
          f._economy_ = "Trade"
        } else if (f._trade_ > f._sci_ && f._trade_ == f._war_) {
          f._economy_ = "Arms"
        } else if (f._war_ > f._trade_ && f._war_ > f._sci_) {
          f._economy_ = "Warfare"
        } else if (f._sci_ == f._war_ && f._war_ > f._trade_) {
          f._economy_ = "Espionage"
        };

        combo = f._sci_ + f._trade_ + f._war_;

        if (combo < 5) {
          f._economy_ += " (D)"
        } else if (combo < 8) {
          f._economy_ += " (C)"
        } else if (combo < 13) {
          f._economy_ += " (B)"
        } else {
          f._economy_ += " (A)"
        };

        ///#if 0
        if (combo >= 10)
        console.log(`${x},${y} ${f._economy_} ${combo}`)
        ///#endif

        for (i=0; i< Math.min(1+(f._trade_+f._salvage_),8); ++i) {
          f._items_.push(_getWeighted_(_items_))
        };

        _factionmap_[y][x] = f
      }
    };

    x = 10 + Math.floor(Math.random() * 22);
    y = 10 + Math.floor(Math.random() * 22);

    for (i = 1; i < 4; ++i) {
      factionSize = 50 + Math.floor(Math.random() * 250);
      while (_factionmap_[y][x].faction != 0) {
        x = 10 + Math.floor(Math.random() * 22);
        y = 10 + Math.floor(Math.random() * 22)
      };
      _factionmap_[y][x].faction = i;

      seeds = [];

      seeds.push([x,y]);

      j = 0;
      fail = 0;
      while (j < factionSize && fail < 500) {

        v = seeds[Math.floor(Math.random() * seeds.length)];

        x = _clamp_( v[0] - 5 + Math.floor(Math.random() * 10), 0, 31);
        y = _clamp_( v[1] - 5 + Math.floor(Math.random() * 10), 0, 31);

        if (_factionmap_[y][x].faction == 0) {
          _factionmap_[y][x].faction = i;
          seeds.push([x,y]);
          ++j
        } else {
          fail++
        }
      }
    };

    _textwidget_ = (e, t, f) => {
      if (f) {
        e.onmouseenter = _ => t.setAttribute("fill", "#990");
        e.onmouseleave = _ => t.setAttribute("fill", "#fff");
        e.onclick = _ => f(_)
      } else {
        t.setAttribute("fill", "#fff");
        e.onmouseenter = null;
        e.onmouseleave = null;
        e.onclick = null
      }
    };

    _textwidget_(mapexit, mapexittext, _ => _showorbit_() );

    _updatemap_ = (x,y) => {
      if (_factionmap_[y][x]._scanned_) {
        _factionmap_[y][x].mapcell.setAttribute("fill", factionCol[_factionmap_[y][x].faction]);
        _factionmap_[y][x].mapcell.setAttribute("fill-opacity", _factionmap_[y][x]._visited_ ? "0.9" : "0.4")
      }
    };

    lrs = (x,y,r) => {
      for (y1=_clamp_(y-r,0,32); y1<_clamp_(y+r,0,32); ++y1) {
        for (x1=_clamp_(x-r,0,32); x1<_clamp_(x+r,0,32); ++x1) {
          if (Math.sqrt(_sqr_(x-x1)+_sqr_(y-y1))<=r) { 
            _factionmap_[y1][x1]._scanned_=true;
            _updatemap_(x1,y1) 
          }
        }
      }
    };

    // build map
    for (y = 0; y < 32; ++y) {
      for (x = 0; x < 32; ++x) {
        o = mapcell.cloneNode();
        o.d = { x: x, y: y };

        if (x == ship.d.mx && y == ship.d.my) {
          o.setAttribute("stroke", "#ff0");
          shipcell = o
        } else {
          o.setAttribute("stroke", _factionmap_[y][x]._scanned_ ? "#fff5" : "#000")
        };

        _factionmap_[y][x].mapcell = o;
        
        _updatemap_(x,y);

        o.removeAttribute("id");
        o.setAttribute("transform", "translate(" + ((x * 16) +40) + " " + ((y * 16) + 34) + ")");
        o.onmouseenter = _ => {
          d = _.target.d;
          f = _factionmap_[d.y][d.x];
          fuelneed = _calcfuel_(d);
          text("Warp requires " + fuelneed + "mgb.  Fuel available: " + fuel + "mgb");
          if (fuelneed <= fuel) {
            _.target.setAttribute("stroke", "#fff")
          } else {
            _.target.setAttribute("stroke", "#f00")
          };

          cursorText1.textContent = `[${d.x},${d.y}]`;
          cursorText2.textContent = f._scanned_ ? factions[f.faction].name : "";
          cursorText3.textContent = f._scanned_ ? f._economy_ : "";
          cursorText4.textContent = f._explored_ ? places[f._place_].name : ""

        };
        o.onmouseleave = _ => {
          if (_.target.d.x == ship.d.mx && _.target.d.y == ship.d.my) {
            _.target.setAttribute("stroke", "#ff0")
          } else {
            _.target.setAttribute("stroke", _factionmap_[_.target.d.y][_.target.d.x]._scanned_ ? "#fff5" : "#000")
          }
        };
        o.onclick = _ => {
          fuelneed = _calcfuel_(_.target.d);
          if (fuelneed <= fuel) {
            fuel -= fuelneed;
            warpdistance = fuelneed * 100;
            ship.d.mx = _.target.d.x;
            ship.d.my = _.target.d.y;
            _.target.setAttribute("stroke", "#ff0");
            shipcell.setAttribute("stroke", "#fff2");
            shipcell = _.target;
            _showwarp_()
          }
        };

        map.appendChild(o)
      }
    };

    // // build stars
    // for(i=0; i<200; ++i) {
    //   o=star.cloneNode();
    //   o.setAttribute("fill", cols[i%cols.length]);
    //   o.removeAttribute("id");
    //   o.d = { r: Math.random(), x: 300 + (Math.random() * 40), y: 300 + (Math.random() * 40), z: 0.1 };

    //   o.d._update_ = (o,g)=> {
    //     m = 1.1 + ((Math.abs(o.d.x - 320)) / 500);
    //     o.d.z += m / 10;
    //     o.d.r += 1;
    //     o.d.x = ((o.d.x - 320) * m) + 320;
    //     o.d.y = ((o.d.y - 320) * m) + 320;
    //     if (o.d.x < 0 || o.d.x > 640 || o.d.y < 0 || o.d.y > 640) {
    //       o.d.x = 305 + (Math.random() * 30);
    //       o.d.y = 305 + (Math.random() * 30);
    //       o.d.z = 0.5
    //     };
    //     _update_(o)
    //   };

    //   objects.push(o);
    //   l0.insertBefore(o, l0.firstChild)
    // };

    // target boxes
    for (i = 0; i < 8; ++i) {
      o = box.cloneNode();
      o.setAttribute("stroke", "#fff");
      o.setAttribute("stroke-width", "0.3");
      o.removeAttribute("id");
      o.d = { r: 90, x: -200, y: -200, z: 1, t: null };
      o.d._update_ = (o, g) => {
        if (mousedown || missiletime > 0) {
          if (o.d.t) {
            o.d.x = o.d.t.x;
            o.d.y = o.d.t.y;
            o.d.r = o.d.r * 0.75;
            o.d.z = (4 + o.d.z) / 2
          }
        } else {
          if (o.d.t != null) {
            if (maxmissiles - missiles > 0) {
              if (missiletime == 0) {
                m = firemissile();

                m.d.x = ship.d.x;
                m.d.y = ship.d.y;
                m.d.t = o.d.t;
                m.d.to = o.d.to;

                o.d.t = null;
                o.d.x = -100;
                o.d.y = -100;
                targets.push(o)
              }
            }
          }
        };
        _update_(o)
      };
      targets.push(o);
      _update_(o);
      l11.appendChild(o)
    };

    firemissile = _ => {
      missiles++;

      o = box.cloneNode();
      o.setAttribute("stroke", "#fff");
      o.setAttribute("stroke-width", "2");
      o.removeAttribute("id");
      o.d = { r: 0, x: -200, y: -200, z: 1, t: null, f:0, _temp_:true };
      o.d._update_ = (o, g) => {
        if (o.d.t && !o.d.t._dead_) {
          o.d.x = (o.d.x * 0.85) + (o.d.t.x * 0.15);
          o.d.y = (o.d.y * 0.85) + (o.d.t.y * 0.15);
          o.d.z = o.d.z * 0.95;
          o.d.f++;

          if (o.d.z < 0.001) {
            o.d._dead_ = true
          };

          if (o.d.f > 20 && (Math.abs(o.d.x - o.d.t.x) + Math.abs(o.d.y - o.d.t.y)) < 50) {
            _explosion_();
            o.d._dead_ = true;
            o.d.t._dead_ = true;
            _decompose_(o.d.to);

            if (combocount.d.v > 0) {
              combocount.d.c ++
            } else {
              combocount.d.c = 1
            };

            combocount.d.v = 360;

            enemies--;
            missiles--
          };

          _update_(o)
        }
      };

      _update_(o);
      l11.appendChild(o);

      objects.push(o);
      _shoot_();

      missiletime = 4;

      return o
    };

    _doTarget_ = _ => {
      if (mousedown) {
        if (targets.length > 0 && targetc < maxlock) {
          t = targets.pop();
          t.d.t = _.target.d;
          t.d.to = _.target;
          t.d.z = 1000;
          t.d.r = 90;
          objects.push(t);
          _lock_(700 + (50 * targetc));
          _.target.onmouseenter = null;
          targetc++;
          cursorText1.textContent = `Lock: ${targetc} / ${maxlock}`
        }
      }
    };

    enemywave1 = _ => {
      // circling critters
      _wave1_();
      s = 0.1;
      wavecount++;

      r = Math.floor(Math.random()*10);

      for (i = 0; i < wavecount*2; ++i) { 
        o = enemybox.cloneNode();
        o.removeAttribute("id");
        
        o.setAttribute("d", _critter_());
        o.setAttribute("fill",cols[(i+r) % cols.length]);

        o.onmouseenter = _doTarget_;

        o.d = { r: 0, x: Math.random() * 640, ry: Math.random() * 640, s: s += 0.0005, z: 0.1, dx:0, dy:0, _temp_:true };

        o.d._update_ = (o, g) => {
          o.d.dx = o.d.x;
          o.d.dy = o.d.ry;
          
          o.d.x = (o.d.x * (1 - o.d.s)) + (g.x * o.d.s);
          o.d.ry = (o.d.ry * (1 - o.d.s)) + (g.y * o.d.s);

          o.d.dx = o.d.x - o.d.dx;
          o.d.dy = o.d.ry - o.d.dy;

          o.d.z = (o.d.z * 0.95) + (5.0 + Math.sin(n - (o.d.s * 500))) * 0.05;

          if (Math.random() * 1000 < wavecount*10) {
            zap = ground.cloneNode();
            zap.removeAttribute("id");
            zap.setAttribute("filter","url(#g)");
            p="M0 0";
            for (k=1; k<65; k++) {
              p+= ` L${(Math.random()*k*2)-k} ${k*10}`
            };
            zap.setAttribute("d", p);
            zap.d = {x: o.d.x, y: o.d.y, r:0, s:1, z:1, _dead_: true, _temp_: true};
            zap.d._update_ = _ => {};
            objects.push(zap);
            _update_(zap);
            l12.appendChild(zap);
            
            if (Math.abs(o.d.x - ship.d.x) < 25) { 
              shields--;
              shieldhit += 5;
              _shields_()
            } else {
              _zap_()
            }
          };

          if (!o.d._dead_) {
            o.d.y = 250 - o.d.ry + gh * (o.d.z * 2);
            g.x = o.d.x;
            g.y = o.d.ry
          } else {
            o.d.y = -100
          };
          _update_(o)
        };

        objects.push(o);
        enemies++;
        l12.appendChild(o)
      }
    };


    // landscape
    slices = 20;
    div = 10;
    for (i = 0; i < slices; ++i) {
      o = ground.cloneNode();
      o.removeAttribute("id");
      o.d = { i: i + 2 };
      o.d._update_ = (o, g) => {
        s = "";
        for (x = 0; x <= 64; ++x) {
          rx = ((32 - x) * ((slices + 1 - o.d.i) / 10)) / div;

          hz = sn.n((g.gx + rx)*g.f.lsx, ((o.d.i + g.gy) / div)*g.f.lsy);
          sq = o.d.i * o.d.i;
          s += x == 0 ? "M" : "L";
          s += `${x * 10} ${(100 - (gh * 3)) + ((gh / slices) * sq) + (hz * sq / 2)}`
        };
        o.setAttribute("d", s);
        o.setAttribute("stroke", _factionmap_[ship.d.my][ship.d.mx].pcol);
        l10.appendChild(o)
      };
      objects.push(o)
    };

    missiletime = 0;
    gameloop = false;
    warpdistance = 10000;

    focus = true;
    window.onfocus = _ => focus = true;
    window.onblur = _ => focus = false;
    n = 0;

    cursor.d = { r: 0, x: 320, y: 320, z: 1 };
    cursor.d._update_ = (o, g) => {
      o.d.x = 320 + (mx * 320);
      o.d.y = 320 + (my * 320);
      _update_(o)
    };
    fxobjects.push(cursor);
    _update_(cursor);

    vsync.d = { r: 0, x: 0, y: 0, z: 1 };
    vsync.d._update_ = (o, g) => {
      o.d.y += 16;
      if (o.d.y > 640) o.d.y = -200;
      _update_(o)
    };
    fxobjects.push(vsync);

    _showtitle_();
    //_showmap_();
    //_showgame_();
    //_showorbit_();
    //_showtrade_();

    c.onmousedown = _ => {
      focus = true;
      mousedown = gameloop
    };
    c.onmouseup = _ => {
      if (gameloop) {
        mousedown = false;
        missiletime = 0;
        targetc = 0;
        clearcursor()
      }
    };

    mx = 0;
    my = 0;
    rect = c.getBoundingClientRect();

    window.onresize = _ => rect = c.getBoundingClientRect();

    c.onmousemove = _ => {
      size = Math.min(rect.width, rect.height) / 2;
      mx = _clamp_(((_.clientX - rect.left) - (rect.width / 2)) / size, -1, 1);
      my = _clamp_(((_.clientY - rect.top) - (rect.height / 2)) / size, -1, 1)
    };

    gx = 100;
    gy = 0;
    gh = 10;

    cleartemp = _ => {
      x = objects.length;
      objects2 = objects;
      objects = [];

      objects2.forEach(o => {
        if (o.d._temp_) {
          o.remove() 
        } else {
          objects.push(o)
        }
      })
      ///#if 0
      console.log(`${x-objects.length} objects culled`)
      ///#endif
    };

    // Game loop
    setInterval(_ => {
      if (!focus) return;

      fxobjects.forEach(o => {
        o.d._update_(o, g)
      });

      if (shields < 100) shields = _clamp_(shields+(ship.d.shields/100), 0, 100);

      if (researchtime > 0) researchtime--;

      if (!gameloop) return;

      //if (warpdistance <= 0) _showmap_();

      n += 0.025;
      //warpdistance -= 1;
      gy -= 1;
      if (missiletime > 0) missiletime--;

      g = {
        x: 320 + (Math.sin(n) * 150),
        y: 200 + (Math.cos(n) * 150),
        f: _factionmap_[ship.d.my][ship.d.mx],
        gy: gy,
        gx: gx,
        gh: gh
      };

      objects2 = objects;
      objects = [];

      objects2.forEach(o => {
        o.d._update_(o, g);
        if (o.d._dead_) {
          o.remove() 
        } else {
          objects.push(o)
        }
      });

      //console.log(objects.length);

      if (enemies == 0) {
        wavetime--;
        if (wavetime == 0) {
          if (waves==0) {
            cleartemp();
            _showtrade_();
            return
          } else {
            waves--;
            wavetime = 25;
            enemywave1()
          }
        }
      };

      if (shields > 0) {
        text(`shields: ${shields.toFixed(0)}%`)
      } else {
        text("G A M E O V E R");
        ship.d._dead_=true;
        _gameover_();
        shields = 0
        //focus = false
      }


    }, 50);


    // zzfx() - the universal entry point -- returns a AudioBufferSourceNode
    zzfx=(...t)=>zzfxP(zzfxG(...t));
    zzfxP=(...t)=>{let e=zzfxX.createBufferSource(),f=zzfxX.createBuffer(t.length,t[0].length,zzfxR);t.map((d,i)=>f.getChannelData(i).set(d)),e.buffer=f,e.connect(zzfxX.destination),e.start();return e};
    zzfxG=(q=1,k=.05,c=220,e=0,t=0,u=.1,r=0,F=1,v=0,z=0,w=0,A=0,l=0,B=0,x=0,G=0,d=0,y=1,m=0,C=0)=>{let b=2*Math.PI,H=v*=500*b/zzfxR**2,I=(0<x?1:-1)*b/4,D=c*=(1+2*k*Math.random()-k)*b/zzfxR,Z=[],g=0,E=0,a=0,n=1,J=0,K=0,f=0,p,h;e=99+zzfxR*e;m*=zzfxR;t*=zzfxR;u*=zzfxR;d*=zzfxR;z*=500*b/zzfxR**3;x*=b/zzfxR;w*=b/zzfxR;A*=zzfxR;l=zzfxR*l|0;for(h=e+m+t+u+d|0;a<h;Z[a++]=f)++K%(100*G|0)||(f=r?1<r?2<r?3<r?Math.sin((g%b)**3):Math.max(Math.min(Math.tan(g),1),-1):1-(2*g/b%2+2)%2:1-4*Math.abs(Math.round(g/b)-g/b):Math.sin(g),f=(l?1-C+C*Math.sin(2*Math.PI*a/l):1)*(0<f?1:-1)*Math.abs(f)**F*q*zzfxV*(a<e?a/e:a<e+m?1-(a-e)/m*(1-y):a<e+m+t?y:a<h-d?(h-a-d)/u*y:0),f=d?f/2+(d>a?0:(a<h-d?1:(h-a)/d)*Z[a-d|0]/2):f),p=(c+=v+=z)*Math.sin(E*x-I),g+=p-p*B*(1-1E9*(Math.sin(a)+1)%2),E+=p-p*B*(1-1E9*(Math.sin(a)**2+1)%2),n&&++n>A&&(c+=w,D+=w,n=0),!l||++J%l||(c=D,v=H,n=n||1);return Z};
    zzfxV=.3;zzfxR=44100;zzfxX=new(top.AudioContext);

    //! ZzFXM (v2.0.3) | (C) Keith Clark | MIT | https://github.com/keithclark/ZzFXM
    zzfxM=(n,f,t,e=125)=>{let l,o,z,r,g,h,x,a,u,c,d,i,m,p,G,M=0,R=[],b=[],j=[],k=0,q=0,s=1,v={},w=zzfxR/e*60>>2;for(;s;k++)R=[s=a=d=m=0],t.map((e,d)=>{for(x=f[e][k]||[0,0,0],s|=!!f[e][k],G=m+(f[e][0].length-2-!a)*w,p=d==t.length-1,o=2,r=m;o<x.length+p;a=++o){for(g=x[o],u=o==x.length+p-1&&p||c!=(x[0]||0)|g|0,z=0;z<w&&a;z++>w-99&&u?i+=(i<1)/99:0)h=(1-i)*R[M++]/2||0,b[r]=(b[r]||0)-h*q+h,j[r]=(j[r++]||0)+h*q+h;g&&(i=g%1,q=x[1]||0,(g|=0)&&(R=v[[c=x[M=0]||0,g]]=v[[c,g]]||(l=[...n[c]],l[2]*=2**((g-12)/12),g>0?zzfxG(...l):[])))}m=G});return[b,j]};

    // http://aminet.net/package/mods/pro/somewhere
    _songdata_ = zzfxM(...[[[.7,0,22,,.07,.07,2,0,,,.5,.01],[.5,0,196,,2,.5,3],[,0,655,,,.09,3,1.65,,,,,.02,3.8,-.1,,.2],[,0,84,,,,,.7,,,,.5,,6.7,1,.05],[3,0,43,,,.25,,,,,,,,2],[.75,0,196,,.08,.18,3]],[[[1,1,8,,,,,,,,,,,,8,,,,,,,,,,,,8,,,,,,,,6,,,,,,,,,,,6,,,,,,,,,,,,,6,,,,,,,,],[,-1,15,,,,13,,15,,,,13,,15,,18,,,,18,,,,18,,17,,15,,13,,15,,15,,,,13,,15,,,,13,,15,,18,,,,18,,,,18,,17,,15,,13,,15,,],[3,1,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,],[4,1,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,,,],[2,1,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,18,18,18]],[[5,-1,20,,20.5,,15.75,,20.75,,20,,20.5,,20,,15,,20.5,,15.75,,20.75,,15,,18,,20,,20.5,,18,,18.5,,22.75,,18.75,,18,,17,,15,,20.75,,18,,18.5,,22.75,,18.75,,22.75,,18.75,,22.92,,18.92,,22.92,,],[1,1,8,,,,,,,,,,,,8,,,,,,,,,,,,8,,,,,,,,6,,,,,,,,,,,6,,,,,,,,,,,,,6,,,,,,,,],[,-1,15,,,,13,,15,,,,13,,15,,18,,,,18,,,,18,,17,,15,,13,,15,,15,,,,13,,15,,,,13,,15,,18,,,,18,,,,18,,17,,15,,13,,15,,],[3,1,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,],[4,1,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,,,],[2,1,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,18,18,18]],[[5,-1,15,,10.5,,13,,15,,10.5,,13,,15,,18,,13.5,,18,,13.5,,18,,17,,15,,13,,15,,15,,10.5,,13,,15,,10.5,,13,,15,,18,,13.5,,18,,13.5,,18,,17,,15,,13,,15,,],[1,1,8,,,,,,,,,,,,8,,,,,,,,,,,,8,,,,,,,,6,,,,,,,,,,,6,,,,,,,,,,,,,6,,,,,,,,],[,-1,15,,,,13,,15,,,,13,,15,,18,,,,18,,,,18,,17,,15,,13,,15,,15,,,,13,,15,,,,13,,15,,18,,,,18,,,,18,,17,,15,,13,,15,,],[3,1,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,],[4,1,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,,,],[2,1,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,18,18,18]],[[5,-1,10,,8.5,,10.75,,8.75,,10.75,,8.75,,10.75,,8.75,,10.75,,8.75,,10.75,,8.75,,10.75,,8.75,,10.75,,8.75,,8,,6.5,,8.75,,6.75,,8.75,,6.75,,8.75,,6.75,,8.75,,6.75,,8.75,,6.75,,8.75,,6.75,,8.75,,6.75,,],[1,1,8,,,,,,,,,,,,8,,,,,,,,,,,,8,,,,,,,,6,,,,,,,,,,,6,,,,,,,,,,,,,6,,,,,,,,],[,-1,15,,,,13,,15,,,,13,,15,,18,,,,18,,,,18,,17,,15,,13,,15,,15,,,,13,,15,,,,13,,15,,18,,,,18,,,,18,,17,,15,,13,,15,,],[3,1,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,],[4,1,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,,,],[2,1,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,18,18,18]],[],[[5,-1,20,,15.5,,20.5,,15.75,,20.75,,15.75,,20.75,,15.75,,20.75,,15.75,,20.75,,15.75,,18,,18.75,,17,,17.75,,15,,10.5,,15.75,,10.75,,15.75,,10.75,,15.75,,10.75,,15.75,,10.75,,15.75,,10.75,,15.92,,10.92,,15.92,,10.92,,],[,1,15,,,,13,,15,,,,13,,15,,18,,,,18,,,,18,,17,,15,,13,,15,,15,,,,13,,15,,,,13,,15,,18,,,,18,,,,18,,17,,15,,13,,15,,],[1,-1,8,,,,,,,,,,,,8,,,,,,,,,,,,8,,,,,,,,6,,,,,,,,,,,6,,,,,,,,,,,,,6,,,,,,,,],[3,1,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,],[4,1,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,,,],[2,1,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,18,18,18]],[[5,-1,20,,15.5,,20.75,,15.75,,20.75,,15.75,,20.75,,15.75,,20,,15.5,,20.75,,15.75,,18,,18.5,,18.75,,18.75,,18,,22.5,,18.75,,22.75,,18.75,,22.75,,18.75,,22.75,,15,,10.5,,15,,22.5,,15.75,,22.75,,15,,22.75,,],[1,1,8,,,,,,,,,,,,8,,,,,,,,,,,,8,,,,,,,,6,,,,,,,,,,,6,,,,,,,,,,,,,6,,,,,,,,],[,-1,15,,,,13,,15,,,,13,,15,,18,,,,18,,,,18,,17,,15,,13,,15,,15,,,,13,,15,,,,13,,15,,18,,,,18,,,,18,,17,,15,,13,,15,,],[3,1,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,20,,,,,,,,],[4,1,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,24,,,,,,],[2,1,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,,,,,,,,18,18,18,,]]],[0,0,5,6,6,2,2,1,1,6,6,2,2,1,1,6,5,3],120,{}]);

    _lock_ = f => zzfx(...[, , f, .02, , .08, 1, 1.19, 11, , -344, .02, , , , , , .04, .02]); 
    _explosion_ = _ => zzfx(...[, , 585, .01, .23, .21, 4, 4.87, , , , , , .4, , .3, , .76, .13, .44]); 
    _shoot_ = _ => zzfx(...[, , 169, .02, , .24, 1, .77, .2, , , , , 2.1, , .1, , .93, .09, .02]); 
    _wave1_ = _ => zzfx(...[, , 388, .38, .4, .66, , 1.46, .5, -3.8, 4, .02, .15, , , , , .61, .02]); 
    _shields_ = _ => zzfx(...[,,603,.02,,.14,4,1.36,-0.6,.5,,,,,,,.05,.68,.08,.39]); 
    _zap_ = _ => zzfx(...[,,409,.02,,.21,,.64,-0.4,.3,,,,,,,.2,.61,.05,.21]);
    _gameover_ = _ => zzfx(...[,,533,,3,3,3,3.49,.5,.4,,,,.6,.2,.2,,.6,1])   

  </script>
</body>