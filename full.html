
<!--
  //#define boxes bs
  //#define star s
  //#define box b
  //#define update u
-->

<body style="background: #000">
  <svg id="c" viewBox="0 0 640 640" style="top:0;left:0;height:100%;width:100%">
    <style>
      .heavy { font: bold 20px sans-serif; }
    </style>
    <filter id="g" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="z1"/>
      <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="z2"/>
      <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="z3"/>
      <feMerge>
        <feMergeNode in="z1"/>
        <feMergeNode in="z2"/>
        <feMergeNode in="z3"/>
      </feMerge>
    </filter>
    <filter id="f1" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1"/>
    </filter>
    <filter id="f3" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="3"/>
    </filter>
    <filter id="f10" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="10"/>
    </filter>

 
    <path d="M0 0h640v640H0z" fill="#000"/>


    <g id="game">
      <g filter="url(#f3)" id="l0">
        &nbsp;
      </g>
      <g filter="url(#g)" id="l1">
        &nbsp;
        <g id="ship">
          <path d="M0 -7 L-5 4 L0 8 L5 4 Z" stroke-width="0.2" stroke="#fff" fill-opacity="0"/>
          <path d="M-5 4 L0 1 L5 4" stroke-width="0.2" stroke="#fff" fill-opacity="0"/>
        </g>
      </g>
    </g>
    <g filter="url(#g)" id="map">
      <path id="galaxy" filter="url(#f3)" fill="#fff2" transform="scale(4) translate(-5 0)" d="m0 89c0-39.4 31.6-77 74-77 33.8 0 61 23.2 61 58 0 20.8-16.2 44-41 44-22 0-34-14-34-31-3.6 0-6 6-6 12 0 16.6 19.8 34 43 34 30.4 0 62-27.8 62-69 0-25.6-12.4-47-23-60 13 11 32 32.8 32 67 0 39.4-31.6 77-74 77-33.8 0-61-23.2-61-58 0-20.8 16.2-44 41-44 22 0 34 14 34 31 3.6 0 6-6 6-12 0-16.6-19.8-34-43-34-30.4 0-62 27.8-62 69 0 25.6 12.4 47 23 60-13-11-32-32.8-32-67z"/>
    </g>
    <g>
      <text filter="url(#f1)" id="bottomtext" x=10 y=630 fill="#ff0" class="heavy">Hello</text>
    </g>
    <g style="visibility:hidden">
        <path id="star" d="M-2 -2h2v2h-2z"/>
        <path id="box" d="M-10 -10h20v20h-20z" fill-opacity="0"/>
    </g>
  </svg>
  <script>

    cols=["#f00", "#f70", "#ff0", "#7f0", "#0f0", "#0f7", "#0ff", "#07f", "#00f", "#70f", "#f0f", "#f07"];

    stars=[]; boxes=[]; targets=[]; targetsa=[]; shipcell = null;
    mousedown = false;

    shipx = 10+Math.floor(Math.random()*12);
    shipy = 10+Math.floor(Math.random()*12);

    fuel=100;
    warpdistance = 0;
    bottomtext.textContent = "Galaxy Map Active";

    sqr = x => x*x;
    calcfuel = d =>  sqr(Math.abs(d.x - shipx)) + sqr(Math.abs(d.y - shipy));

    // build map
    for (y=0; y<32; ++y) {
      for (x=0; x<32; ++x) {
        o = box.cloneNode();
        o.d = {x:x, y:y};
        
        if (x==shipx && y==shipy) {
          o.setAttribute("stroke","#ff0");
          shipcell = o
        } else {
          o.setAttribute("stroke","#fff2")
        };
        
        o.removeAttribute("id");
        o.setAttribute("transform","translate("+((x*20)+10)+" "+((y*20)+10)+")");
        o.onmouseenter = _ => {
          fuelneed = calcfuel(_.target.d);
          bottomtext.textContent = "Warp requires "+fuelneed+ "mgb.  Fuel available: "+fuel + "mgb";
          if (fuelneed <= fuel) {
            _.target.setAttribute("stroke","#fff")
          } else {
            _.target.setAttribute("stroke","#f00")
          }
          
        };
        o.onmouseleave = _ => {
          if (_.target.d.x==shipx && _.target.d.y==shipy) {
            _.target.setAttribute("stroke","#ff0")
          } else {
            _.target.setAttribute("stroke","#fff2")
          }
        };
        o.onclick = _ => {
          fuelneed = calcfuel(_.target.d);
          if (fuelneed <= fuel) {
            fuel -= fuelneed;
            warpdistance = fuelneed*100;
            shipx = _.target.d.x;
            shipy = _.target.d.y;
            _.target.setAttribute("stroke","#ff0");
            shipcell.setAttribute("stroke","#fff2");
            shipcell = _.target;
            showgame()
          }
        };
        
        map.appendChild(o)
      }
    };

    // build stars
    for(i=0; i<2000; ++i) {
      o=star.cloneNode();
      o.setAttribute("fill", cols[i%cols.length]);
      o.removeAttribute("id");
      o.d = { r: Math.random(), x: 300 + (Math.random() * 40), y: 300 + (Math.random() * 40), z: 0.1 };
      stars.push(o);
      l0.insertBefore(o, l0.firstChild)
    };

    // enemy box things
    s = 0.1;
    for(i=0; i<50; ++i) {
      o=box.cloneNode();
      o.setAttribute("stroke", cols[i%cols.length]);
      o.removeAttribute("id");
      o.onmouseenter = _ => {
        if (mousedown) {
          _.target.d.h=true;
          if (targets.length>0) {
            t = targets.pop();
            t.d.t = _.target.d;
            t.d.z = 100;
            targetsa.push(t)
          }
        }
      };
      o.onmouseleave = _ => {
        _.target.d.h=false
      };
      o.d = { r: 0, x: Math.random() * 640, y: Math.random() * 640, s: s += 0.0005 };
      boxes.push(o);
      l1.insertBefore(o, l1.firstChild)
    };
  
    // target boxes
    for (i=0; i<8; ++i) {
      o=box.cloneNode();
      o.setAttribute("stroke", "#fff");
      o.setAttribute("stroke-width", "0.3");
      o.removeAttribute("id");
      o.d = { r: 90, x: -100, y: -100, z: 1, t: null };
      targets.push(o);
      l1.insertBefore(o, ship)
    };

    mapshown=false;

    update = o => o.setAttribute("transform", "translate("+o.d.x+" "+o.d.y+") rotate("+o.d.r+") scale("+o.d.z+")");
    show = o => o.removeAttribute("style");
    hide = o => o.setAttribute("style","visibility:hidden");
    showmap = _ => { mapshown=true; hide(game); show(map) };
    showgame = _ => { mapshown=false; show(game); hide(map); bottomtext.textContent = "Entering Warp" };
    fire = _ => { targets = targets.concat(targetsa); targetsa=[] };
    
    focus=true;
    window.onfocus = _ => focus=true;
    window.onblur= _ => focus=false;
    n = 0;

    ship.d = {r:0, x:320, y:550, z:10};
    update(ship);

    showmap();

    c.onmousedown = _ => { 
      if (!mapshown) {
        mousedown = true 
      }
    };
    c.onmouseup = _ => { 
      if (!mapshown) {
        fire(); 
        mousedown = false 
      }
    };

    // Game loop
    setInterval(_ => {
      if(!focus || mapshown) return;

      if (warpdistance <=0) showmap();

      n += 0.025;
      warpdistance -= 1;

      x = 320 + (Math.sin(n) * 150);
      y = 200 + (Math.cos(n) * 150);

      boxes.forEach(o => {
        o.d.r += o.d.s * 5;
        o.d.x = (o.d.x * (1 - o.d.s)) + (x * o.d.s);
        o.d.y = (o.d.y * (1 - o.d.s)) + (y * o.d.s);
        o.d.z = 2.0 + Math.sin(n - (o.d.s * 100)) + (o.d.h ? 1 : 0);
        x = o.d.x;
        y = o.d.y;
        update(o)
      });

      stars.forEach(o => {
        m = 1.1 + ((Math.abs(o.d.x - 320)) / 500);
        o.d.z += m / 10;
        o.d.r += 1;
        o.d.x = ((o.d.x - 320) * m) + 320;
        o.d.y = ((o.d.y - 320) * m) + 320;
        if (o.d.x < 0 || o.d.x > 640 || o.d.y < 0 || o.d.y > 640) {
          o.d.x = 305 + (Math.random() * 30);
          o.d.y = 305 + (Math.random() * 30);
          o.d.z = 0.5
        };
        update(o)
      });

      targets.forEach(o => {
        o.d.x = -100;
        o.d.y = -100;
        update(o)
      });

      targetsa.forEach(o => {
        o.d.x = o.d.t.x;
        o.d.y = o.d.t.y;
        o.d.r = (0+o.d.r)/2;
        o.d.z = (3+o.d.z)/2;
        update(o)
      });

      ship.d.x = (Math.sin(n)*50)+320;

      update(ship)

    }, 50)
  </script>
</body>