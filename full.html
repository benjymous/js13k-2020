<!--
  //#define boxes bs
  //#define star s
  //#define box b
  //#define update u
-->

<body style="background: #000">
  <svg id="c" viewBox="0 0 640 640" style="top:0;left:0;height:100%;width:100%">
    <style>
      .heavy {
        font: bold 20px sans-serif;
      }
    </style>
    <clipPath id="clip">
      <path d="M0 0h640v640H0z"/>
    </clipPath>
    <filter id="g" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="z1" />
      <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="z2" />
      <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="z3" />
      <feMerge>
        <feMergeNode in="z1" />
        <feMergeNode in="z2" />
        <feMergeNode in="z3" />
      </feMerge>
    </filter>
    <filter id="f1" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1" />
    </filter>
    <filter id="f3" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="3" />
    </filter>
    <filter id="f10" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="10" />
    </filter>

  <!-- <path d="M0 0h640v640H0z" fill="#000"/> -->

    <g id="game" clip-path="url(#clip)">
      <g filter="url(#f3)" id="l0">
        &nbsp;
      </g>
      <g filter="url(#g)" id="l1">
        <path id="ship" d="M0 0" stroke-width="0.2" stroke="#fff" fill-opacity="0" />
      </g>
    </g>
    <g filter="url(#g)" id="map">
      <path id="galaxy" filter="url(#f3)" fill="#fff2" transform="scale(4) translate(-5 0)" d="m0 89c0-39.4 31.6-77 74-77 33.8 0 61 23.2 61 58 0 20.8-16.2 44-41 44-22 0-34-14-34-31-3.6 0-6 6-6 12 0 16.6 19.8 34 43 34 30.4 0 62-27.8 62-69 0-25.6-12.4-47-23-60 13 11 32 32.8 32 67 0 39.4-31.6 77-74 77-33.8 0-61-23.2-61-58 0-20.8 16.2-44 41-44 22 0 34 14 34 31 3.6 0 6-6 6-12 0-16.6-19.8-34-43-34-30.4 0-62 27.8-62 69 0 25.6 12.4 47 23 60-13-11-32-32.8-32-67z" />
    </g>
    <g>
      <text filter="url(#f1)" id="bottomtext" x=10 y=630 fill="#ff0" class="heavy"> </text>
    </g>
    <g style="visibility:hidden">
      <path id="star" d="M-2 -2h2v2h-2z" />
      <path id="box" d="M-10 -10h20v20h-20z" fill-opacity="0" />
      <path id="ground" d="M0 0" stroke-width="0.6" stroke="#fff" fill-opacity="0" />
    </g>


  </svg>

  <script>

    // adapted from https://gist.github.com/blixt/f17b47c62508be59987b
    //Random = function (t) { this._seed = t % 2147483647, this._seed <= 0 && (this._seed += 2147483646) }; Random.prototype.next = function () { return this._seed = 16807 * this._seed % 2147483647 }, Random.prototype.random = function () { return (this.next() - 1) / 2147483646 };

    // adapted from https://gist.github.com/banksean/304522
    SimplexNoise = function (t) { null == t && (t = Math), this.grad3 = [[1, 1, 0], [-1, 1, 0], [1, -1, 0], [-1, -1, 0], [1, 0, 1], [-1, 0, 1], [1, 0, -1], [-1, 0, -1], [0, 1, 1], [0, -1, 1], [0, 1, -1], [0, -1, -1]], this.p = []; for (var r = 0; r < 256; r++)this.p[r] = Math.floor(256 * t.random()); this.perm = []; for (r = 0; r < 512; r++)this.perm[r] = this.p[255 & r] }; SimplexNoise.prototype.dot = function (t, r, i) { return t[0] * r + t[1] * i }, SimplexNoise.prototype.noise = function (t, r) { var i, h, o = (t + r) * (.5 * (Math.sqrt(3) - 1)), s = Math.floor(t + o), e = Math.floor(r + o), p = (3 - Math.sqrt(3)) / 6, a = (s + e) * p, m = t - (s - a), n = r - (e - a); m > n ? (i = 1, h = 0) : (i = 0, h = 1); var d = m - i + p, f = n - h + p, l = m - 1 + 2 * p, u = n - 1 + 2 * p, M = 255 & s, g = 255 & e, v = this.perm[M + this.perm[g]] % 12, c = this.perm[M + i + this.perm[g + h]] % 12, x = this.perm[M + 1 + this.perm[g + 1]] % 12, N = .5 - m * m - n * n, S = .5 - d * d - f * f, q = .5 - l * l - u * u; return 70 * ((N < 0 ? 0 : (N *= N) * N * this.dot(this.grad3[v], m, n)) + (S < 0 ? 0 : (S *= S) * S * this.dot(this.grad3[c], d, f)) + (q < 0 ? 0 : (q *= q) * q * this.dot(this.grad3[x], l, u))) };
    simp = new SimplexNoise();

    clamp = (i,n,x) => i<n ? n : i>x ? x : i;

    update = o => o.setAttribute("transform", "translate(" + o.d.x + " " + o.d.y + ") rotate(" + o.d.r + ") scale(" + o.d.z + ")");
    show = o => o.removeAttribute("style");
    hide = o => o.setAttribute("style", "visibility:hidden");
    showmap = _ => { mapshown = true; hide(game); show(map) };
    showgame = _ => { mapshown = false; show(game); hide(map); bottomtext.textContent = "" /*"Entering Warp"*/ };

    cols = ["#f00", "#f70", "#ff0", "#7f0", "#0f0", "#0f7", "#0ff", "#07f", "#00f", "#70f", "#f0f", "#f07"];

    targets = []; shipcell = null;

    objects = [];

    mousedown = false;

    shipx = 10 + Math.floor(Math.random() * 12);
    shipy = 10 + Math.floor(Math.random() * 12);

    fuel = 100;
    warpdistance = 0;
    bottomtext.textContent = "Galaxy Map Active";

    sqr = x => x * x;
    calcfuel = d => sqr(Math.abs(d.x - shipx)) + sqr(Math.abs(d.y - shipy));

    // build map
    for (y = 0; y < 32; ++y) {
      for (x = 0; x < 32; ++x) {
        o = box.cloneNode();
        o.d = { x: x, y: y };

        if (x == shipx && y == shipy) {
          o.setAttribute("stroke", "#ff0");
          shipcell = o
        } else {
          o.setAttribute("stroke", "#fff2")
        };

        o.removeAttribute("id");
        o.setAttribute("transform", "translate(" + ((x * 20) + 10) + " " + ((y * 20) + 10) + ")");
        o.onmouseenter = _ => {
          fuelneed = calcfuel(_.target.d);
          bottomtext.textContent = "Warp requires " + fuelneed + "mgb.  Fuel available: " + fuel + "mgb";
          if (fuelneed <= fuel) {
            _.target.setAttribute("stroke", "#fff")
          } else {
            _.target.setAttribute("stroke", "#f00")
          }

        };
        o.onmouseleave = _ => {
          if (_.target.d.x == shipx && _.target.d.y == shipy) {
            _.target.setAttribute("stroke", "#ff0")
          } else {
            _.target.setAttribute("stroke", "#fff2")
          }
        };
        o.onclick = _ => {
          fuelneed = calcfuel(_.target.d);
          if (fuelneed <= fuel) {
            fuel -= fuelneed;
            warpdistance = fuelneed * 100;
            shipx = _.target.d.x;
            shipy = _.target.d.y;
            _.target.setAttribute("stroke", "#ff0");
            shipcell.setAttribute("stroke", "#fff2");
            shipcell = _.target;
            showgame()
          }
        };

        map.appendChild(o)
      }
    };

    // // build stars
    // for(i=0; i<200; ++i) {
    //   o=star.cloneNode();
    //   o.setAttribute("fill", cols[i%cols.length]);
    //   o.removeAttribute("id");
    //   o.d = { r: Math.random(), x: 300 + (Math.random() * 40), y: 300 + (Math.random() * 40), z: 0.1 };

    //   o.d.onUpdate = (o,g)=> {
    //     m = 1.1 + ((Math.abs(o.d.x - 320)) / 500);
    //     o.d.z += m / 10;
    //     o.d.r += 1;
    //     o.d.x = ((o.d.x - 320) * m) + 320;
    //     o.d.y = ((o.d.y - 320) * m) + 320;
    //     if (o.d.x < 0 || o.d.x > 640 || o.d.y < 0 || o.d.y > 640) {
    //       o.d.x = 305 + (Math.random() * 30);
    //       o.d.y = 305 + (Math.random() * 30);
    //       o.d.z = 0.5
    //     };
    //     update(o)
    //   };

    //   objects.push(o);
    //   l0.insertBefore(o, l0.firstChild)
    // };

    // target boxes
    for (i=0; i<8; ++i) {
      o=box.cloneNode();
      o.setAttribute("stroke", "#fff");
      o.setAttribute("stroke-width", "0.3");
      o.removeAttribute("id");
      o.d = { r: 90, x: -200, y: -200, z: 1, t: null };
      o.d.onUpdate = (o, g) => {
        if (mousedown || missiletime > 0) {
          if (o.d.t) {
            o.d.x = o.d.t.x;
            o.d.y = o.d.t.y;
            o.d.r = o.d.r*0.75;
            o.d.z = (4+o.d.z)/2
          }
        } else {
          if (o.d.t != null) {
            if (maxmissiles - missiles > 0) {
              if (missiletime == 0) {
                m = firemissile();
     
                m.d.x = ship.d.x;
                m.d.y = ship.d.y;
                m.d.t = o.d.t;
                m.d.to = o.d.to;
              
                o.d.t = null;
                o.d.x = -100;
                o.d.y = -100;
                targets.push(o)
              }
            }
          }
        };
        update(o)
      };
      targets.push(o);
      update(o);
      l1.insertBefore(o, ship)
    };

    firemissile = _ => {
      missiles++;

      o=box.cloneNode();
      o.setAttribute("stroke", "#fff");
      o.setAttribute("stroke-width", "2");
      o.removeAttribute("id");
      o.d = { r: 0, x: -200, y: -200, z: 1, t: null };
      o.d.onUpdate = (o, g) => {
        if (o.d.t && !o.d.t.dead) {
          o.d.x = (o.d.x*0.85) + (o.d.t.x*0.15);
          o.d.y = (o.d.y*0.85) + (o.d.t.y*0.15);
          o.d.z = o.d.z * 0.95;

          if (o.d.z < 0.001) {
            o.remove();
            o.dead = true
          };

          if ((Math.abs(o.d.x - o.d.t.x) + Math.abs(o.d.y - o.d.t.y))<50) {
            explosion();
            o.dead = true;
            o.d.t.dead=true;

            o.d.to.remove();

            enemies--;
            missiles--;
           
            o.remove()
          };

          update(o)
        }
      };

      update(o);
      l1.insertBefore(o, ship);

      objects.push(o);
      shoot();
      
      missiletime = 8;

      return o
    };

    enemies = 0;
    missiles = 0;
    maxmissiles = 8;
    targetc = 0;
    wavetime = 100;

    enemywave1 = _ => {
      // enemy box things
      wave1();
      s = 0.1;
      for(i=0; i<10; ++i) {
        o=box.cloneNode();
        o.setAttribute("stroke", cols[i%cols.length]);
        o.removeAttribute("id");

        o.onpointerenter = _ => {
          if (mousedown) {
            if (targets.length>0) {
              t = targets.pop();
              t.d.t = _.target.d;
              t.d.to = _.target;
              t.d.z = 1000;
              t.d.r = 90;
              objects.push(t);
              lock(700 + (75*targetc));
              targetc++;
            }
          }
        };
        
        o.d = { r: 0, x: Math.random() * 640, ry: Math.random() * 640, s: s += 0.0005, z:0.1 };

        o.d.onUpdate = (o, g) => {
          o.d.r += o.d.s / o.d.z;
          o.d.x = (o.d.x * (1 - o.d.s)) + (g.x * o.d.s);
          o.d.ry = (o.d.ry * (1 - o.d.s)) + (g.y * o.d.s);
          o.d.z = (o.d.z*0.95) + (2.0 + Math.sin(n - (o.d.s * 100)))*0.05;

          if (!o.d.dead) {
            o.d.y = 250 - o.d.ry + gh*(o.d.z*2);
            g.x = o.d.x;
            g.y = o.d.ry
          } else {
            o.d.y = -100
          };
          update(o)
        };

        objects.push(o);
        enemies++;
        l1.insertBefore(o, l1.firstChild)
      }
    };


    // landscape
    slices = 20;
    div = 10;
    for (i = 0; i < slices; ++i) {
      o = ground.cloneNode();
      o.removeAttribute("id");
      o.d = { i: i+2 };
      o.d.onUpdate = (o, g) => {
        str = "";
        for (x = 0; x <= 64; ++x) {
          rx = ((32-x)*((slices+1-o.d.i)/10))/div;
        
          h = g.s.noise(g.gx+rx, (o.d.i+g.gy)/div);
          sq = o.d.i*o.d.i;
          str += x==0 ? "M" : "L";
          str += `${x * 10} ${(100-(gh*3))+((gh/slices) * sq) + (h * sq/2)}`
        };
        o.setAttribute("d", str);
        l1.insertBefore(o, ship)
      };
      objects.push(o)
    };

    missiletime = 0;
    mapshown = false;
    warpdistance = 10000;

    focus = false;
    window.onfocus = _ => focus = true;
    window.onblur = _ => focus = false;
    n = 0;

    ship.d = { r: 0, x: 320, y: 550, z: 10 };
    ship.d.onUpdate = (o, g) => {
      xp = 320+(mx*320);
      yp = 400+(my*100);
      o.d.x = (o.d.x*0.8 + xp*0.2);
      o.d.y = (o.d.y*0.8 + yp*0.2);
      gh = 27.5-(my*12.5);
      gx-= ((o.d.x-320)/3000);
      nosex = (320-o.d.x)/100;
      nosey = (o.d.y-400)/50;
      ship.setAttribute("d", `M${nosex} ${nosey} L-5 4 L0 8 L5 4 Z M-5 4 L0 1 L5 4`);
      update(o)
    };
    objects.push(ship);
    update(ship);

    //showmap();
    showgame();

    c.onpointerdown = _ => { 
      focus = true;
      if (!mapshown) {
        mousedown = true 
      }
    };
    c.onpointerup = _ => { 
      if (!mapshown) {
        mousedown = false;
        missiletime = 0;
        targetc = 0
      }
    };

    mx = 0;
    my = 0;
    rect = c.getBoundingClientRect();

    window.onresize = _ => {
      rect = c.getBoundingClientRect()
    };

    c.onmousemove = _ => {
      size = Math.min(rect.width, rect.height)/2;
      mx = clamp(((_.clientX - rect.left) - (rect.width/2)) / size, -1, 1);
      my = clamp(((_.clientY - rect.top)  - (rect.height/2)) / size, -1, 1)
      //console.log(mx,my)
    };

    //random = new Random(42);
    //simp = new Noise(random);

    gx = 100;
    gy = 0;
    gh = 10;

    // Game loop
    setInterval(_ => {
      if (!focus || mapshown) return;

      //if (warpdistance <= 0) showmap();

      n += 0.025;
      //warpdistance -= 1;
      gy-=1;
      if (missiletime > 0) missiletime--;

      g = {
        x: 320 + (Math.sin(n) * 150),
        y: 200 + (Math.cos(n) * 150),
        gy: gy,
        gx: gx,
        gh: gh,
        s: simp
      };

      objects2 = objects;
      objects = [];

      objects2.forEach(o => {
        if (o.d.onUpdate) o.d.onUpdate(o, g);
        if (!o.d.dead) objects.push(o)
      });

      //console.log(objects.length);

      if (enemies == 0) { 
        wavetime--;
        if (wavetime == 0) {
          wavetime = 25;
          enemywave1()
        }
      }

      /*
            boxes.forEach(o => {
              o.d.r += o.d.s * 5;
              o.d.x = (o.d.x * (1 - o.d.s)) + (x * o.d.s);
              o.d.y = (o.d.y * (1 - o.d.s)) + (y * o.d.s);
              o.d.z = 2.0 + Math.sin(n - (o.d.s * 100)) + (o.d.h ? 1 : 0);
              x = o.d.x;
              y = o.d.y;
              update(o)
            });
      
            stars.forEach(o => {
              m = 1.1 + ((Math.abs(o.d.x - 320)) / 500);
              o.d.z += m / 10;
              o.d.r += 1;
              o.d.x = ((o.d.x - 320) * m) + 320;
              o.d.y = ((o.d.y - 320) * m) + 320;
              if (o.d.x < 0 || o.d.x > 640 || o.d.y < 0 || o.d.y > 640) {
                o.d.x = 305 + (Math.random() * 30);
                o.d.y = 305 + (Math.random() * 30);
                o.d.z = 0.5
              };
              update(o)
            });
      
            targets.forEach(o => {
              o.d.x = -100;
              o.d.y = -100;
              update(o)
            });
      
            targetsa.forEach(o => {
              o.d.x = o.d.t.x;
              o.d.y = o.d.t.y;
              o.d.r = (0+o.d.r)/2;
              o.d.z = (3+o.d.z)/2;
              update(o)
            });
      
            ship.d.x = (Math.sin(n)*50)+320;
      
            str="M0 100";
            for(x=10; x<640; x+=10){
              str += `L ${x} ${100+(Math.random()*25)}`
            }
            g1.setAttribute("d", str)
      
      
            update(ship)
            */

    }, 50);

    lock = f => zzfx(...[,,f,.02,,.08,1,1.19,11,,-344,.02,,,,,,.04,.02]); // Blip 33
    explosion = _ => zzfx(...[,,585,.01,.23,.21,4,4.87,,,,,,.4,,.3,,.76,.13,.44]); // Explosion 43
    shoot = _ => zzfx(...[,,169,.02,,.24,1,.77,.2,,,,,2.1,,.1,,.93,.09,.02]); // Shoot 23
    wave1 = _ => zzfx(...[,,388,.38,.4,.66,,1.46,.5,-3.8,4,.02,.15,,,,,.61,.02]); // Powerup 99

    zzfxV=.3;    // volume
    zzfx=       // play sound
    (E=1,k=.05,p=220,d=0,t=0,u=.1,q=0,F=1,v=0,G=0,y=0,H=0,g=0,z=0,A=0,I=0,c=0,w=1,l=0,B=0)=>{d=99+d*zzfxR;t*=zzfxR;u=99+u*zzfxR;l*=zzfxR;c*=zzfxR;g=g*zzfxR|0;let b=2*Math.PI,h=d+l+t+u+c|0,J=v*=500*b/zzfxR**2,Z=p*=(1+2*k*Math.random()-k)*b/zzfxR,K=(0<A?1:-1)*b/4,f=0,C=0,a=0,L=0,M=0,e=0,m=1,x=[],n,r=zzfxX.createBufferSource(),D=zzfxX.createBuffer(1,h,zzfxR);for(r.connect(zzfxX.destination);a<h;x[a++]=e)++M%(100*I|0)||(e=q?1<q?2<q?3<q?Math.sin((f%b)**3):Math.max(Math.min(Math.tan(f),1),-1):1-(2*f/b%2+2)%2:1-4*Math.abs(Math.round(f/b)-f/b):Math.sin(f),e=(0<e?1:-1)*Math.abs(e)**F*(g?1-B+B*Math.sin(2*Math.PI*a/g):1)*E*zzfxV*(a<d?a/d:a<d+l?1-(a-d)/l*(1-w):a<d+l+t?w:a<h-c?(h-a-c)/u*w:0),e=c?e/2+(c>a?0:(a<h-c?1:(a-h)/c)*x[a-c|0]/2):e),n=(p+=v+=500*G*b/zzfxR**3)*Math.sin(C*A*b/zzfxR-K),f+=n-n*z*(1-1E9*(Math.sin(a)+1)%2),C+=n-n*z*(1-1E9*(Math.sin(a)**2+1)%2),m&&++m>H*zzfxR&&(p+=y*b/zzfxR,Z+=y*b/zzfxR,m=0),!g||++L%g||(p=Z,v=J,m=m||1);D.getChannelData(0).set(x);r.buffer=D;r.start();return r};zzfxX=new(window.AudioContext||webkitAudioContext);zzfxR=44100

  </script>
</body>