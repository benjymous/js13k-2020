<body style="background: #000;cursor: none">
  <svg id="c" viewBox="0 0 640 640" style="position:absolute;top:0;left:0;height:100%;width:100%">
    <style>
      .heavy {
        font: bold 20px monospace;
      }
      .big {
        font: 30px monospace;
      }
      .bigger {
        font: 50px monospace;
      }
    </style>
    <clipPath id="clip">
      <path d="M0 0h640v640H0z"/>
    </clipPath>
    <filter id="g" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="z1"/>
      <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="z2"/>
      <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="z3"/>
      <feMerge>
        <feMergeNode in="z1"/>
        <feMergeNode in="z2"/>
        <feMergeNode in="z3"/>
      </feMerge>
    </filter>
    <filter id="f1" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1"/>
    </filter>
    <filter id="f1.5" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5"/>
    </filter>
    <filter id="f3" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="3"/>
    </filter>
    <filter id="f10" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="10"/>
    </filter>

    <!-- <path d="M0 0h640v640H0z" fill="#000"/> -->

    <g clip-path="url(#clip)">

      <g id="title" filter="url(#f1)" style="visibility:hidden">
        <path fill="#000" d="M0 0h640v640H0"/>
        <text x=15 y=100 fill="#fff" class="bigger">The Legend of Yeti-404</text>
        <text x=300 y=150 fill="#fff" class="big">#js13k 2020</text>
        <text x=15 y=550 fill="#fff" class="bigger">A game by Richard Munn</text>
      </g>
      <g id="orbit" filter="url(#f1)" style="visibility:hidden">
        <text filter="url(#f1)" x=20 y=40 fill="#fff" class="big">Currently in orbit at</text>
        <text id="orbitcoords"  x=400 y=40 fill="#fff" class="big">[0:0]</text>
        <g id="orbitmap" transform="translate(0 80)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000"/>
          <text id="orbitmaptext" x=50 y=25 fill="#fff" class="big">&gt; Galaxy Map</text>
        </g>

        <g id="orbitscan" transform="translate(0 110)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000"/>
          <text id="orbitscantext" x=50 y=25 fill="#fff" class="big">&gt; Scan System</text>
        </g>

        <g id="orbitenter" transform="translate(0 140)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000"/>
          <text id="orbitentertext"  x=50 y=25 fill="#fff" class="big">&gt; Enter Atmosphere</text>
        </g>

        <text x=20 y=400 fill="#fff" class="big">System Information</text>
        <text x=60 y=430 fill="#fff" class="big">Faction:</text>
        <text id="infofaction" x=400 y=430 fill="#fff" class="big">Unknown</text>
        <text x=60 y=460 fill="#fff" class="big">Economy:</text>
        <text id="infotrade" x=400 y=460 fill="#fff" class="big">Unknown</text>
        <text x=60 y=490 fill="#fff" class="big">Points of interest:</text>
        <text id="infopoi" x=400 y=490 fill="#fff" class="big">Unknown</text>
        
      </g>
      <g id="game" style="visibility:hidden">
        <!--<g filter="url(#f3)" id="l0">
        &nbsp;
      </g>-->
        <g filter="url(#g)" id="l1">
          <g id="l10">.</g> <!-- landscape -->
          <g id="l11">.</g> <!-- missiles and targets -->
          <path d="M0 0 H640 V640 H-640 Z" fill="#000" fill-opacity="0.1"/>

          <g id="l12">.</g> <!-- enemies -->
          <path id="ship" d="M0 0" stroke-width="0.2" stroke="#fff" fill-opacity="0"/>
        </g>
      </g>

      <g filter="url(#f1)" id="map" style="visibility:hidden">
        <path id="galaxy" filter="url(#f10)" fill="#fff2"
          d="M-20 356c0-158 126-308 296-308 135 0 244 93 244 232 0 83-64 176-164 176-88 0-136-56-136-124-14 0-24 24-24 48 0 66 79 136 172 136 122 0 248-111 248-276 0-102-50-188-92-240 52 44 128 131 128 268 0 158-126 308-296 308-135 0-244-93-244-232 0-83 65-176 164-176 88 0 136 56 136 124 14 0 24-24 24-48 0-66-79-136-172-136-122 0-248 111-248 276 0 102 50 188 92 240C56 580-20 493-20 356z"/>
        <g id="mapexit" transform="translate(0 0)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000"/>
          <text id="mapexittext"  x=10 y=25 fill="#fff" class="big">&lt; Cancel</text>
        </g>
      </g>
      <g>
        <text filter="url(#f1)" id="bottomtext" x=10 y=630 fill="#ff0" class="heavy"> </text>
      </g>
    </g>
    <path id="vsync" filter="url(#f10)" d="M-10 0 H650 V200 H-640 Z" fill="#303" fill-opacity="0.2"
    style="pointer-events:none"/>

    <path id="cursor" filter="url(#g)" d="M0 0 m-10 0 h -30 m40 0 h 30 m-35 5 v 30 m0 -40 v -30" stroke-width="0.7" stroke="#fff"
    fill-opacity="0" style="pointer-events:none"/>
    <g style="visibility:hidden">
      <path id="star" d="M-2 -2h2v2h-2z"/>
      <path id="box" d="M-10 -10h20v20h-20z" fill-opacity="0"/>
      <path id="mapcell" d="M0 0h15v15h-15z" fill-opacity="0"/>
      <path id="ground" d="M0 0" stroke-width="0.6" stroke="#fff" fill-opacity="0"/>
    </g>
  </svg>

  <script>
    // adapted from https://gist.github.com/banksean/304522
    SN = function (t) { null == t && (t = Math), this.g3 = [[1, 1, 0], [-1, 1, 0], [1, -1, 0], [-1, -1, 0], [1, 0, 1], [-1, 0, 1], [1, 0, -1], [-1, 0, -1], [0, 1, 1], [0, -1, 1], [0, 1, -1], [0, -1, -1]], this.p = []; for (var r = 0; r < 256; r++)this.p[r] = Math.floor(256 * t.random()); this.m = []; for (r = 0; r < 512; r++)this.m[r] = this.p[255 & r] }; SN.prototype.n = function (t, r) { var i, h, o = (t + r) * (.5 * (Math.sqrt(3) - 1)), s = Math.floor(t + o), e = Math.floor(r + o), p = (3 - Math.sqrt(3)) / 6, a = (s + e) * p, m = t - (s - a), n = r - (e - a); m > n ? (i = 1, h = 0) : (i = 0, h = 1); var d = m - i + p, f = n - h + p, l = m - 1 + 2 * p, u = n - 1 + 2 * p, M = 255 & s, g = 255 & e, v = this.m[M + this.m[g]] % 12, c = this.m[M + i + this.m[g + h]] % 12, x = this.m[M + 1 + this.m[g + 1]] % 12, N = .5 - m * m - n * n, S = .5 - d * d - f * f, q = .5 - l * l - u * u; return 70 * ((N < 0 ? 0 : (N *= N) * N * dot(this.g3[v], m, n)) + (S < 0 ? 0 : (S *= S) * S * dot(this.g3[c], d, f)) + (q < 0 ? 0 : (q *= q) * q * dot(this.g3[x], l, u))) };
    dot = (t, r, i) => t[0] * r + t[1] * i;
    sn = new SN();

    clamp = (i, n, x) => i < n ? n : i > x ? x : i;

    u = o => o.setAttribute("transform", "translate(" + o.d.x + " " + o.d.y + ") rotate(" + o.d.r + ") scale(" + o.d.z + ")");
    show = o => o.removeAttribute("style");
    hide = o => o.setAttribute("style", "visibility:hidden");
    text = o => bottomtext.textContent = o;
    showtitle = _ => { gameloop = false; hide(game); hide(orbit); hide(map); show(title); text() };
    showmap = _ => { gameloop = false; hide(game); hide(orbit); show(map); hide(title); text() };
    showgame = _ => { gameloop = true; show(game); hide(orbit); hide(map); hide(title); text() };
    showorbit = _ => { 
      gameloop = false; hide(game); show(orbit); hide(map); hide(title); text(); orbitcoords.textContent = `[${shipx},${shipy}]`;
      f = factionmap[shipy][shipx];
      if (f.scanned) {
        infofaction.textContent = factions[f.faction].name;

        console.log(f);

        sci = Math.floor(f.sci * factions[f.faction].sci);
        trade = Math.floor(f.trade * factions[f.faction].trade);
        war = Math.floor(f.war * factions[f.faction].war);

        console.log(sci,trade,war);

        economy = "???";


        /*

        STW
        111 = balanced
        100 = science
        110 = technology
        010 = trade
        011 = arms
        001 = warfare
        101 = espionage

        */


        if (sci == trade && sci == war) {
          economy = "balanced"
        } else if (sci == trade && sci > war) {
          economy = "technology"
        } else if (sci > trade && sci > war) {
          economy = "science"
        } else if (trade > sci && trade > war) {
          economy = "trade"
        } else if (trade > sci && trade == war) {
          economy = "arms"
        } else if (war > trade && war > sci) {
          economy = "warfare"
        } else if (science == war && war > trade) {
          economy = "espionage"
        };

        infotrade.textContent = economy;
        infopoi.textContent = "???"
      } else {
        infofaction.textContent = "Unknown";
        infotrade.textContent = "Unknown";
        infopoi.textContent =  "Unknown"
      }
    };
    showwarp = _ => showorbit();

    cols = ["#f00", "#f70", "#ff0", "#7f0", "#0f0", "#0f7", "#0ff", "#07f", "#00f", "#70f", "#f0f", "#f07"];
    factionCol = ["#000", "#f0f", "#ff0", "#05f"];
    factions = [
      {name:"Unclaimed",    sci:1, trade:1, war:1},
      {name:"Federation",   sci:3, trade:6, war:1},
      {name:"Union",        sci:5, trade:4, war:1},
      {name:"Empire",       sci:1, trade:3, war:6}
    ];

    items = [
      {name:"Salvage",               sci:2, trade:2, war:1},
      {name:"Luxury goods",          sci:4, trade:8, war:5},
      {name:"Advamced technology",   sci:7, trade:9, war:8},
      {name:"Entertainment devices", sci:2, trade:6, war:2},
      {name:"Mysterious boxes",      sci:6, trade:3, war:1},
      {name:"Small furry creatures", sci:5, trade:7, war:1},
      {name:"Lab grown meat",        sci:3, trade:2, war:4},
      {name:"Exotic weapons",        sci:4, trade:6, war:9},
      {name:"Service robots",        sci:5, trade:4, war:2},
      {name:"", sci:0, trade:0, war:0},
      {name:"", sci:0, trade:0, war:0},
      {name:"", sci:0, trade:0, war:0},
      {name:"", sci:0, trade:0, war:0},
      {name:"", sci:0, trade:0, war:0},
      {name:"", sci:0, trade:0, war:0},
      {name:"", sci:0, trade:0, war:0},
      {name:"", sci:0, trade:0, war:0},
      {name:"", sci:0, trade:0, war:0},
      {name:"", sci:0, trade:0, war:0},
      {name:"", sci:0, trade:0, war:0},
      {name:"", sci:0, trade:0, war:0}
    ];

    targets = []; shipcell = null;

    objects = []; fxobjects = [];

    mousedown = false;

    shipx = 10 + Math.floor(Math.random() * 12);
    shipy = 10 + Math.floor(Math.random() * 12);

    fuel = 100;
    warpdistance = 0;

    sqr = x => x * x;
    calcfuel = d => sqr(Math.abs(d.x - shipx)) + sqr(Math.abs(d.y - shipy));

    title.onclick = _ => showorbit();

    factionmap = [];

    for (y = 0; y < 32; ++y) {
      factionmap[y] = [];
      for (x = 0; x < 32; ++x) {
        factionmap[y][x] = {faction:0, scanned: false, sci:Math.random()*3, trade:Math.random()*3, war:Math.random()*3}
      }
    };

    x = 5 + Math.floor(Math.random() * 22);
    y = 5 + Math.floor(Math.random() * 22);

    for (i = 1; i < 4; ++i) {
      factionSize = 50 + Math.floor(Math.random() * 250);
      while (factionmap[y][x].faction != 0) {
        x = 10 + Math.floor(Math.random() * 22);
        y = 10 + Math.floor(Math.random() * 22)
      };
      factionmap[y][x].faction = i;

      seeds = [];

      seeds.push([x,y]);

      j = 0;
      fail = 0;
      while (j < factionSize && fail < 500) {

        v = seeds[Math.floor(Math.random() * seeds.length)];

        x = clamp( v[0] - 5 + Math.floor(Math.random() * 10), 0, 31);
        y = clamp( v[1] - 5 + Math.floor(Math.random() * 10), 0, 31);

        if (factionmap[y][x].faction == 0) {
          factionmap[y][x].faction = i;
          seeds.push([x,y]);
          ++j
        } else {
          fail++
        }
      }
    };

    textwidget = (el, t, f) => {
      el.onmouseenter = _ => t.setAttribute("fill", "#990");
      el.onmouseleave = _ => t.setAttribute("fill", "#fff");
      el.onclick = _ => f()
    };

    textwidget(orbitmap, orbitmaptext, _ => showmap() );
    textwidget(orbitscan, orbitscantext, _ => { 
      factionmap[shipy][shipx].scanned = true; 
      factionmap[shipy][shipx].mapcell.setAttribute("fill", factionCol[factionmap[shipy][shipx].faction]);
      factionmap[shipy][shipx].mapcell.setAttribute("fill-opacity", "0.6")
      showorbit() 
    });
    textwidget(orbitenter, orbitentertext, _ => showgame() );
    textwidget(mapexit, mapexittext, _ => showorbit() );

    if (map != undefined) {
      // build map
      for (y = 0; y < 32; ++y) {
        for (x = 0; x < 32; ++x) {
          o = mapcell.cloneNode();
          o.d = { x: x, y: y };

          if (x == shipx && y == shipy) {
            o.setAttribute("stroke", "#ff0");
            shipcell = o
          } else {
            o.setAttribute("stroke", "#fff2")
          };

          factionmap[y][x].mapcell = o;

          // if (factionmap[y][x].factionCol != 0) {
          //   o.setAttribute("fill", factionCol[factionmap[y][x].faction-1]);
          //   o.setAttribute("fill-opacity", "0.25")
          // };

          o.removeAttribute("id");
          o.setAttribute("transform", "translate(" + ((x * 18) +32) + " " + ((y * 18) + 34) + ")");
          o.onmouseenter = _ => {
            fuelneed = calcfuel(_.target.d);
            text("Warp requires " + fuelneed + "mgb.  Fuel available: " + fuel + "mgb");
            if (fuelneed <= fuel) {
              _.target.setAttribute("stroke", "#fff")
            } else {
              _.target.setAttribute("stroke", "#f00")
            }

          };
          o.onmouseleave = _ => {
            if (_.target.d.x == shipx && _.target.d.y == shipy) {
              _.target.setAttribute("stroke", "#ff0")
            } else {
              _.target.setAttribute("stroke", "#fff2")
            }
          };
          o.onclick = _ => {
            fuelneed = calcfuel(_.target.d);
            if (fuelneed <= fuel) {
              fuel -= fuelneed;
              warpdistance = fuelneed * 100;
              shipx = _.target.d.x;
              shipy = _.target.d.y;
              _.target.setAttribute("stroke", "#ff0");
              shipcell.setAttribute("stroke", "#fff2");
              shipcell = _.target;
              showwarp()
            }
          };

          map.appendChild(o)
        }
      }
    };

    // // build stars
    // for(i=0; i<200; ++i) {
    //   o=star.cloneNode();
    //   o.setAttribute("fill", cols[i%cols.length]);
    //   o.removeAttribute("id");
    //   o.d = { r: Math.random(), x: 300 + (Math.random() * 40), y: 300 + (Math.random() * 40), z: 0.1 };

    //   o.d.u = (o,g)=> {
    //     m = 1.1 + ((Math.abs(o.d.x - 320)) / 500);
    //     o.d.z += m / 10;
    //     o.d.r += 1;
    //     o.d.x = ((o.d.x - 320) * m) + 320;
    //     o.d.y = ((o.d.y - 320) * m) + 320;
    //     if (o.d.x < 0 || o.d.x > 640 || o.d.y < 0 || o.d.y > 640) {
    //       o.d.x = 305 + (Math.random() * 30);
    //       o.d.y = 305 + (Math.random() * 30);
    //       o.d.z = 0.5
    //     };
    //     u(o)
    //   };

    //   objects.push(o);
    //   l0.insertBefore(o, l0.firstChild)
    // };

    // target boxes
    for (i = 0; i < 8; ++i) {
      o = box.cloneNode();
      o.setAttribute("stroke", "#fff");
      o.setAttribute("stroke-width", "0.3");
      o.removeAttribute("id");
      o.d = { r: 90, x: -200, y: -200, z: 1, t: null };
      o.d.u = (o, g) => {
        if (mousedown || missiletime > 0) {
          if (o.d.t) {
            o.d.x = o.d.t.x;
            o.d.y = o.d.t.y;
            o.d.r = o.d.r * 0.75;
            o.d.z = (4 + o.d.z) / 2
          }
        } else {
          if (o.d.t != null) {
            if (maxmissiles - missiles > 0) {
              if (missiletime == 0) {
                m = firemissile();

                m.d.x = ship.d.x;
                m.d.y = ship.d.y;
                m.d.t = o.d.t;
                m.d.to = o.d.to;

                o.d.t = null;
                o.d.x = -100;
                o.d.y = -100;
                targets.push(o)
              }
            }
          }
        };
        u(o)
      };
      targets.push(o);
      u(o);
      l11.appendChild(o)
    };

    firemissile = _ => {
      missiles++;

      o = box.cloneNode();
      o.setAttribute("stroke", "#fff");
      o.setAttribute("stroke-width", "2");
      o.removeAttribute("id");
      o.d = { r: 0, x: -200, y: -200, z: 1, t: null };
      o.d.u = (o, g) => {
        if (o.d.t && !o.d.t.dead) {
          o.d.x = (o.d.x * 0.85) + (o.d.t.x * 0.15);
          o.d.y = (o.d.y * 0.85) + (o.d.t.y * 0.15);
          o.d.z = o.d.z * 0.95;

          if (o.d.z < 0.001) {
            o.remove();
            o.dead = true
          };

          if ((Math.abs(o.d.x - o.d.t.x) + Math.abs(o.d.y - o.d.t.y)) < 50) {
            explosion();
            o.dead = true;
            o.d.t.dead = true;

            o.d.to.remove();

            enemies--;
            missiles--;

            o.remove()
          };

          u(o)
        }
      };

      u(o);
      l11.appendChild(o);

      objects.push(o);
      shoot();

      missiletime = 4;

      return o
    };

    enemies = 0;
    missiles = 0;
    maxmissiles = 8;
    targetc = 0;
    wavetime = 100;

    enemywave1 = _ => {
      // enemy box things
      wave1();
      s = 0.1;
      for (i = 0; i < 10; ++i) {
        o = box.cloneNode();
        o.setAttribute("stroke", cols[i % cols.length]);
        o.removeAttribute("id");

        o.onpointerenter = _ => {
          if (mousedown) {
            if (targets.length > 0) {
              t = targets.pop();
              t.d.t = _.target.d;
              t.d.to = _.target;
              t.d.z = 1000;
              t.d.r = 90;
              objects.push(t);
              lock(700 + (50 * targetc));
              _.target.onpointerenter = null;
              targetc++
            }
          }
        };

        o.d = { r: 0, x: Math.random() * 640, ry: Math.random() * 640, s: s += 0.0005, z: 0.1 };

        o.d.u = (o, g) => {
          o.d.r += o.d.s * 1000;
          o.d.x = (o.d.x * (1 - o.d.s)) + (g.x * o.d.s);
          o.d.ry = (o.d.ry * (1 - o.d.s)) + (g.y * o.d.s);
          o.d.z = (o.d.z * 0.95) + (2.0 + Math.sin(n - (o.d.s * 100))) * 0.05;

          if (!o.d.dead) {
            o.d.y = 250 - o.d.ry + gh * (o.d.z * 2);
            g.x = o.d.x;
            g.y = o.d.ry
          } else {
            o.d.y = -100
          };
          u(o)
        };

        objects.push(o);
        enemies++;
        l12.appendChild(o)
      }
    };


    // landscape
    slices = 20;
    div = 10;
    for (i = 0; i < slices; ++i) {
      o = ground.cloneNode();
      o.removeAttribute("id");
      o.d = { i: i + 2 };
      o.d.u = (o, g) => {
        str = "";
        for (x = 0; x <= 64; ++x) {
          rx = ((32 - x) * ((slices + 1 - o.d.i) / 10)) / div;

          h = g.sn.n(g.gx + rx, (o.d.i + g.gy) / div);
          sq = o.d.i * o.d.i;
          str += x == 0 ? "M" : "L";
          str += `${x * 10} ${(100 - (gh * 3)) + ((gh / slices) * sq) + (h * sq / 2)}`
        };
        o.setAttribute("d", str);
        l10.appendChild(o)
      };
      objects.push(o)
    };

    missiletime = 0;
    gameloop = false;
    warpdistance = 10000;

    focus = true;
    window.onfocus = _ => focus = true;
    window.onblur = _ => focus = false;
    n = 0;

    ship.d = { r: 0, x: 320, y: 550, z: 10 };
    ship.d.u = (o, g) => {
      xp = 320 + (mx * 320);
      yp = 400 + (my * 100);
      o.d.x = (o.d.x * 0.8 + xp * 0.2);
      o.d.y = (o.d.y * 0.8 + yp * 0.2);
      gh = 27.5 - (my * 12.5);
      gx -= ((o.d.x - 320) / 3000);
      nosex = (320 - o.d.x) / 100;
      nosey = (o.d.y - 400) / 50;
      ship.setAttribute("d", `M${nosex} ${nosey} L-5 4 L0 8 L5 4 Z M-5 4 L0 1 L5 4`);
      u(o)
    };
    objects.push(ship);
    u(ship);

    cursor.d = { r: 0, x: 320, y: 320, z: 1 };
    cursor.d.u = (o, g) => {
      o.d.x = 320 + (mx * 320);
      o.d.y = 320 + (my * 320);
      u(o)
    };
    fxobjects.push(cursor);
    u(cursor);

    vsync.d = { r: 0, x: 0, y: 0, z: 1 };
    vsync.d.u = (o, g) => {
      o.d.y += 16;
      if (o.d.y > 640) o.d.y = -200;
      u(o)
    };
    fxobjects.push(vsync);

    showtitle();
    //showmap();
    //showgame();
    //showorbit();

    c.onpointerdown = _ => {
      focus = true;
      if (gameloop) {
        mousedown = true
      }

    };
    c.onpointerup = _ => {
      if (gameloop) {
        mousedown = false;
        missiletime = 0;
        targetc = 0
      }
    };

    mx = 0;
    my = 0;
    rect = c.getBoundingClientRect();

    window.onresize = _ => {
      rect = c.getBoundingClientRect()
    };

    c.onmousemove = _ => {
      size = Math.min(rect.width, rect.height) / 2;
      mx = clamp(((_.clientX - rect.left) - (rect.width / 2)) / size, -1, 1);
      my = clamp(((_.clientY - rect.top) - (rect.height / 2)) / size, -1, 1)
      //console.log(mx,my)
    };

    gx = 100;
    gy = 0;
    gh = 10;

    // Game loop
    setInterval(_ => {
      if (!focus) return;

      fxobjects.forEach(o => {
        if (o.d.u) o.d.u(o, g)
      });

      if (!gameloop) return;

      //if (warpdistance <= 0) showmap();

      n += 0.025;
      //warpdistance -= 1;
      gy -= 1;
      if (missiletime > 0) missiletime--;

      g = {
        x: 320 + (Math.sin(n) * 150),
        y: 200 + (Math.cos(n) * 150),
        gy: gy,
        gx: gx,
        gh: gh,
        sn: sn
      };

      objects2 = objects;
      objects = [];

      objects2.forEach(o => {
        if (o.d.u) o.d.u(o, g);
        if (!o.d.dead) objects.push(o)
      });

      //console.log(objects.length);

      if (enemies == 0) {
        wavetime--;
        if (wavetime == 0) {
          wavetime = 25;
          enemywave1()
        }
      }

      /*
            boxes.forEach(o => {
              o.d.r += o.d.s * 5;
              o.d.x = (o.d.x * (1 - o.d.s)) + (x * o.d.s);
              o.d.y = (o.d.y * (1 - o.d.s)) + (y * o.d.s);
              o.d.z = 2.0 + Math.sin(n - (o.d.s * 100)) + (o.d.h ? 1 : 0);
              x = o.d.x;
              y = o.d.y;
              u(o)
            });
      
            stars.forEach(o => {
              m = 1.1 + ((Math.abs(o.d.x - 320)) / 500);
              o.d.z += m / 10;
              o.d.r += 1;
              o.d.x = ((o.d.x - 320) * m) + 320;
              o.d.y = ((o.d.y - 320) * m) + 320;
              if (o.d.x < 0 || o.d.x > 640 || o.d.y < 0 || o.d.y > 640) {
                o.d.x = 305 + (Math.random() * 30);
                o.d.y = 305 + (Math.random() * 30);
                o.d.z = 0.5
              };
              u(o)
            });
      
            targets.forEach(o => {
              o.d.x = -100;
              o.d.y = -100;
              u(o)
            });
      
            targetsa.forEach(o => {
              o.d.x = o.d.t.x;
              o.d.y = o.d.t.y;
              o.d.r = (0+o.d.r)/2;
              o.d.z = (3+o.d.z)/2;
              u(o)
            });
      
            ship.d.x = (Math.sin(n)*50)+320;
      
            str="M0 100";
            for(x=10; x<640; x+=10){
              str += `L ${x} ${100+(Math.random()*25)}`
            }
            g1.setAttribute("d", str)
      
      
            u(ship)
            */

    }, 50);

    lock = f => zzfx(...[, , f, .02, , .08, 1, 1.19, 11, , -344, .02, , , , , , .04, .02]); // Blip 33
    explosion = _ => zzfx(...[, , 585, .01, .23, .21, 4, 4.87, , , , , , .4, , .3, , .76, .13, .44]); // Explosion 43
    shoot = _ => zzfx(...[, , 169, .02, , .24, 1, .77, .2, , , , , 2.1, , .1, , .93, .09, .02]); // Shoot 23
    wave1 = _ => zzfx(...[, , 388, .38, .4, .66, , 1.46, .5, -3.8, 4, .02, .15, , , , , .61, .02]); // Powerup 99

    zzfxV = .3;    // volume
    zzfx =       // play sound
      (E = 1, k = .05, p = 220, d = 0, t = 0, u = .1, q = 0, F = 1, v = 0, G = 0, y = 0, H = 0, g = 0, z = 0, A = 0, I = 0, c = 0, w = 1, l = 0, B = 0) => { d = 99 + d * zzfxR; t *= zzfxR; u = 99 + u * zzfxR; l *= zzfxR; c *= zzfxR; g = g * zzfxR | 0; let b = 2 * Math.PI, h = d + l + t + u + c | 0, J = v *= 500 * b / zzfxR ** 2, Z = p *= (1 + 2 * k * Math.random() - k) * b / zzfxR, K = (0 < A ? 1 : -1) * b / 4, f = 0, C = 0, a = 0, L = 0, M = 0, e = 0, m = 1, x = [], n, r = zzfxX.createBufferSource(), D = zzfxX.createBuffer(1, h, zzfxR); for (r.connect(zzfxX.destination); a < h; x[a++] = e)++M % (100 * I | 0) || (e = q ? 1 < q ? 2 < q ? 3 < q ? Math.sin((f % b) ** 3) : Math.max(Math.min(Math.tan(f), 1), -1) : 1 - (2 * f / b % 2 + 2) % 2 : 1 - 4 * Math.abs(Math.round(f / b) - f / b) : Math.sin(f), e = (0 < e ? 1 : -1) * Math.abs(e) ** F * (g ? 1 - B + B * Math.sin(2 * Math.PI * a / g) : 1) * E * zzfxV * (a < d ? a / d : a < d + l ? 1 - (a - d) / l * (1 - w) : a < d + l + t ? w : a < h - c ? (h - a - c) / u * w : 0), e = c ? e / 2 + (c > a ? 0 : (a < h - c ? 1 : (a - h) / c) * x[a - c | 0] / 2) : e), n = (p += v += 500 * G * b / zzfxR ** 3) * Math.sin(C * A * b / zzfxR - K), f += n - n * z * (1 - 1E9 * (Math.sin(a) + 1) % 2), C += n - n * z * (1 - 1E9 * (Math.sin(a) ** 2 + 1) % 2), m && ++m > H * zzfxR && (p += y * b / zzfxR, Z += y * b / zzfxR, m = 0), !g || ++L % g || (p = Z, v = J, m = m || 1); D.getChannelData(0).set(x); r.buffer = D; r.start(); return r }; zzfxX = new (window.AudioContext || webkitAudioContext); zzfxR = 44100

  </script>
</body>