<body style="background: #000;cursor: none">

  <!--
  ///#define _decompose_ d
  ///#define _update_ u
  ///#define _show_ s
  ///#define _hide_ h
  ///#define _textwidget_ t
  ///#define _critter_ a

  ///#define _lock_ fx1
  ///#define _explosion_ fx2
  ///#define _shoot_ fx3
  ///#define _wave1_ fx4
  ///#define _zap_ fx5
  ///#define _shields_ fx6
  ///#define _dead_ fx7
  ///#define zzfx fx

  ///#define _sci_ x
  ///#define _trade_ y
  ///#define _war_ z
  -->

  <svg id="c" viewBox="0 0 640 640" style="position:absolute;top:0;left:0;height:100%;width:100%">
    <style>
      .heavy {
        font: bold 20px monospace;
      }
      .big {
        font: 30px monospace;
      }
      .bigger {
        font: 50px monospace;
      }
    </style>
    <clipPath id="clip">
      <path d="M0 0h640v640H0z"/>
    </clipPath>
    <filter id="g" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="z1"/>
      <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="z2"/>
      <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="z3"/>
      <feMerge>
        <feMergeNode in="z1"/>
        <feMergeNode in="z2"/>
        <feMergeNode in="z3"/>
      </feMerge>
    </filter>
    <filter id="f1" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1"/>
    </filter>
    <filter id="f3" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="3"/>
    </filter>
    <filter id="f10" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="10"/>
    </filter>

    <g clip-path="url(#clip)">

      <g id="title" filter="url(#f1)">
        <path fill="#000" d="M0 0h640v640H0"/>
        <text x=15 y=100 fill="#fff" class="bigger">The Legend of Yeti-404</text>
        <text x=300 y=150 fill="#fff" class="big">#js13k 2020</text>
        <text x=15 y=550 fill="#fff" class="bigger">A game by Richard Munn</text>
      </g>
      <g id="orbit" filter="url(#f1)">

        <ellipse fill="#000" stroke-width="1.5" id="orbit_planet"/>
        <ellipse fill="#000" stroke-width="1.5" id="orbit_moon"/>

        <text x=20 y=40 fill="#fff" class="big">Currently in orbit at</text>
        <text id="orbitcoords" x=400 y=40 fill="#fff" class="big">[0:0]</text>
        <g id="orbitmap" transform="translate(0 80)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="orbitmaptext" x=50 y=25 fill="#fff" class="big">&gt; Galaxy Map</text>
        </g>

        <g id="orbitscan" transform="translate(0 110)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="orbitscantext" x=50 y=25 fill="#fff" class="big">&gt; Scan System</text>
        </g>

        <g id="orbitenter" transform="translate(0 140)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000" fill-opacity="0.1"/>
          <text id="orbitentertext" x=50 y=25 fill="#fff" class="big">&gt; Enter Atmosphere</text>
        </g>

        <text x=20 y=400 fill="#fff" class="big">System Information</text>
        <text x=60 y=430 fill="#fff" class="big">Faction:</text>
        <text id="infofaction" x=400 y=430 fill="#fff" class="big">Unknown</text>
        <text x=60 y=460 fill="#fff" class="big">Economy:</text>
        <text id="infotrade" x=400 y=460 fill="#fff" class="big">Unknown</text>
        <text x=60 y=490 fill="#fff" class="big">Points of interest:</text>
        <text id="infopoi" x=400 y=490 fill="#fff" class="big">Unknown</text>
        
      </g>
      <g id="game">
        <g filter="url(#g)" id="l1">
          <g id="l10">.</g> <!-- landscape -->
          <g id="l11">.</g> <!-- missiles and targets -->
          <path d="M0 0 H640 V640 H-640 Z" fill="#000" fill-opacity="0.1"/>

          <g id="l12">.</g> <!-- enemies -->
          <path id="ship" d="M0 0" stroke-width="0.2" stroke="#fff" fill-opacity="0"/>
        </g>
      </g>

      <g filter="url(#f1)" id="map">
        <path id="galaxy" filter="url(#f10)" fill="#fff2" d="M-20 355c0-160 125-310 300-310 135 0 245 95 245 230 0 85-65 175-165 175-90 0-135-55-135-125-15 0-25 25-25 50 0 65 80 135 170 135 120 0 250-110 250-275 0-100-50-190-90-240 50 45 130 130 130 270 0 160-125 310-295 310-135 0-245-95-245-230 0-85 65-175 165-175 90 0 135 55 135 125 15 0 25-25 25-50 0-65-80-135-170-135-120 0-250 110-250 275 0 100 50 190 90 240C55 580-20 495-20 355z"/>
        <g id="mapexit" transform="translate(0 0)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000"/>
          <text id="mapexittext"  x=10 y=25 fill="#fff" class="big">&lt; Cancel</text>
        </g>
      </g>
      <text filter="url(#f1)" id="bottomtext" x=10 y=630 fill="#ff0" class="heavy"/>
   
      <path id="vsync" filter="url(#f10)" d="M-10 0 H650 V200 H-640 Z" fill="#303" fill-opacity="0.2" style="pointer-events:none"/>

      <path id="cursor" filter="url(#g)" d="M-10 0 h-30 m40 0 h30 m-35 5 v30 m0 -40 v-30" stroke-width="0.7" stroke="#fff" fill-opacity="0" style="pointer-events:none"/>
      <g style="visibility:hidden">
        <path id="star" d="M-2 -2h2v2h-2z"/>
        <path id="box" d="M-10 -10h20v20h-20z" fill-opacity="0"/>
        <path id="enemybox" d="M0 0"/>
        <path id="mapcell" d="M0 0h15v15h-15z" fill-opacity="0"/>
        <path id="ground" d="M0 0" stroke-width="0.6" stroke="#fff" fill-opacity="0"/>
      </g>
    </g>
  </svg>

  <script>
    // adapted from https://gist.github.com/banksean/304522
    SN = function (t) { null == t && (t = Math), this.g3 = [[1, 1, 0], [-1, 1, 0], [1, -1, 0], [-1, -1, 0], [1, 0, 1], [-1, 0, 1], [1, 0, -1], [-1, 0, -1], [0, 1, 1], [0, -1, 1], [0, 1, -1], [0, -1, -1]], this.p = []; for (var r = 0; r < 256; r++)this.p[r] = Math.floor(256 * t.random()); this.m = []; for (r = 0; r < 512; r++)this.m[r] = this.p[255 & r] }; SN.prototype.n = function (t, r) { var i, h, o = (t + r) * (.5 * (Math.sqrt(3) - 1)), s = Math.floor(t + o), e = Math.floor(r + o), p = (3 - Math.sqrt(3)) / 6, a = (s + e) * p, m = t - (s - a), n = r - (e - a); m > n ? (i = 1, h = 0) : (i = 0, h = 1); var d = m - i + p, f = n - h + p, l = m - 1 + 2 * p, u = n - 1 + 2 * p, M = 255 & s, g = 255 & e, v = this.m[M + this.m[g]] % 12, c = this.m[M + i + this.m[g + h]] % 12, x = this.m[M + 1 + this.m[g + 1]] % 12, N = .5 - m * m - n * n, S = .5 - d * d - f * f, q = .5 - l * l - u * u; return 70 * ((N < 0 ? 0 : (N *= N) * N * dot(this.g3[v], m, n)) + (S < 0 ? 0 : (S *= S) * S * dot(this.g3[c], d, f)) + (q < 0 ? 0 : (q *= q) * q * dot(this.g3[x], l, u))) };
    sn = new SN();

    // adapted from https://www.dwitter.net/d/3078
    _critter_ = _ => {p="";f=m=>p+=`M${((i>>5&1)-X*m/7)} ${(j>>8)-4+Y}h1v1h-1v-1  `;for(j=30;j--;Math.random()>(X**2+(Y-4)**2)**.5/5&&f(7)+f(-7))X=j&3,Y=j>>2&7;return p};

    // decompose a critter into individual 'pixels'
    _decompose_ = o => {
      s = o.getAttribute("d").split("  ");
      for (i=0; i<s.length; ++i) {
        p=o.cloneNode();
        p.removeAttribute("id");
        p.setAttribute("d", s[i]);
        p.d = {x: o.d.x, ry: o.d.ry, r: o.d.r, s: o.d.s, z: o.d.z, dx: o.d.dx + Math.random()*6-3, dy: o.d.dy + Math.random()*6-3, a: 1};
        p.d._update_ = (o, g) => {
          o.d.x += o.d.dx;
          o.d.ry += o.d.dy;
          o.d.y = 250 - o.d.ry + gh * (o.d.z * 2);
          o.d.a-=0.01;
          if (o.d.a<=0)  {
            o.d.dead = true
          };
          o.setAttribute("fill-opacity", o.d.a);
          _update_(o)
        };
        l12.appendChild(p);
        objects.push(p)
      }
    };

    _clamp_ = (i, n, x) => i < n ? n : i > x ? x : i;
    dot = (t, r, i) => t[0] * r + t[1] * i;
    sqr = x => x * x;

    _update_ = o => o.setAttribute("transform", "translate(" + o.d.x + " " + o.d.y + ") rotate(" + o.d.r + ") scale(" + o.d.z + ")");
    _show_ = o => o.removeAttribute("style");
    _hide_ = o => o.setAttribute("style", "visibility:hidden");
    text = o => bottomtext.textContent = o;
    showtitle = _ => { gameloop = false; _hide_(game); _hide_(orbit); _hide_(map); _show_(title); text() };
    showmap = _ => { gameloop = false; _hide_(game); _hide_(orbit); _show_(map); _hide_(title); text() };
    showgame = _ => { gameloop = true; _show_(game); _hide_(orbit); _hide_(map); _hide_(title); text() };
    showorbit = _ => { 
      gameloop = false; _hide_(game); _show_(orbit); _hide_(map); _hide_(title); text(); orbitcoords.textContent = `[${ship.d.mx},${ship.d.my}]`;
      f = factionmap[ship.d.my][ship.d.mx];
      f.visited = true;
      if (f.scanned) {
        infofaction.textContent = factions[f.faction].name;

        orbit_planet.setAttribute("cx", Math.random()*640);
        orbit_planet.setAttribute("cy", Math.random()*640);
        orbit_planet.setAttribute("rx", f.pradius);
        orbit_planet.setAttribute("ry", f.pradius);
        orbit_planet.setAttribute("stroke", f.pcol);
        orbit_moon.setAttribute("cx", Math.random()*640);
        orbit_moon.setAttribute("cy", Math.random()*640);
        orbit_moon.setAttribute("rx", f.mradius);
        orbit_moon.setAttribute("ry", f.mradius);
        orbit_moon.setAttribute("stroke", f.mcol);

        //console.log(f);

        _sci_ = Math.floor(f._sci_ * factions[f.faction]._sci_);
        _trade_ = Math.floor(f._trade_ * factions[f.faction]._trade_);
        _war_ = Math.floor(f._war_ * factions[f.faction]._war_);

        //console.log(_sci_,_trade_,_war_);

        infotrade.textContent = "???";

        /*
        STW
        111 = balanced
        100 = science
        110 = technology
        010 = _trade_
        011 = arms
        001 = warfare
        101 = espionage
        */

        if (_sci_ == _trade_ && _sci_ == _war_) {
          infotrade.textContent = "balanced"
        } else if (_sci_ == _trade_ && _sci_ > _war_) {
          infotrade.textContent = "technology"
        } else if (_sci_ > _trade_ && _sci_ > _war_) {
          infotrade.textContent = "science"
        } else if (_trade_ > _sci_ && _trade_ > _war_) {
          infotrade.textContent = "trade"
        } else if (_trade_ > _sci_ && _trade_ == _war_) {
          infotrade.textContent = "arms"
        } else if (_war_ > _trade_ && _war_ > _sci_) {
          infotrade.textContent = "warfare"
        } else if (_sci_ == _war_ && _war_ > _trade_) {
          infotrade.textContent = "espionage"
        };

        infopoi.textContent = "???"
      } else {
        infofaction.textContent = "Unknown";
        infotrade.textContent = "Unknown";
        infopoi.textContent =  "Unknown"
      };
      updatemap(ship.d.mx, ship.d.my)
    };
    showwarp = _ => showorbit();

    cols = ["#f00", "#f70", "#ff0", "#7f0", "#0f0", "#0f7", "#0ff", "#07f", "#00f", "#70f", "#f0f", "#f07"];
    factionCol = ["#000", "#f0f", "#ff0", "#05f"];
    factions = [
      {name:"Unclaimed",    _sci_:1, _trade_:1, _war_:1},
      {name:"Federation",   _sci_:3, _trade_:6, _war_:1},
      {name:"Union",        _sci_:5, _trade_:4, _war_:1},
      {name:"Empire",       _sci_:1, _trade_:3, _war_:6}
    ];

    items = [
      {name:"Salvage",               _sci_:2, _trade_:2, _war_:1},
      {name:"Luxury goods",          _sci_:4, _trade_:8, _war_:5},
      {name:"Advamced technology",   _sci_:7, _trade_:9, _war_:8},
      {name:"Entertainment devices", _sci_:2, _trade_:6, _war_:2},
      {name:"Mysterious boxes",      _sci_:6, _trade_:3, _war_:1},
      {name:"Small furry creatures", _sci_:5, _trade_:7, _war_:1},
      {name:"Lab grown meat",        _sci_:3, _trade_:2, _war_:4},
      {name:"Exotic weapons",        _sci_:4, _trade_:6, _war_:9},
      {name:"Service robots",        _sci_:5, _trade_:4, _war_:2}//,
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0},
      // {name:"", _sci_:0, _trade_:0, _war_:0}
    ];

    targets = []; shipcell = null;

    objects = []; fxobjects = [];

    mousedown = false;

    fuel = 100;
    warpdistance = 0;

    calcfuel = d => sqr(Math.abs(d.x - ship.d.mx)) + sqr(Math.abs(d.y - ship.d.my));

    title.onclick = _ => showorbit();

    ship.d = { r: 0, x: 320, y: 550, z: 10, mx: 10 + Math.floor(Math.random() * 12), my: 10 + Math.floor(Math.random() * 12) };
    ship.d._update_ = (o, g) => {
      o.d.x = (o.d.x * 0.8 + (320 + (mx * 320)) * 0.2);
      o.d.y = (o.d.y * 0.8 + (400 + (my * 100)) * 0.2);
      gh = 27.5 - (my * 12.5);
      gx -= ((o.d.x - 320) / 3000);
      ship.setAttribute("d", `M${(320 - o.d.x) / 100} ${(o.d.y - 400) / 50} L-5 4 L0 8 L5 4 Z M-5 4 L0 1 L5 4`);
      _update_(o)
    };
    objects.push(ship);
    _update_(ship);

    factionmap = [];

    for (y = 0; y < 32; ++y) {
      factionmap[y] = [];
      for (x = 0; x < 32; ++x) {
        dist=Math.sqrt((x-ship.d.mx)*(x-ship.d.mx)+(y-ship.d.my)*(y-ship.d.my));
        factionmap[y][x] = {
          faction:0, visited: false, scanned: dist<5, 
          pradius: 100+Math.random()*300,
          pcol: cols[Math.floor(Math.random()*cols.length)],    
          mradius: 10+Math.random()*100,
          mcol: cols[Math.floor(Math.random()*cols.length)],
          _sci_:Math.random()*3, _trade_:Math.random()*3, _war_:Math.random()*3
        }
      }
    };

    x = 10 + Math.floor(Math.random() * 22);
    y = 10 + Math.floor(Math.random() * 22);

    for (i = 1; i < 4; ++i) {
      factionSize = 50 + Math.floor(Math.random() * 250);
      while (factionmap[y][x].faction != 0) {
        x = 10 + Math.floor(Math.random() * 22);
        y = 10 + Math.floor(Math.random() * 22)
      };
      factionmap[y][x].faction = i;

      seeds = [];

      seeds.push([x,y]);

      j = 0;
      fail = 0;
      while (j < factionSize && fail < 500) {

        v = seeds[Math.floor(Math.random() * seeds.length)];

        x = _clamp_( v[0] - 5 + Math.floor(Math.random() * 10), 0, 31);
        y = _clamp_( v[1] - 5 + Math.floor(Math.random() * 10), 0, 31);

        if (factionmap[y][x].faction == 0) {
          factionmap[y][x].faction = i;
          seeds.push([x,y]);
          ++j
        } else {
          fail++
        }
      }
    };

    _textwidget_ = (e, t, f) => {
      e.onmouseenter = _ => t.setAttribute("fill", "#990");
      e.onmouseleave = _ => t.setAttribute("fill", "#fff");
      e.onclick = _ => f()
    };

    _textwidget_(orbitmap, orbitmaptext, _ => showmap() );
    _textwidget_(orbitscan, orbitscantext, _ => { 
      factionmap[ship.d.my][ship.d.mx].scanned = true; 
      updatemap(ship.d.mx, ship.d.my);
      showorbit() 
    });
    _textwidget_(orbitenter, orbitentertext, _ => showgame() );
    _textwidget_(mapexit, mapexittext, _ => showorbit() );

    updatemap = (x,y) => {
      if (factionmap[y][x].scanned) {
        factionmap[y][x].mapcell.setAttribute("fill", factionCol[factionmap[y][x].faction]);
        factionmap[y][x].mapcell.setAttribute("fill-opacity", factionmap[y][x].visited ? "0.6" : "0.25")
      }
    };

    lrs = (x,y,r) => {
      for (y1=_clamp_(y-r,0,31); y1<_clamp_(y+r,0,31); ++y1) {
        for (x1=_clamp_(x-r,0,31); x1<_clamp_(x+r,0,31); ++x1) {
          if (dist <= Math.sqrt(sqr(x-x1)+sqr(y-y1))) { 
            factionmap[y1][x1].scanned=true;
            updatemap(x1,y1) 
          }
        }
      }
    };

    // build map
    for (y = 0; y < 32; ++y) {
      for (x = 0; x < 32; ++x) {
        o = mapcell.cloneNode();
        o.d = { x: x, y: y };

        if (x == ship.d.mx && y == ship.d.my) {
          o.setAttribute("stroke", "#ff0");
          shipcell = o
        } else {
          o.setAttribute("stroke", "#fff2")
        };

        factionmap[y][x].mapcell = o;
        
        updatemap(x,y);

        o.removeAttribute("id");
        o.setAttribute("transform", "translate(" + ((x * 18) +32) + " " + ((y * 18) + 34) + ")");
        o.onmouseenter = _ => {
          fuelneed = calcfuel(_.target.d);
          text("Warp requires " + fuelneed + "mgb.  Fuel available: " + fuel + "mgb");
          if (fuelneed <= fuel) {
            _.target.setAttribute("stroke", "#fff")
          } else {
            _.target.setAttribute("stroke", "#f00")
          }

        };
        o.onmouseleave = _ => {
          if (_.target.d.x == ship.d.mx && _.target.d.y == ship.d.my) {
            _.target.setAttribute("stroke", "#ff0")
          } else {
            _.target.setAttribute("stroke", "#fff2")
          }
        };
        o.onclick = _ => {
          fuelneed = calcfuel(_.target.d);
          if (fuelneed <= fuel) {
            fuel -= fuelneed;
            warpdistance = fuelneed * 100;
            ship.d.mx = _.target.d.x;
            ship.d.my = _.target.d.y;
            _.target.setAttribute("stroke", "#ff0");
            shipcell.setAttribute("stroke", "#fff2");
            shipcell = _.target;
            showwarp()
          }
        };

        map.appendChild(o)
      }
    };

    // // build stars
    // for(i=0; i<200; ++i) {
    //   o=star.cloneNode();
    //   o.setAttribute("fill", cols[i%cols.length]);
    //   o.removeAttribute("id");
    //   o.d = { r: Math.random(), x: 300 + (Math.random() * 40), y: 300 + (Math.random() * 40), z: 0.1 };

    //   o.d._update_ = (o,g)=> {
    //     m = 1.1 + ((Math.abs(o.d.x - 320)) / 500);
    //     o.d.z += m / 10;
    //     o.d.r += 1;
    //     o.d.x = ((o.d.x - 320) * m) + 320;
    //     o.d.y = ((o.d.y - 320) * m) + 320;
    //     if (o.d.x < 0 || o.d.x > 640 || o.d.y < 0 || o.d.y > 640) {
    //       o.d.x = 305 + (Math.random() * 30);
    //       o.d.y = 305 + (Math.random() * 30);
    //       o.d.z = 0.5
    //     };
    //     _update_(o)
    //   };

    //   objects.push(o);
    //   l0.insertBefore(o, l0.firstChild)
    // };

    // target boxes
    for (i = 0; i < 8; ++i) {
      o = box.cloneNode();
      o.setAttribute("stroke", "#fff");
      o.setAttribute("stroke-width", "0.3");
      o.removeAttribute("id");
      o.d = { r: 90, x: -200, y: -200, z: 1, t: null };
      o.d._update_ = (o, g) => {
        if (mousedown || missiletime > 0) {
          if (o.d.t) {
            o.d.x = o.d.t.x;
            o.d.y = o.d.t.y;
            o.d.r = o.d.r * 0.75;
            o.d.z = (4 + o.d.z) / 2
          }
        } else {
          if (o.d.t != null) {
            if (maxmissiles - missiles > 0) {
              if (missiletime == 0) {
                m = firemissile();

                m.d.x = ship.d.x;
                m.d.y = ship.d.y;
                m.d.t = o.d.t;
                m.d.to = o.d.to;

                o.d.t = null;
                o.d.x = -100;
                o.d.y = -100;
                targets.push(o)
              }
            }
          }
        };
        _update_(o)
      };
      targets.push(o);
      _update_(o);
      l11.appendChild(o)
    };

    firemissile = _ => {
      missiles++;

      o = box.cloneNode();
      o.setAttribute("stroke", "#fff");
      o.setAttribute("stroke-width", "2");
      o.removeAttribute("id");
      o.d = { r: 0, x: -200, y: -200, z: 1, t: null, f:0 };
      o.d._update_ = (o, g) => {
        if (o.d.t && !o.d.t.dead) {
          o.d.x = (o.d.x * 0.85) + (o.d.t.x * 0.15);
          o.d.y = (o.d.y * 0.85) + (o.d.t.y * 0.15);
          o.d.z = o.d.z * 0.95;
          o.d.f++;

          if (o.d.z < 0.001) {
            o.d.dead = true
          };

          if (o.d.f > 20 && (Math.abs(o.d.x - o.d.t.x) + Math.abs(o.d.y - o.d.t.y)) < 50) {
            _explosion_();
            o.d.dead = true;
            o.d.t.dead = true;
            _decompose_(o.d.to);

            enemies--;
            missiles--
          };

          _update_(o)
        }
      };

      _update_(o);
      l11.appendChild(o);

      objects.push(o);
      _shoot_();

      missiletime = 4;

      return o
    };

    wavecount = 0;
    enemies = 0;
    missiles = 0;
    maxmissiles = 8;
    targetc = 0;
    wavetime = 100;
    shields = 100;

    enemywave1 = _ => {
      // enemy box things
      _wave1_();
      s = 0.1;
      wavecount++;

      r = Math.floor(Math.random()*10);

      for (i = 0; i < wavecount*2; ++i) { 
        o = enemybox.cloneNode();
        o.removeAttribute("id");
        
        o.setAttribute("d", _critter_());
        o.setAttribute("fill",cols[(i+r) % cols.length]);

        o.onmouseenter = _ => {
          if (mousedown && shields>0) {
            if (targets.length > 0) {
              t = targets.pop();
              t.d.t = _.target.d;
              t.d.to = _.target;
              t.d.z = 1000;
              t.d.r = 90;
              objects.push(t);
              _lock_(700 + (50 * targetc));
              _.target.onmouseenter = null;
              targetc++
            }
          }
        };

        o.d = { r: 0, x: Math.random() * 640, ry: Math.random() * 640, s: s += 0.0005, z: 0.1, dx:0, dy:0 };

        o.d._update_ = (o, g) => {
          o.d.dx = o.d.x;
          o.d.dy = o.d.ry;
          
          o.d.x = (o.d.x * (1 - o.d.s)) + (g.x * o.d.s);
          o.d.ry = (o.d.ry * (1 - o.d.s)) + (g.y * o.d.s);

          o.d.dx = o.d.x - o.d.dx;
          o.d.dy = o.d.ry - o.d.dy;

          o.d.z = (o.d.z * 0.95) + (5.0 + Math.sin(n - (o.d.s * 500))) * 0.05;

          if (Math.random() * 1000 < wavecount*10) {
            zap = ground.cloneNode();
            zap.removeAttribute("id");
            p="M0 0";
            for (k=1; k<65; k++) {
              p+= ` L${(Math.random()*k*2)-k} ${k*10}`
            };
            zap.setAttribute("d", p);
            zap.d = {x: o.d.x, y: o.d.y, r:0, s:1, z:1, dead: true};
            zap.d._update_ = _ => {};
            objects.push(zap);
            _update_(zap);
            l12.appendChild(zap);
            
            if (Math.abs(o.d.x - ship.d.x) < 25) { 
              shields--;
              _shields_()
            } else {
              _zap_()
            }
          };

          if (!o.d.dead) {
            o.d.y = 250 - o.d.ry + gh * (o.d.z * 2);
            g.x = o.d.x;
            g.y = o.d.ry
          } else {
            o.d.y = -100
          };
          _update_(o)
        };

        objects.push(o);
        enemies++;
        l12.appendChild(o)
      }
    };


    // landscape
    slices = 20;
    div = 10;
    for (i = 0; i < slices; ++i) {
      o = ground.cloneNode();
      o.removeAttribute("id");
      o.d = { i: i + 2 };
      o.d._update_ = (o, g) => {
        s = "";
        for (x = 0; x <= 64; ++x) {
          rx = ((32 - x) * ((slices + 1 - o.d.i) / 10)) / div;

          hz = g.sn.n(g.gx + rx, (o.d.i + g.gy) / div);
          sq = o.d.i * o.d.i;
          s += x == 0 ? "M" : "L";
          s += `${x * 10} ${(100 - (gh * 3)) + ((gh / slices) * sq) + (hz * sq / 2)}`
        };
        o.setAttribute("d", s);
        o.setAttribute("stroke", factionmap[ship.d.my][ship.d.mx].pcol);
        l10.appendChild(o)
      };
      objects.push(o)
    };

    missiletime = 0;
    gameloop = false;
    warpdistance = 10000;

    focus = true;
    window.onfocus = _ => focus = true;
    window.onblur = _ => focus = false;
    n = 0;

    cursor.d = { r: 0, x: 320, y: 320, z: 1 };
    cursor.d._update_ = (o, g) => {
      o.d.x = 320 + (mx * 320);
      o.d.y = 320 + (my * 320);
      _update_(o)
    };
    fxobjects.push(cursor);
    _update_(cursor);

    vsync.d = { r: 0, x: 0, y: 0, z: 1 };
    vsync.d._update_ = (o, g) => {
      o.d.y += 16;
      if (o.d.y > 640) o.d.y = -200;
      _update_(o)
    };
    fxobjects.push(vsync);

    showtitle();
    //showmap();
    //showgame();
    //showorbit();

    c.onmousedown = _ => {
      focus = true;
      mousedown = gameloop
    };
    c.onmouseup = _ => {
      if (gameloop) {
        mousedown = false;
        missiletime = 0;
        targetc = 0
      }
    };

    mx = 0;
    my = 0;
    rect = c.getBoundingClientRect();

    window.onresize = _ => rect = c.getBoundingClientRect();

    c.onmousemove = _ => {
      size = Math.min(rect.width, rect.height) / 2;
      mx = _clamp_(((_.clientX - rect.left) - (rect.width / 2)) / size, -1, 1);
      my = _clamp_(((_.clientY - rect.top) - (rect.height / 2)) / size, -1, 1)
    };

    gx = 100;
    gy = 0;
    gh = 10;

    // Game loop
    setInterval(_ => {
      if (!focus) return;

      fxobjects.forEach(o => {
        o.d._update_(o, g)
      });

      if (!gameloop) return;

      //if (warpdistance <= 0) showmap();

      n += 0.025;
      //warpdistance -= 1;
      gy -= 1;
      if (missiletime > 0) missiletime--;

      g = {
        x: 320 + (Math.sin(n) * 150),
        y: 200 + (Math.cos(n) * 150),
        gy: gy,
        gx: gx,
        gh: gh,
        sn: sn
      };

      objects2 = objects;
      objects = [];

      objects2.forEach(o => {
        o.d._update_(o, g);
        if (o.d.dead) {
          o.remove() 
        } else {
          objects.push(o)
        }
      });

      //console.log(objects.length);

      if (enemies == 0) {
        wavetime--;
        if (wavetime == 0) {
          wavetime = 25;
          enemywave1()
        }
      };

      if (shields > 0) {
        text(`shields: ${shields}%`)
      } else {
        text("G A M E O V E R");
        ship.d.dead=true;
        _dead_();
        shields = 0
        //focus = false
      }


    }, 50);

    _lock_ = f => zzfx(...[, , f, .02, , .08, 1, 1.19, 11, , -344, .02, , , , , , .04, .02]); 
    _explosion_ = _ => zzfx(...[, , 585, .01, .23, .21, 4, 4.87, , , , , , .4, , .3, , .76, .13, .44]); 
    _shoot_ = _ => zzfx(...[, , 169, .02, , .24, 1, .77, .2, , , , , 2.1, , .1, , .93, .09, .02]); 
    _wave1_ = _ => zzfx(...[, , 388, .38, .4, .66, , 1.46, .5, -3.8, 4, .02, .15, , , , , .61, .02]); 
    _shields_ = _ => zzfx(...[,,603,.02,,.14,4,1.36,-0.6,.5,,,,,,,.05,.68,.08,.39]); 
    _zap_ = _ => zzfx(...[,,409,.02,,.21,,.64,-0.4,.3,,,,,,,.2,.61,.05,.21]);
    _dead_ = _ => zzfx(...[,,533,,3,3,3,3.49,.5,.4,,,,.6,.2,.2,,.6,1]); 

    zzfxV = .3;    // volume
    zzfx =       // play sound
      (E = 1, k = .05, p = 220, d = 0, t = 0, u = .1, q = 0, F = 1, v = 0, G = 0, y = 0, H = 0, g = 0, z = 0, A = 0, I = 0, c = 0, w = 1, l = 0, B = 0) => { d = 99 + d * zzfxR; t *= zzfxR; u = 99 + u * zzfxR; l *= zzfxR; c *= zzfxR; g = g * zzfxR | 0; let b = 2 * Math.PI, h = d + l + t + u + c | 0, J = v *= 500 * b / zzfxR ** 2, Z = p *= (1 + 2 * k * Math.random() - k) * b / zzfxR, K = (0 < A ? 1 : -1) * b / 4, f = 0, C = 0, a = 0, L = 0, M = 0, e = 0, m = 1, x = [], n, r = zzfxX.createBufferSource(), D = zzfxX.createBuffer(1, h, zzfxR); for (r.connect(zzfxX.destination); a < h; x[a++] = e)++M % (100 * I | 0) || (e = q ? 1 < q ? 2 < q ? 3 < q ? Math.sin((f % b) ** 3) : Math.max(Math.min(Math.tan(f), 1), -1) : 1 - (2 * f / b % 2 + 2) % 2 : 1 - 4 * Math.abs(Math.round(f / b) - f / b) : Math.sin(f), e = (0 < e ? 1 : -1) * Math.abs(e) ** F * (g ? 1 - B + B * Math.sin(2 * Math.PI * a / g) : 1) * E * zzfxV * (a < d ? a / d : a < d + l ? 1 - (a - d) / l * (1 - w) : a < d + l + t ? w : a < h - c ? (h - a - c) / u * w : 0), e = c ? e / 2 + (c > a ? 0 : (a < h - c ? 1 : (a - h) / c) * x[a - c | 0] / 2) : e), n = (p += v += 500 * G * b / zzfxR ** 3) * Math.sin(C * A * b / zzfxR - K), f += n - n * z * (1 - 1E9 * (Math.sin(a) + 1) % 2), C += n - n * z * (1 - 1E9 * (Math.sin(a) ** 2 + 1) % 2), m && ++m > H * zzfxR && (p += y * b / zzfxR, Z += y * b / zzfxR, m = 0), !g || ++L % g || (p = Z, v = J, m = m || 1); D.getChannelData(0).set(x); r.buffer = D; r.start(); return r }; zzfxX = new window.AudioContext; zzfxR = 44100

  </script>
</body>