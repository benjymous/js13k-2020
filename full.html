<meta name="monetization" content="$ilp.uphold.com/qEBzYpLKbWr2">

<body style="background: #000;cursor: none">
<!-- 
BUGS

recharge shields / fuel somehow?

-->
  <!--
  ///#define _decompose_ d_
  ///#define _update_ u_
  ///#define _show_ s_
  ///#define _hide_ h_
  ///#define _textwidget_ t_
  ///#define _addMenu_ am
  ///#define _hideMenu_ hm
  ///#define _endMenu_ em
  ///#define _critter_ a_
  ///#define _dead_ d_
  ///#define _items_ it_
  ///#define _temp_ p
  ///#define _objects_ $
  ///#define _fxobjects_ $_

  ///#define _tutorialtext_ e_
  ///#define _crawltext_ v_
  ///#define _places_ w_
  ///#define _factions_ x_
  ///#define _endtext_ y_

  ///#define _getWeighted_ az
  ///#define _showmap_ bz
  ///#define _showorbit_ cz
  ///#define _showgame_ dz
  ///#define _updatemap_ ez
  ///#define _showtitle_ fz
  ///#define _showwarp_ gz
  ///#define _calcfuel_ hz
  ///#define _clamp_ iz
  ///#define _showtrade_ lz
  ///#define _entersystem_ mz
  ///#define _calcdistance_ nz
  ///#define _enemywave_ oz
  ///#define _inventory_ pz
  ///#define _cleartemp_ qz
  ///#define _doTarget_ rz
  ///#define _sqr_ sz
  ///#define _doZap_ tz
  ///#define _makeCritter_ uz
  ///#define _firemissile_ vz
  ///#define _itemvalue_ wz

  ///#define _place_ p
  ///#define _visited_ v
  ///#define _explored_ e
  ///#define _scanned_ n
  ///#define _economy_ t

  ///#define _factionmap_ fmp

  ///#define _lock_ fx1
  ///#define _explosion_ fx2
  ///#define _shoot_ fx3
  ///#define _wave1_ fx4
  ///#define _zap_ fx5
  ///#define _shields_ fx6
  ///#define _gameover_ fx7
  ///#define _gowarp_ fx8
  ///#define _inwarp_ fx9
  ///#define _blip_ fxA
  ///#define _running_ fxB
  ///#define _alert_ fxC
  ///#define _upgrade_ fxD
  ///#define zzfx fx

  ///#define _songdata_ fx0

  ///#define _sci_ x
  ///#define _trade_ y
  ///#define _war_ z
  ///#define _salvage_ s
  ///#define _research_ r
  -->

  <svg id="c" viewBox="0 0 640 640" style="position:absolute;top:0;left:0;height:100%;width:100%">
    <style>      
      .t0 {
        font: 20px monospace;
      }
      .t1 {
        font: 25px monospace;
      }
      .t2 {
        font: 40px monospace;
      }
      .a{fill:#000;stroke:#ffa;}.b{fill:#0ff;}.c{fill:#ffa;}.d{fill:#fe9;}.e{fill:#fff;}
    </style>
    <clipPath id="clip">
      <path d="M0 0h640v640H0z"/>
    </clipPath>
    <filter id="g" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="z1"/>
      <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="z2"/>
      <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="z3"/>
      <feMerge>
        <feMergeNode in="z1"/>
        <feMergeNode in="z2"/>
        <feMergeNode in="z3"/>
      </feMerge>
    </filter>
    <filter id="f1" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1"/>
    </filter>
    <filter id="f3" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="3"/>
    </filter>
    <filter id="f10" filterUnits="userSpaceOnUse">
      <feGaussianBlur in="SourceGraphic" stdDeviation="10"/>
    </filter>

    <g clip-path="url(#clip)">

      <g id="orbit" filter="url(#f1)">

        <circle fill="#000" stroke-width="1.5" id="orbit_planet"/>
        <circle fill="#000" stroke-width="1.5" id="orbit_moon"/>

        <text x=20 y=40 fill="#fff" class="t1">Currently in orbit at</text>
        <text id="orbitcoords" x=400 y=40 fill="#fff" class="t1">[0:0]</text>

        <text x=20 y=500 fill="#fff" class="t1">System Information</text>
        <text x=60 y=530 fill="#fff" class="t1">Faction:</text>
        <text id="infofaction" x=300 y=530 fill="#fff" class="t1"/>
        <text x=60 y=560 fill="#fff" class="t1">Economy:</text>
        <text id="infotrade" x=300 y=560 fill="#fff" class="t1"/>
        <text x=60 y=590 fill="#fff" class="t1">Discovery:</text>
        <text id="infopoi" x=300 y=590 fill="#fff" class="t1"/>
      </g>
      <g id="base" filter="url(#f1)">
        <circle id="base_moon" stroke="#fff" stroke-width="1.5" fill="#000"/>
        <ellipse id="base_planet" stroke="#fff" ry="200" rx="500" cy="478" cx="320" stroke-width="1.5" fill="#000"/>

        <path id="base_sc1" stroke-width="1.5" stroke="#555" d="M0 350L150 350C145 250 140 185 140 160C140 156 135 150 130 150C130 150 130 150 130 150C130 150 130 150 130 150C130 145 135 140 140 140C158 140 202 140 220 140C225 140 230 145 230 150C230 150 230 150 230 150C230 150 230 150 230 150C225 150 220 155 220 160C220 185 215 250 210 350L680 350L680 750L-320 750L-320 350Z"></path>
        <path id="base_sc2" stroke-width="1.5" stroke="#888" d="M0 300L275 300L275 360L285 360L285 310L315 310L315 380L325 380L325 290L425 300L425 340L575 340L575 440L585 440L585 240L635 240L635 370L655 370L655 320L755 310L755 340L765 340L765 300L825 300L825 360L830 360L830 260L1050 260L1050 660L50 660L50 300Z"></path>
        <path id="base_sc3" stroke-width="1.5" stroke="#bbb" d="M0 310L40 310L40 410L130 410L130 374L200 374L200 424L385 424L385 334L445 314L445 354L470 354L470 414L510 414L510 314L560 314L560 444L580 444L580 394L590 399L590 429L600 429L600 389L620 389L620 449L665 449L665 349L845 349L845 749L-155 749L-150 310Z"></path>
        <path id="base_sc4" stroke-width="1.5" stroke="#eee" d="M0 480L290 480C295 445 300 425 300 415C300 405 305 400 315 395C320 390 330 390 335 385C345 380 355 380 360 385C370 390 380 390 385 395C395 400 400 405 400 415C400 425 405 445 410 480L850 480L850 880L-150 880L-150 480Z"></path>
        <path id="base_sc5" stroke-width="1.5" stroke="#888" d="M0 655C-45 650 295 655 855 660 L860 420L750 410L730 400L725 385L705 390L695 360L685 350L645 410L610 410L585 400L510 415L490 400L465 385L450 410L415 425L380 400L355 390L330 370L315 400L310 410L265 405L245 390L185 410L155 400L140 390L115 410L50 380L35 415L5 400-30 415L-150 405"></path>

        <text x=20 y=40 fill="#fff" class="t1">Discovered</text>
        <text id="tradename" x=200 y=40 fill="#fff" class="t1">???</text> 
      </g>
      <g id="game">
        <g filter="url(#g)" id="l1">
          <g id="l10">.</g> <!-- landscape -->
          <g id="l11">.</g> <!-- missiles and targets -->
          <path d="M0 0 H640 V640 H-640 Z" fill="#000" fill-opacity="0.1"/>

          <g id="l12">.</g> <!-- enemies -->
          <g id="ship">
            <path id="shipd" d="M0 0" stroke-width="0.2" stroke="#fff" fill-opacity="0"/>
            <circle id="ships" x="0" y="0" r="6" stroke="#00f" stroke-width="0.2" fill-opacity="0.3" fill="#00f" transform="translate(0,4)"/>
          </g>
          

          <path id="combocount" stroke-width="1" stroke="#fff" fill-opacity="0"/>
          <text id="combocounttext" x=550 y=90 fill="#fff" class="t2" text-anchor="middle"/>
          <text id="tutorial" x=320 y=250 fill="#fff" class="t2" text-anchor="middle" style="pointer-events:none"/>


        </g>
      </g>

      <g filter="url(#f1)" id="map">
        <path id="galaxy" filter="url(#f10)" fill="#fff1" d="M-20 355c0-160 125-310 300-310 135 0 245 95 245 230 0 85-65 175-165 175-90 0-135-55-135-125-15 0-25 25-25 50 0 65 80 135 170 135 120 0 250-110 250-275 0-100-50-190-90-240 50 45 130 130 130 270 0 160-125 310-295 310-135 0-245-95-245-230 0-85 65-175 165-175 90 0 135 55 135 125 15 0 25-25 25-50 0-65-80-135-170-135-120 0-250 110-250 275 0 100 50 190 90 240C55 580-20 495-20 355z"/>
        <g id="mapexit" transform="translate(0 0)">
          <path d="M0 0 h640 v30 h-640 z" fill="#000"/>
          <text x=10 y=25 fill="#fff" class="t1">&lt; Cancel</text>
        </g>
      </g>

      <g id="title" filter="url(#f1)">
       <path d="M0 0 h640 v640 h-640 z" fill="#000"/>
       <path class="a" d="m0 404l306 -161c34 -18 67 -39 98 -62c15 -11 -9 7 0 0c49 -38 89 -85 118 -139l21 -41"/>
       <path class="a" d="m-2 181l235 -133c26 -14 55 -23 85 -24l132 -5c14 0 23 16 15 27l-47 68c-19 29 -45 52 -74 70l-340 200"/>
       <path class="b" d="m572 422a95 95 0 1 1 0 -190a95 95 0 0 1 0 190z"/>
       <path d="m328 704c-215 0 -390 -67 -390 -150s175 -150 390 -150s390 67 390 150s-175 150 -390 150z"/>
       <path fill="#f00" d="m328 704c-215 0 -390 -67 -390 -150s175 -150 390 -150s390 67 390 150s-175 150 -390 150z"/>
      
       <path class="c" d="m360 143c32 -20 59 -46 79 -77l19 -29l0 -14c0 -4 -5 -5 -7 -2a2962 2962 0 0 1 -4 9c-27 45 -65 83 -110 110l-198 120l-58 56l279 -173z"/>
       <path stroke="#ffa"  d="m-2 370l139 -85c16 -12 51 -88 51 -88c-2 -2 -10 -3 -26 -3c-20 0 -40 5 -57 16l-107 64"/>
       <path class="c" d="m138 272l-29 0l-130 60l10 40l149 -100z"/>
       <path class="a" d="m147 274l1 -2l26 -46l11 -23l-34 -1c-10 -1 -19 2 -28 7l-36 19c-3 1 -3 4 -2 6l22 36c3 4 7 7 12 7l18 1c4 1 7 -1 10 -4z"/>
       <path d="m283 213c-44 -32 -83 -71 -115 -115l-2 -2l-17 9l12 17a397 397 0 0 0 107 99l15 -8z"/>
       <path class="a" d="m283 213c-44 -32 -83 -71 -115 -115l-2 -2l-17 9l12 17a397 397 0 0 0 107 99l15 -8z"/>
       <path d="m158 307c-4 15 3 31 18 37l6 3l-164 83c-6 3 -14 3 -20 0l-3 -2c-4 -2 -5 -7 -3 -12c2 -2 -1 2 0 0c6 -8 13 -15 21 -20l145 -89z"/>
       <path class="a" d="m158 307c-4 15 3 31 18 37l6 3l-164 83c-6 3 -14 3 -20 0l-3 -2c-4 -2 -5 -7 -3 -12c2 -2 -1 2 0 0c6 -8 13 -15 21 -20l145 -89z"/>
       <path stroke="#fe9" d="m82 44c-22 -4 -37 -22 -37 -44l1 -9l-205 148c-8 6 -13 15 -12 25l1 4c0 7 6 12 13 11l2 0c13 -1 26 -6 38 -13l201 -121l-2 -1z"/>
       <path d="m187 347c-6 4 -18 -1 -27 -13c-8 -11 -10 -25 -3 -29c6 -5 19 0 27 12s10 25 3 30z"/>
       <path class="c" d="m187 347c-6 4 -18 -1 -27 -13c-8 -11 -10 -25 -3 -29c6 -5 19 0 27 12s10 25 3 30z"/>
       <path class="d" d="m93 42c-10 8 -28 0 -40 -16s-13 -36 -3 -44c11 -7 29 0 41 17c12 16 13 36 2 43z"/>
       <path class="a"  d="m322 187c-44 -32 -83 -71 -115 -114l-2 -3l-17 9l12 17c27 37 60 68 98 94c2 0 4 2 9 6l15 -9z"/>
       <path class="a" d="m365 162a534 534 0 0 1 -118 -117l-17 10l13 16a397 397 0 0 0 107 100l15 -9z"/>
       <path d="m578 432c-54 0 -97 -43 -97 -97a97 97 0 0 1 195 0c0 54 -44 97 -98 97z"/>
       <path class="e" d="m380 247l-4 2l1 5l-3 -5l-6 1l5 -3l-1 -6l3 6l5 0z"/>
       <path d="m350 734c-215 0 -390 -73 -390 -163c0 -89 175 -162 390 -162s390 73 390 162c0 90 -175 163 -390 163z"/>
       <path class="e" d="m388 265l-5 -3l-3 4l2 -5l-4 -4l5 2l4 -5l-3 7l4 4z"/>
       <path class="e" d="m349 289l-5 -2l-2 4l1 -5l-4 -4l5 2l3 -5l-1 7l3 3z"/>
       <path class="e" d="m389 335l-5 -1l-1 5l-1 -5l-5 -3l5 0l2 -5l1 7l4 2z"/>
       <path class="e" d="m565 124l-5 0l-1 5l0 -6l-5 -2l5 0l2 -6l0 7l4 2z"/>
       <path class="e" d="m269 368l-5 1l1 5l-2 -5l-6 0l5 -2l0 -6l2 6l5 1z"/>
       <path class="e" d="m555 58l-5 2l1 5l-2 -5l-6 -1l5 -2l0 -6l2 7l5 0z"/>
       <path class="e" d="m453 392l-4 -3l-3 3l2 -4l-3 -5l5 3l4 -4l-3 6l2 4z"/>
       <path class="c" d="m248 185l-18 9l-12 -9l18 -11l12 11z"/>
       <path class="c" d="m288 161l-17 9l-12 -9l18 -12l11 12z"/>
       <path class="c" d="m330 136l-17 9l-12 -9l17 -12l12 12z"/>
       <path class="c" d="m165 232l1 -8c1 -4 -3 -6 -6 -4l-9 6l-28 32l-14 15c-2 2 -1 5 2 5l16 2l38 -48z"/>
       <path class="c" d="m172 343l-9 -13l-179 109l188 -96z"/>
       <path class="d" d="m68 32l-12 -25l-214 167l226 -142z"/>

 
       <!--
       <path class="e" d="m72 480l3 0l0 16l6 -6l7 0l5 5l0 20l-3 0l0 -19l-3 -3l-5 0l-7 7l0 15l-3 0l0 -35zm142 10l0 32l-4 4l-12 0l-4 -3l0 -3l3 0l0 2l2 2l10 0l2 -3l0 -10l-5 4l-9 0l-4 -4l0 -16l4 -5l10 0l4 5l0 -5l3 0zm36 0l3 0l0 6l5 -6l8 0l4 5l0 20l-3 0l0 -19l-2 -3l-6 0l-6 7l0 15l-3 0l0 -25zm135 11l-11 -21l3 0l10 18l10 -18l3 0l-12 21l0 14l-3 0l0 -14zm-285 10l0 -16l4 -5l13 0l4 5l0 9l-18 0l0 6l3 3l9 0l3 -3l0 -2l3 0l0 3l-4 4l-13 0l-4 -4zm65 0l0 -16l5 -5l12 0l4 5l0 9l-18 0l0 6l3 3l10 0l3 -3l0 -2l2 0l0 3l-4 4l-12 0l-5 -4zm57 0l0 -16l4 -5l12 0l5 5l0 9l-18 0l0 6l2 3l10 0l3 -3l0 -2l3 0l0 3l-5 4l-12 0l-4 -4zm178 0l0 -16l5 -5l12 0l4 5l0 9l-18 0l0 6l3 3l9 0l3 -3l0 -2l3 0l0 3l-4 4l-12 0l-5 -4zm-123 0l0 -16l5 -5l9 0l5 4l0 -14l2 0l0 35l-2 0l0 -5l-5 5l-9 0l-5 -4zm-224 -28l-10 0l0 -3l24 0l0 3l-11 0l0 32l-3 0l0 -32zm296 10l-5 0l0 -3l5 0l0 -5l4 -4l6 0l0 2l-5 0l-3 3l0 4l8 0l0 3l-8 0l0 22l-2 0l0 -22zm-209 -13l3 0l0 33l18 0l0 2l-21 0l0 -35zm354 28l-18 0l0 -5l16 -23l5 0l0 25l4 0l0 3l-4 0l0 7l-3 0l0 -7zm58 0l-17 0l0 -5l15 -23l5 0l0 25l4 0l0 3l-4 0l0 7l-3 0l0 -7zm-121 3l0 -18l-5 0l0 -3l5 0l0 -8l2 0l0 8l8 0l0 3l-8 0l0 17l3 3l5 0l0 2l-6 0l-4 -4zm75 0l0 -26l5 -5l14 0l5 5l0 26l-5 4l-14 0l-5 -4zm18 2l3 -3l0 -24l-3 -3l-12 0l-3 3l0 24l3 3l12 0zm-206 -2l0 -16l4 -5l13 0l4 5l0 16l-4 4l-13 0l-4 -4zm15 2l3 -3l0 -14l-3 -3l-10 0l-2 3l0 14l2 3l10 0zm161 -8l0 -22l-1 0l-14 20l0 2l15 0zm58 0l0 -22l-14 20l0 2l14 0zm-262 8l6 -6l0 -9l-6 -5l-7 0l-3 3l0 14l3 3l7 0zm-79 -14l-5 -6l-7 0l-3 3l0 14l3 3l7 0l5 -5l0 -9zm237 -9l3 0l0 25l-3 0l0 -25zm-330 11l0 -5l-3 -3l-9 0l-3 3l0 5l15 0zm66 0l0 -5l-3 -3l-10 0l-3 3l0 5l16 0zm56 0l0 -5l-3 -3l-10 0l-2 3l0 5l15 0zm178 0l0 -5l-2 -3l-10 0l-3 3l0 5l15 0zm40 1l14 0l0 2l-14 0l0 -2zm-11 -17l0 -2l1 -2l2 0l1 2l0 2l-1 1l-2 0l-1 -1z"/>
       <path class="e" d="m458 523l0 4l2 0l0 1l-3 0l0 4l-1 0l0 -4l-3 0l-1 4l-1 0l1 -4l-3 0l0 -1l3 0l0 -4l-2 0l0 -1l3 0l0 -4l1 0l0 4l3 0l1 -4l1 0l-1 4l3 0l0 1l-3 0zm27 7l0 -1l1 0l0 1l1 1l5 0l1 -1l0 -3l-1 -2l-4 0l0 -1l4 0l1 -1l0 -3l-1 -1l-5 0l-1 1l0 1l-1 0l0 -1l2 -2l5 0l2 2l0 4l-1 1l1 1l0 4l-2 2l-5 0l-2 -2zm26 0l8 -8l0 -2l-1 -1l-4 0l-2 1l0 1l-1 0l0 -1l2 -2l5 0l2 2l0 2l-7 8l0 1l7 0l0 1l-9 0l0 -2zm24 0l7 -8l0 -2l-1 -1l-4 0l-1 1l0 1l-1 0l0 -1l1 -2l5 0l2 2l0 2l-7 8l0 1l7 0l0 1l-8 0l0 -2zm-67 0l0 -1l1 0l0 1l1 1l4 0l1 -1l0 -2l-1 -1l-5 0l-1 -1l0 -2l2 -2l4 0l2 2l0 1l-2 0l0 -2l-4 0l-1 1l0 2l1 1l4 0l2 1l0 2l-2 2l-5 0l-1 -2zm29 -12l1 0l0 8l3 0l3 -4l1 0l-4 5l4 5l-1 0l-3 -5l-3 0l0 5l-1 0l0 -14zm26 12l0 -10l1 -2l6 0l2 2l0 10l-2 2l-6 0l-1 -2zm23 0l0 -10l2 -2l5 0l2 2l0 10l-2 2l-5 0l-2 -2zm-65 -11l-3 2l0 -1l3 -2l1 0l0 14l-1 0l0 -13zm-20 16l2 0l1 -1l0 -12l1 0l0 13l-2 1l-2 0l0 -1zm69 -4l1 -1l0 -10l-1 -1l-5 0l-1 1l0 10l1 1l5 0zm23 0l1 -1l0 -10l-1 -1l-5 0l-1 1l0 10l1 1l5 0zm-96 -8l-3 0l-1 4l3 0l1 -4zm7 -3l0 -2l1 0l0 2l-1 0z"/>
       <path class="e" d="m538 597l3 0l9 23l9 -23l3 0l0 28l-2 0l0 -24l-9 21l-2 0l-9 -21l0 24l-2 0l0 -28zm-266 8l2 0l0 4l4 -4l5 0l3 3l3 -3l6 0l4 3l0 17l-3 0l0 -16l-2 -2l-4 0l-3 3l0 15l-3 0l0 -16l-2 -2l-3 0l-5 5l0 13l-2 0l0 -20zm103 0l0 25l-3 4l-10 0l-2 -3l0 -3l2 0l0 2l1 2l8 0l2 -3l0 -9l-5 5l-5 0l-4 -4l0 -16l2 0l0 16l2 2l5 0l5 -6l0 -12l2 0zm72 -9l3 0l0 14l4 -5l6 0l4 3l0 17l-3 0l0 -16l-2 -2l-4 0l-5 5l0 13l-3 0l0 -29zm-203 9l0 25l-4 4l-9 0l-3 -3l0 -3l2 0l0 2l2 2l7 0l2 -3l0 -8l-4 4l-7 0l-3 -4l0 -13l3 -3l8 0l3 4l0 -4l3 0zm166 11l0 9l-2 0l0 -8l-3 -4l-11 0l0 12l-3 0l0 -28l16 0l3 3l0 9l-3 3l3 4zm181 -11l2 0l0 5l5 -5l6 0l3 3l0 17l-2 0l0 -16l-2 -2l-4 0l-6 5l0 13l-2 0l0 -20zm22 0l3 0l0 5l4 -5l6 0l4 3l0 17l-3 0l0 -16l-2 -2l-4 0l-5 5l0 13l-3 0l0 -20zm-45 16l0 -16l3 0l0 16l2 2l4 0l5 -5l0 -13l3 0l0 20l-3 0l0 -5l-4 5l-6 0l-4 -4zm-319 1l0 -5l3 -3l11 0l0 -5l-2 -2l-7 0l-2 2l0 2l-2 0l0 -3l3 -3l9 0l4 3l0 17l-3 0l0 -4l-4 4l-7 0l-3 -3zm220 0l0 -5l3 -3l11 0l0 -5l-2 -2l-7 0l-2 2l0 2l-3 0l0 -3l4 -3l9 0l3 3l0 17l-2 0l0 -4l-4 4l-7 0l-3 -3zm-43 -1l0 -13l3 -3l10 0l3 3l0 2l-2 0l0 -1l-2 -2l-8 0l-2 2l0 12l2 2l8 0l2 -2l0 -2l2 0l0 2l-3 4l-10 0l-3 -4zm-122 0l0 -13l4 -3l10 0l3 3l0 8l-14 0l0 5l2 2l8 0l2 -2l0 -2l2 0l0 2l-3 4l-10 0l-4 -4zm201 0l0 -13l4 -3l7 0l4 3l0 -12l2 0l0 29l-2 0l0 -4l-4 4l-7 0l-4 -4zm-304 -24l3 0l9 28l-2 0l-3 -8l-12 0l-2 8l-3 0l10 -28zm135 24l0 -25l3 0l0 13l4 -4l7 0l3 3l0 13l-3 4l-10 0l-4 -4zm156 -16l2 0l0 4l3 -4l5 0l0 2l-4 0l-4 4l0 14l-2 0l0 -20zm-98 6l12 0l2 -2l0 -8l-2 -2l-12 0l0 12zm-45 12l2 -2l0 -12l-2 -2l-5 0l-5 5l0 9l2 2l8 0zm166 0l5 -5l0 -7l-4 -4l-6 0l-3 2l0 12l3 2l5 0zm-274 -11l-4 -5l-6 0l-2 2l0 12l2 2l6 0l4 -4l0 -7zm176 -7l2 0l0 20l-2 0l0 -20zm-209 10l-6 -16l-5 16l11 0zm111 -1l0 -5l-2 -2l-8 0l-2 2l0 5l12 0zm-60 9l4 -5l0 -2l-10 0l-1 1l0 4l1 2l6 0zm220 0l4 -5l0 -2l-10 0l-2 1l0 4l2 2l6 0zm-62 -23l0 -1l1 -1l1 0l1 1l0 1l-1 1l-1 0l-1 -1z"/>   
      -->
       <text x=300 y=510 fill="#fff" class="t2" text-anchor="middle">The Legend of Yeti-404</text>
       <text x=500 y=530 fill="#fff" class="t0" text-anchor="end">#js13k 2020</text>
       <text x=550 y=590 fill="#fff" class="t0" text-anchor="end">A game by Richard Munn</text>
       <text x=550 y=610 fill="#fff" class="t0" text-anchor="end">Music by Mattia Fortunati</text>


      </g>

      <path id="titlef" d="M0 0 h640 v640 h-640 z" fill="#000c"/>

      <g id="menu" filter="url(#f1)">
        <g transform="translate(0 80)">
          <path d="M45 3 h550 v27 h-550 z" fill="#000" fill-opacity="0.4"/>
          <text x=50 y=25 fill="#fff" class="t1"/>
        </g>
      </g>

      <text filter="url(#f1)" id="bottomtext" x=10 y=630 fill="#ff0" class="t1"/>
   
      <path id="vsync" filter="url(#f10)" d="M-10 0 H650 V200 H-640 Z" fill="#303" fill-opacity="0.2" style="pointer-events:none"/>

      <g id="cursor" style="pointer-events:none">
        <path filter="url(#g)" d="M-5 0 h-30 m40 0 h30 m-35 5 v30 m0 -40 v-30" stroke-width="0.7" stroke="#fff" fill-opacity="0"/>
        <text filter="url(#f1)" id="cursorText1" x=8 y=20 fill="#ff0" class="t0"/>
        <text filter="url(#f1)" id="cursorText2" x=8 y=40 fill="#ff0" class="t0"/>
        <text filter="url(#f1)" id="cursorText3" x=8 y=60 fill="#ff0" class="t0"/>
        <text filter="url(#f1)" id="cursorText4" x=8 y=80 fill="#ff0" class="t0"/>
      </g>
      <g style="visibility:hidden">
        <path id="star" d="M-2 -2h2v2h-2z"/>
        <path id="box" d="M-10 -10h20v20h-20z" fill-opacity="0"/>
        <path id="enemybox" d="M0 0"/>
        <path id="mapcell" d="M0 0h12v12h-12z" fill-opacity="0"/>
        <circle id="transponder" cx="6" cy="6" r="4" stroke="#fff", fill-opacity="0" style="pointer-events:none"/>
        <path id="yeti" d="M0 0 l 12 12 M0 12 l 12 -12" stroke="#fff" fill-opacity="0" stroke-width="2" style="pointer-events:none"/>
        <path id="ground" d="M0 0" stroke-width="0.6" stroke="#fff" fill-opacity="0"/>
      </g>
    </g>
  </svg>

  <script>
    
    document.monetization?.addEventListener('monetizationstart', _ => _inventory_.push(_items_.length-1));

    // adapted from https://gist.github.com/banksean/304522
    SN = function () {this.g3 = [[1, 1, 0], [-1, 1, 0], [1, -1, 0], [-1, -1, 0], [1, 0, 1], [-1, 0, 1], [1, 0, -1], [-1, 0, -1], [0, 1, 1], [0, -1, 1], [0, 1, -1], [0, -1, -1]], this.p = []; for (var r = 0; r < 256; r++)this.p[r] = Math.floor(256 * Math.random()); this.m = []; for (r = 0; r < 512; r++)this.m[r] = this.p[255 & r]}; SN.prototype.n = function(t, r) {var i, h, o = (t + r) * (.5 * (Math.sqrt(3) - 1)), s = Math.floor(t + o), e = Math.floor(r + o), p = (3 - Math.sqrt(3)) / 6, a = (s + e) * p, m = t - (s - a), n = r - (e - a); m > n ? (i = 1, h = 0) : (i = 0, h = 1); var d = m - i + p, f = n - h + p, l = m - 1 + 2 * p, u = n - 1 + 2 * p, M = 255 & s, g = 255 & e, v = this.m[M + this.m[g]] % 12, c = this.m[M + i + this.m[g + h]] % 12, x = this.m[M + 1 + this.m[g + 1]] % 12, N = .5 - m * m - n * n, S = .5 - d * d - f * f, q = .5 - l * l - u * u; return 70 * ((N < 0 ? 0 : (N *= N) * N * dot(this.g3[v], m, n)) + (S < 0 ? 0 : (S *= S) * S * dot(this.g3[c], d, f)) + (q < 0 ? 0 : (q *= q) * q * dot(this.g3[x], l, u)))};
    sn = new SN();

    // adapted from https://stackoverflow.com/a/18473154
    arcp = (a,r,n,o) => {return {x:a+n*Math.cos((o-90)*Math.PI/180),y:r+n*Math.sin((o-90)*Math.PI/180)}};
    arc = (a,r,n,o,t) => {i=arcp(a,r,n,t),e=arcp(a,r,n,o),s=t-o<=180?"0":"1";return `M${i.x} ${i.y}A${n} ${n} ${0} ${s} ${0} ${e.x} ${e.y}`};

    kr = decodeURI("%E2%93%9A");

    // adapted from https://www.dwitter.net/d/3078
    _critter_ = _ => {p="";f=m=>p+=`M${((i>>5&1)-X*m/7)} ${(j>>8)-4+Y}h1v1h-1v-1  `;for(j=30;j--;Math.random()>(X**2+(Y-4)**2)**.5/5&&f(7)+f(-7))X=j&3,Y=j>>2&7;return p};

    // decompose a critter into individual 'pixels'
    _decompose_ = o => {
      s = o.getAttribute("d").split("  ");
      for (i=0; i<s.length; ++i) {
        p=o.cloneNode();
        p.removeAttribute("id");
        p.setAttribute("d", s[i]);
        p.d = {x: o.d.x, ry: o.d.ry, r: o.d.r, s: o.d.s, z: o.d.z, dx: o.d.dx + Math.random()*6-3, dy: o.d.dy + Math.random()*6-3, a: 1, _temp_: true,
          _update_: (o, g) => {
            o.d.x += o.d.dx;
            o.d.ry += o.d.dy;
            o.d.y = 250 - o.d.ry + gh * (o.d.z * 2);
            o.d.a-=0.01;
            if (o.d.a<=0)  {
              o.d._dead_ = true
            };
            o.setAttribute("fill-opacity", o.d.a);
            _update_(o)
          }
        };
        l12.appendChild(p);
        _objects_.push(p)
      }
    };

    _clamp_ = (i, n, x) => i < n ? n : i > x ? x : i;
    dot = (t, r, i) => t[0] * r + t[1] * i;
    _sqr_ = x => x * x;

    _itemvalue_ = (i, f) => (i._war_*f._war_) + (i._trade_*f._trade_)+ (i._sci_*f._sci_);

    item = menu.getElementsByTagName("g")[0];
    text = item.getElementsByTagName("text")[0];
    path = item.getElementsByTagName("path")[0];
    for (i=1; i<=16; ++i) {
      item2 = item.cloneNode(); 
      item2.setAttribute("transform", `translate(0 ${80+(i*30)})`);
      item2.appendChild(path.cloneNode());
      item2.appendChild(text.cloneNode());
      menu.appendChild(item2)
    };

    _addMenu_ = (t, i, d, f) => {
      if (i <= 16) {
        item = menu.getElementsByTagName("g")[i];
        item.d = d;
        _show_(item);
        el = item.getElementsByTagName("text")[0];
        el.textContent = t;
        _textwidget_(item, f == null ? null : _ => f(_.target.parentElement.d))
      }
    };

    _hideMenu_ = i => {
      if (i <= 16) _hide_(menu.getElementsByTagName("g")[i])
    };

    _endMenu_ = i => {
      while(i <= 16) _hideMenu_(i++)
    };

    _update_ = o => o.setAttribute("transform", "translate(" + o.d.x + " " + o.d.y + ") rotate(" + o.d.r + ") scale(" + o.d.z + ")");
    _show_ = o => o.removeAttribute("style");
    _hide_ = o => o.setAttribute("style", "visibility:hidden");
    text = o => bottomtext.textContent = o;
    clearcursor = _ => cursorText1.textContent = cursorText2.textContent = cursorText3.textContent = cursorText4.textContent = "";
    _showtitle_ = _ => { gameloop = false; _endMenu_(0); _hide_(game); _hide_(orbit); _hide_(map); _show_(title); _hide_(base); text() };
    _showintro_ = _ => {
      _show_(titlef);
      for (i=0; i< _crawltext_.length; ++i) {
        _addMenu_( _crawltext_[i], i, {}, _ => _showgame_())
      }
    };
    _showmap_ = _ => { gameloop = false; _endMenu_(0); _hide_(game); _hide_(orbit); _show_(map); _hide_(title); _hide_(base); text() ; _updatemap_(ship.d.mx, ship.d.my)};
    _showgame_ = _ => { 
      gameloop = true; _endMenu_(0);_show_(game); _hide_(orbit); _hide_(map); _hide_(title); _hide_(base); _hide_(titlef); text();

      combocount.d.v = 0; combocount.d.c = 0;
      maxlock = ship.d.weapons;

      f = _factionmap_[ship.d.my][ship.d.mx];
      
      waves = f._explored_? 0 : f.waves;
      if (!inwarp) rundistance = waves * 1000;

      if( _tutorialtext_.length > 0) waves = 2;
      
      wavecount = 0;
      enemies = 0;
      missiles = 0;
      maxmissiles = 8;
      targetc = 0;
      bestlock = 0;
      hasfired=false;
      wavetime = 100

      ///#if 0
      console.log("waves: "+waves);
      ///#endif
    };
    _entersystem_ = _ => {
      if (ship.d.scanner > 0) lrs(ship.d.mx, ship.d.my, ship.d.scanner+1);
      _showorbit_()
    };
    _showorbit_ = _ => { 
      gameloop = false; clearcursor(); _hide_(game); _show_(orbit); _hide_(map); _hide_(title); _hide_(base); text(); orbitcoords.textContent = `[${ship.d.mx},${ship.d.my}]`;
      f = _factionmap_[ship.d.my][ship.d.mx];
      f._visited_ = true;

      warprange = ship.d.engines*2;

      orbit_planet.setAttribute("cx", f.random[0]*640);
      orbit_planet.setAttribute("cy", f.random[1]*640);
      orbit_planet.setAttribute("r", f.pradius);
      orbit_planet.setAttribute("stroke", f.pcol);
      orbit_moon.setAttribute("cx", f.random[2]*640);
      orbit_moon.setAttribute("cy", f.random[3]*640);
      orbit_moon.setAttribute("r", f.mradius);
      orbit_moon.setAttribute("stroke", f.mcol);

      if (f._scanned_) {
        infofaction.textContent =  _factions_[f.faction].name;

        infotrade.textContent = f._economy_;
        infopoi.textContent = f._explored_ ?  _places_[f._place_].name : "???"

        ///#if 0
        console.log(`sci:${f._sci_} trade:${f._trade_} war:${f._war_} salvage:${f._salvage_}`);
        console.log(`Place: ${ _places_[f._place_].name}`);
        console.log("Items:");
        for (i=0; i<f._items_.length; ++i) {
          item = _items_[f._items_[i]]
          console.log("+ "+item.name+ " value:"+_itemvalue_(item, f))
        }
        ///#endif

      } else {
        infofaction.textContent = "???";
        infotrade.textContent = "???";
        infopoi.textContent =  "???"
      };
      _updatemap_(ship.d.mx, ship.d.my);

      next = 0;
      
      _addMenu_("> Galaxy Map", next++, {}, _ => _showmap_());
      _hideMenu_(next++);
      if (!f._scanned_) {
        _addMenu_("> Scan System", next++, {}, _ => { 
          _factionmap_[ship.d.my][ship.d.mx]._scanned_ = true; 
          _updatemap_(ship.d.mx, ship.d.my);
          _showorbit_() 
        });
        _hideMenu_(next++)
      };
      _addMenu_("> Enter Atmosphere", next++, {}, _ => {
        inwarp = false;
        _showgame_()
      });
      _hideMenu_(next++);
      _addMenu_("> Ship status", next++, {}, _ => {
        next = 0;
        _addMenu_("< Exit", next++, {}, _ => _showorbit_());
        _hideMenu_(next++);
        _addMenu_(`Weapons: ${ship.d.weapons}`, next++);
        _addMenu_(`Shields: ${ship.d.shields}`, next++);
        _addMenu_(`Engines: ${ship.d.engines}`, next++);
        _addMenu_(`Scanner: ${ship.d.scanner}`, next++);
        _addMenu_(`Science: ${ship.d.science}`, next++);
        _hideMenu_(next++);
        _addMenu_(`Shield Power: ${shields.toFixed(0)}%`, next++);
        _addMenu_(`Warp fuel: ${fuel}/${maxfuel}`, next++);
        _addMenu_(`Warp range: ${warprange}`, next++);
        _hideMenu_(next++);
        if (ship.d.clue > 0) {
          _addMenu_(`${ship.d.clue} transponder clue${ship.d.clue==1?"" : "s"} collected`, next++)
        };
        _endMenu_(next)
      });

      _hideMenu_(next++);

      skip = 0;
      for (var i=0; i<_inventory_.length; ++i) {
        if (_items_[_inventory_[i]].v != null) {
          skip ++;
          _addMenu_(`> Install ${_items_[_inventory_[i]].name}`, next++, {i: _inventory_[i]}, d => {

            v = _items_[d.i].v; 

            next = 0;
            if (!v.clue) {
              next=2;
              _addMenu_(`Weapons: ${ship.d.weapons}`, next++);
              _addMenu_(`Shields: ${ship.d.shields}`, next++);
              _addMenu_(`Engines: ${ship.d.engines}`, next++);
              _addMenu_(`Scanner: ${ship.d.scanner}`, next++);
              _addMenu_(`Science: ${ship.d.science}`, next++);
              i=1;
              if (v.weapons) setTimeout(_ => {{ _upgrade_(); _addMenu_(`Weapons: +${v.weapons} : ${ship.d.weapons+v.weapons}`, 2); ship.d.weapons+=v.weapons}}, 1000*i++);
              if (v.shields) setTimeout(_ => {{ _upgrade_(); _addMenu_(`Shields: +${v.shields} : ${ship.d.shields+v.shields}`, 3); ship.d.shields+=v.shields}}, 1000*i++);
              if (v.engines) setTimeout(_ => {{ _upgrade_(); _addMenu_(`Engines: +${v.engines} : ${ship.d.engines+v.engines}`, 4); ship.d.engines+=v.engines}}, 1000*i++);
              if (v.scanner) setTimeout(_ => {{ _upgrade_(); _addMenu_(`Scanner: +${v.scanner} : ${ship.d.scanner+v.scanner}`, 5); ship.d.scanner+=v.scanner}}, 1000*i++);
              if (v.science) setTimeout(_ => {{ _upgrade_(); _addMenu_(`Science: +${v.science} : ${ship.d.science+v.science}`, 6); ship.d.science+=v.science}}, 1000*i++);
              setTimeout(_ => {_addMenu_("< Exit", 0, {}, _ => _showorbit_())}, 1000*(i-1))
            } else {
              next = 0;
              ship.d.clue++;

              if (ship.d.clue != 3) {
                _addMenu_("< Exit", next++, {}, _ => _showorbit_());
                _hideMenu_(next++)
              } else {
                _hideMenu_(next++);
                _hideMenu_(next++)
              };

              _addMenu_("Found ancient transponder!", next++);
               
              if (ship.d.clue > 3) {
                _addMenu_("Not that we need any more!", next++)
              } else if (ship.d.clue == 3) {
                _addMenu_("We can now triangulate the Yeti's", next++);
                _addMenu_("location...", next++);

                j = 6;
                for (i=1; i<4; ++i) {
                  setTimeout(_ => {
                    _addMenu_("... scanning ...", j++)
                  }, 250*i)
                };
                setTimeout(_ => {
                  _addMenu_("... LOCATION FOUND", 10);

                  x = ship.d.mx;
                  y = ship.d.my;

                  while ((_calcdistance_(x,y) < 10) || (_calcdistance_(x,y) > 20)) {
                    x = 2+Math.floor(Math.random() * 28);
                    y = 2+Math.floor(Math.random() * 28)
                  };

                  o = yeti.cloneNode();
                  o.removeAttribute("id");
                  o.setAttribute("transform", "translate(" + ((x * 16) +40) + " " + ((y * 16) + 34) + ")");
                  map.appendChild(o);

                  _factionmap_[y][x].yeti = true;

                  _addMenu_("> Galaxy Map", 0, {} , _ => _showmap_())
                }, 1250)

              } else {
                _addMenu_(`With ${3-ship.d.clue} more we can triangulate the`, next++);
                _addMenu_("Yeti's location", next++)
              }
            };
            _endMenu_(next);

            _inventory_.splice(_inventory_.indexOf(d.i), 1)
          });
          if (skip==3) break
        }
      };

      if (skip>0) _hideMenu_(next++);

      if (research != null) {
        if (researchtime > 0) {
          j = _clamp_(Math.floor(researchtime/500), 1, 20);
          _addMenu_(`Researching ${_items_[research].name} ${"#".repeat(j)}`, next++)
        } else {
          _addMenu_("> Research complete!", next++, {}, _ => {
            next = 0;
            _addMenu_("< Exit", next++, {}, _ => _showorbit_());
            _hideMenu_(next++);

            w = _clamp_(25 - _items_[research]._research_ - ship.d.science, 4, 20);

            k = _getWeighted_(_items_, w);

            if (k == null) {
              _addMenu_("Discovered nothing of value", next++)
            } else {
              _addMenu_(`Discovered ${_items_[k].name}`, next++);
              _inventory_.push(k)
            };

            _endMenu_(next);
            research = null
          })
        }
      } else {
        i=0;
        seen = [];
        for (j=0; j<_inventory_.length; ++j) {
          if (_items_[_inventory_[j]]._research_ <= ship.d.science && !seen.includes(_inventory_[j])) {
            _addMenu_ (`> Research ${_items_[_inventory_[j]].name}`, next++, {i: _inventory_[j]}, d => {
              research = d.i;
              _inventory_.splice(_inventory_.indexOf(d.i), 1);
              researchtime = _items_[d.i]._research_ * 1000;
              _showorbit_()
            });
            i++;
            seen.push(_inventory_[j]);
            if (i==3) break
          }
        }
      };

      _endMenu_(next)

    };
    _showwarp_ = _ => {
      inwarp = true;
      _gowarp_();
      _entersystem_();
      _showgame_();

      // build stars
      for(i=0; i<200; ++i) {
        o=star.cloneNode();
        o.setAttribute("fill", cols[i%cols.length]);
        o.setAttribute("fill-opacity", 0.1+(Math.random()*0.7));
        o.removeAttribute("id");
        o.d = { r: Math.random(), rx: 300 + (Math.random() * 40), ry: 300 + (Math.random() * 40), z: 0.1, _temp_:true,

          _update_: (o,g)=> {
            m = 1.1 + ((Math.abs(o.d.rx - 320)) / 500);
            o.d.z += m / 10;
            o.d.r += 1;
            o.d.rx = ((o.d.rx - 320) * m) + 320;
            o.d.ry = ((o.d.ry - 320) * m) + 320;
            if (o.d.rx < 0 || o.d.rx > 640 || o.d.ry < 0 || o.d.ry > 640) {
              o.d.rx = 305 + (Math.random() * 30);
              o.d.ry = 305 + (Math.random() * 30);
              o.d.z = 0.5
            }; 

            o.d.x = ((320-ship.d.x) * 0.1) + o.d.rx;
            o.d.y = ((320-ship.d.y) * 0.1) + o.d.ry;

            _update_(o)
          }
        };

        _objects_.push(o);
        l10.appendChild(o)
      }

    };

    _showtrade_ = _ => { 
      gameloop = false; clearcursor(); _hide_(game); _hide_(orbit); _hide_(map); _hide_(title); _show_(base); text();

      f = _factionmap_[ship.d.my][ship.d.mx];
      f._explored_ = true;
      next = 0;

      base_planet.setAttribute("rx", f.pradius * 5);
      base_planet.setAttribute("stroke", f.pcol);
      base_moon.setAttribute("cx",f.random[2]*640);
      base_moon.setAttribute("cy", f.random[3]*340);
      base_moon.setAttribute("r", f.mradius*2);
      base_moon.setAttribute("stroke", f.mcol);

      base_sc1.setAttribute("transform", `translate(${-20 +(f.random[0]*340)} 0)`); // tower
      base_sc2.setAttribute("transform", `translate(${-200 +(f.random[1]*340)} 0)`); // skyline1
      base_sc3.setAttribute("transform", `translate(${-200 +(f.random[2]*340)} 0)`); // skyline2
      base_sc4.setAttribute("transform", `translate(${-200 +(f.random[3]*340)} 0)`); // hut
      base_sc5.setAttribute("transform", `translate(${-210 +(f.random[4]*340)} 0)`); // wreckage

      _hide_(base_sc1);_hide_(base_sc2);_hide_(base_sc3);_hide_(base_sc4);_hide_(base_sc5);

      if (f._trade_ == 0) _show_(base_sc5);

      if (f._trade_ >=1 ) _show_(base_sc4);
      if (f._trade_ >=3 ) _show_(base_sc2);
      if (f._trade_ >=5 ) _show_(base_sc3);
      if (f._trade_ >=8 ) _show_(base_sc1);

      if (_factionmap_[ship.d.my][ship.d.mx].yeti) {

        tradename.textContent = "Yeti Location";

        _factionmap_[ship.d.my][ship.d.mx].yeti = false;
        for (next=0; next< _endtext_.length;) {
          _addMenu_( _endtext_[next], next++, {}, _ => _showtrade_())
        }
      
      } else {

        tradename.textContent = _places_[f._place_].name;

        _inventory_.sort((a, b) => _itemvalue_(_items_[b], f) - _itemvalue_(_items_[a], f));

        maxfuel = ship.d.engines * 25;
        text(`kredits: ${kr} ${kredits}   fuel: ${fuel}/${maxfuel}`);

        _addMenu_("< Return to orbit", next++, {}, _ => _showorbit_());
        _hideMenu_(next++);

        if (f._trade_ == 0) {
          _addMenu_("Search for scrap", next++, {}, _ => {

            next = 2;

            for (i=0; i<f._items_.length; ++i) {
              _addMenu_(`Found ${_items_[f._items_[i]].name}!`, next++);
              _inventory_.push(f._items_[i])
            };

            f._items_ = []

          });

          _hideMenu_(next++)

        } else {

          if (fuel < maxfuel) {
            fuelcost = 5 + Math.floor(f.random[3]*10);
            _addMenu_(`> Buy fuel : ${kr} ${fuelcost}`, next++, {v: fuelcost}, d => {
              if (kredits >= d.v) {
                kredits -= d.v;
                fuel++;
                _showtrade_()
              }
            })
          };

          if (shields < 100) {
            shieldcost = _clamp_(Math.round((0.5+f.random[2])*(100-shields)/2), 3, 100);          
            _addMenu_(`> Recharge shields : ${kr} ${shieldcost}`, next++, {v: shieldcost}, d => {
              if (kredits >= d.v) {
                kredits -= d.v;
                shields = 100;
                _showtrade_()
              }
            })
          };

          for (i=0; i<f._items_.length; ++i) {
            v = _itemvalue_(_items_[f._items_[i]], f);
            _addMenu_(`> Buy ${_items_[f._items_[i]].name} : ${kr} ${v}`, next++, {i: f._items_[i], v: v}, d => {
              if (kredits >= d.v) {
                _inventory_.push(d.i);
                kredits -= d.v;
                f._items_.splice(f._items_.indexOf(d.i), 1);
                _showtrade_()
              }
            })
          };

          if (f._items_.length > 0) _hideMenu_(next++);

          for (i=0; i<_inventory_.length; ++i) {
            v = Math.round(_itemvalue_(_items_[_inventory_[i]], f) * 0.8);
            if (v > 0 && _items_[_inventory_[i]].v == null) {
              _addMenu_(`> Sell ${_items_[_inventory_[i]].name} : ${kr} ${v}`, next++, {i: _inventory_[i], v: v}, d => {
                kredits += d.v;
                _inventory_.splice(_inventory_.indexOf(d.i), 1);
                _showtrade_()
              })
            }
          }
        }
      };

      _endMenu_(next)

    };

    cols = ["#f00", "#f70", "#ff0", "#7f0", "#0f0", "#0f7", "#0ff", "#07f", "#00f", "#70f", "#f0f", "#f07"];
    factionCol = ["#333", "#f0f", "#ff0", "#05f"];
     _factions_ = [
      {name:"Unclaimed sector",    _sci_:1, _trade_:1, _war_:1},
      {name:"Trade Federation",    _sci_:3, _trade_:6, _war_:1},
      {name:"Union of Science",    _sci_:5, _trade_:4, _war_:1},
      {name:"The Empire",          _sci_:1, _trade_:3, _war_:6}
    ];

    _items_ = [
      {w:1,   name:"Weapons upgrade",        _sci_:4, _trade_:4, _war_:8, v: { weapons:1 }},
      {w:2,   name:"Shields upgrade",        _sci_:6, _trade_:4, _war_:6, v: { shields:1 }},
      {w:3,   name:"Science upgrade",        _sci_:8, _trade_:4, _war_:4, v: { science:1 }},
      {w:4,   name:"Engines upgrade",        _sci_:5, _trade_:6, _war_:5, v: { engines:1 }},
      {w:5,   name:"Scanner upgrade",        _sci_:8, _trade_:4, _war_:4, v: { scanner:1 }},

      {w:30,  name:"Assorted junk",          _sci_:1, _trade_:1, _war_:1, _research_:1},
      {w:40,  name:"Salvage",                _sci_:2, _trade_:2, _war_:1, _research_:2},
      {w:45,  name:"Strange foodstuffs",     _sci_:1, _trade_:2, _war_:1},
      {w:60,  name:"Mysterious boxes",       _sci_:6, _trade_:3, _war_:1, _research_:3},
      {w:63,  name:"Odd trinkets",           _sci_:1, _trade_:4, _war_:1},
      {w:65,  name:"Small furry creatures",  _sci_:5, _trade_:7, _war_:1},
      {w:68,  name:"Lab grown meat",         _sci_:3, _trade_:2, _war_:4},
      {w:72,  name:"Service robots",         _sci_:5, _trade_:4, _war_:2},
      {w:75,  name:"Entertainment devices",  _sci_:2, _trade_:6, _war_:2},
      {w:78,  name:"Medical supplies",       _sci_:4, _trade_:6, _war_:6},
      {w:80,  name:"Exotic weapons",         _sci_:4, _trade_:6, _war_:9, _research_:6},

      {w:90,  name:"Luxury goods",           _sci_:4, _trade_:8, _war_:5},
      {w:100, name:"Advanced technology",    _sci_:7, _trade_:9, _war_:8, _research_:10},

      {w:999, name:"Ancient transponder",    _sci_:3, _trade_:3, _war_:3, v: {clue:1}},
      
      {w:9999, name:"Bonus upgrade",         _sci_:0, _trade_:0, _war_:0, v: {weapons:2, shields:2, science:2, engines:2, scanner:2}}
    ];

    _places_ = [      
      {w: 40, name:"Abandoned colony", _trade_:0, _salvage_: 2, _sci_:1},
      {w: 50, name:"Trading Post", _trade_:1, _salvage_: 0, _sci_:1},
      {w: 70, name:"Small colony", _trade_:2, _salvage_: 0,_sci_:1},
      {w: 88, name:"Crashsite", _trade_:0, _salvage_: 3, _sci_:1},
      {w: 90, name:"Medium colony", _trade_:3, _salvage_: 0,_sci_:2},
      {w: 95, name:"Ancient Ruins", _trade_:0, _salvage_: 5, _sci_:1},
      {w:100, name:"Large colony", _trade_:4, _salvage_: 0,_sci_:3}
    ];

    _crawltext_ = [
      /****************************************/
      "A millennia ago, the great Ark Fleet",
      "set out across the galaxy to escape the",
      "certain doom of the ancient homeworld.",
      ,
      "Many colonies prospered, many failed,",
      "and some vanished without trace,",
      "disappearing into fokelaw and legend.",
      ,
      "Whilst an alien curse sweeps across",
      "the galaxy, threatening humanity's",
      "existence, you form a crew to seek out",
      "Ark Ship YTI-404, long thought lost,",
      "but which now might carry the answer to",
      "defeating the alien threat.",
      ,
      "Good luck Commander, the whole galaxy",
      "depends on what you may find.",
    ];

    _endtext_ = [
      /****************************************/
      "And so the lost colony was found!",
      "",
      "Much old data was restored, and the",
      "three factions united in the quest",
      "to decypher all the ancient knowledge",
      "required to finally defeat the enemy",
      "threat once and for all.",
      "",
      "As for your crew, you decide to",
      "continue your journey across the",
      "galaxy..."
    ];
   
    tutorialt = 0;
    _tutorialtext_ = [
      {t: "Welcome...", e: _ => (wavecount > 0)},
      {t: "Watch out for the critters", e: _ => (tutorialt>100)},
      {t: "Hold LMB to lock on", e: _ => (bestlock>0)},
      {t: "Release LMB to fire", e: _ => hasfired},
      {t: "Lock mutiple for multiplier", e: _ => (bestlock>1)},
      {t: "Good luck!", e: _ => (tutorialt>100)}
    ];
      
    _getWeighted_ = (i,x) => {
      r = Math.random() * (x==null ? 100 : x);
      for (j=0; j<i.length; ++j) {
        if (i[j].w>r) return j
      };
      return null
    };

    targets = []; shipcell = null;

    _objects_ = []; _fxobjects_ = []; _inventory_ = [];

    mousedown = false;

    kredits = 25;
    shields = 100;
    wavec = 0;
    shieldhit = 0;
    research = null;
    researchtime = 0;
    fuel = 25;
    maxfuel = 50;
    warprange = 5;
    rundistance = 0;
    inwarp = false;

    _calcfuel_ = d => Math.abs(d.x - ship.d.mx) + Math.abs(d.y - ship.d.my);
    _calcdistance_ = (x,y) => Math.sqrt((x-ship.d.mx)*(x-ship.d.mx)+(y-ship.d.my)*(y-ship.d.my)); 

    titleclick = 0;

    _hide_(titlef);

    title.onclick = _ => {
      zzfx(...[0,,,,,,,,,,,,,,,,,]);

      setTimeout(_ => {
        music = zzfxP(..._songdata_);  // Play the song
        music.loop = true
      }, 500);

      _showintro_()
    };

    titlef.onclick = _ => {      
      _showgame_()
    };

    _endMenu_(0);

    ship.d = { r: 0, x: 320, y: 550, z: 10, mx: 10 + Math.floor(Math.random() * 12), my: 10 + Math.floor(Math.random() * 12),
      weapons: 2 + Math.floor(Math.random()*3),
      shields: 1 + Math.floor(Math.random()*3),
      science: 1 + Math.floor(Math.random()*3),
      engines: 1 + Math.floor(Math.random()*3),
      scanner: 0 + Math.floor(Math.random()*3),
      clue: 0,
      _update_: (o, g) => {
        o.d.x = (o.d.x * 0.8 + (320 + (mx * 320)) * 0.2);
        o.d.y = (o.d.y * 0.8 + (400 + (my * 100)) * 0.2);
        gh = 27.5 - (my * 12.5);
        gx -= ((o.d.x - 320) / 3000);
        shipd.setAttribute("d", `M${(320 - o.d.x) / 100} ${(o.d.y - 400) / 50} L-5 4 L0 8 L5 4 Z M-5 4 L0 1 L5 4`);
        if (shieldhit>0 || shields <= 10) {
          _show_(ships);
          if (shields >= 10) {
            ships.setAttribute("stroke", "#00f");
            ships.setAttribute("fill", "#00f")
          } else {
            ships.setAttribute("stroke", "#f00");
            ships.setAttribute("fill", "#f00")
          };
          shieldhit--
        } else {
          _hide_(ships)
        };
        _update_(o)
      }
    };
    _objects_.push(ship);
    _update_(ship);

    combocount.d = { 
      v:0, c:0,
    
      _update_: (o,g) => {
        if (o.d.v <= 0) {
          combocount.setAttribute("d", "");
          combocounttext.textContent = "";
          o.d.c = 0
        } else {
          combocount.setAttribute("d", arc(550, 80, 40, 360-o.d.v, 359.9));
          combocounttext.textContent = `x${o.d.c}`
        };
        o.d.v-= ((targetc+missiles == 0) ? 5 : 0.5) // combo counter drops faster when no lock or missiles
      }
    };

    _objects_.push(combocount);

    _factionmap_ = [];

    for (y = 0; y < 32; ++y) {
      _factionmap_[y] = [];
      for (x = 0; x < 32; ++x) {
        dist=_calcdistance_(x,y);
        f = {
          faction:0, _visited_: false, _explored_: false, _scanned_: dist<5, 
          _place_: _getWeighted_( _places_),
          _items_: [],
          pradius: 100+Math.random()*300,
          pcol: cols[Math.floor(Math.random()*cols.length)],    
          mradius: 10+Math.random()*100,
          mcol: cols[Math.floor(Math.random()*cols.length)],
          random: [Math.random(),Math.random(),Math.random(),Math.random(),Math.random()]
        };

        f._sci_ = Math.floor(Math.random()*3 *  _factions_[f.faction]._sci_ *  _places_[f._place_]._sci_);
        f._trade_ = Math.round((1+Math.random()*2) *  _factions_[f.faction]._trade_ *  _places_[f._place_]._trade_);
        f._war_ = Math.floor(Math.random()*4*  _factions_[f.faction]._war_);
        f._salvage_ = Math.round(Math.random()*3 *  _factions_[f.faction]._trade_ *  _places_[f._place_]._salvage_);

        f.waves = Math.min(f._war_ * f._war_, Math.floor(dist/3)+1);
        if (f.waves<=2) {
          f.critters="low"
        } else if (f.waves <=4) {
          f.critters="med"
        } else {
          f.critters = "high"
        };

        if (f._sci_ == f._trade_ && f._sci_ == f._war_) {
          f._economy_ = "Balanced"
        } else if (f._sci_ == f._trade_ && f._sci_ > f._war_) {
          f._economy_ = "Technology"
        } else if (f._sci_ > f._trade_ && f._sci_ > f._war_) {
          f._economy_ = "Science"
        } else if (f._trade_ > f._sci_ && f._trade_ > f._war_) {
          f._economy_ = "Trade"
        } else if (f._trade_ > f._sci_ && f._trade_ == f._war_) {
          f._economy_ = "Arms"
        } else if (f._war_ > f._trade_ && f._war_ > f._sci_) {
          f._economy_ = "Warfare"
        } else if (f._sci_ == f._war_ && f._war_ > f._trade_) {
          f._economy_ = "Espionage"
        };

        combo = f._sci_ + f._trade_ + f._war_;

        if (combo < 5) {
          f._economy_ += " (D)"
        } else if (combo < 8) {
          f._economy_ += " (C)"
        } else if (combo < 13) {
          f._economy_ += " (B)"
        } else {
          f._economy_ += " (A)"
        };

        // ///#if 0
        // if (combo >= 10)
        // console.log(`${x},${y} ${f._economy_} ${combo}`)
        // ///#endif

        for (i=0; i< Math.min(1+(f._trade_+f._salvage_),8); ++i) {
          f._items_.push(_getWeighted_(_items_))
        };

        _factionmap_[y][x] = f
      }
    };


    clue = _items_.findIndex(_ => _.w==999);
    for (i=0; i<10; ++i) {
      if (i==0) {
        x = ship.d.mx - 4 + Math.floor(Math.random() * 8);
        y = ship.d.my - 4 + Math.floor(Math.random() * 8)
      } else {
        while (_calcdistance_(x,y) < 5 || _factionmap_[y][x]._items_.includes(clue)) {
          x = Math.floor(Math.random() * 32);
          y = Math.floor(Math.random() * 32)
        }
      };
      _factionmap_[y][x]._items_.push(clue)
      ///#if 0
      console.log(`Clue at ${x},${y}`)
      ///#endif
    };

    x = 10 + Math.floor(Math.random() * 22);
    y = 10 + Math.floor(Math.random() * 22);

    for (i = 1; i < 4; ++i) {
      factionSize = 50 + Math.floor(Math.random() * 250);
      while (_factionmap_[y][x].faction != 0) {
        x = 10 + Math.floor(Math.random() * 22);
        y = 10 + Math.floor(Math.random() * 22)
      };
      _factionmap_[y][x].faction = i;

      seeds = [];

      seeds.push([x,y]);

      j = 0;
      fail = 0;
      while (j < factionSize && fail < 500) {

        v = seeds[Math.floor(Math.random() * seeds.length)];

        x = _clamp_( v[0] - 5 + Math.floor(Math.random() * 10), 0, 31);
        y = _clamp_( v[1] - 5 + Math.floor(Math.random() * 10), 0, 31);

        if (_factionmap_[y][x].faction == 0) {
          _factionmap_[y][x].faction = i;
          seeds.push([x,y]);
          ++j
        } else {
          fail++
        }
      }
    };

    _textwidget_ = (e, f) => {
      if (f) {
        e.onmouseenter = _ => _.target.getElementsByTagName("text")[0].setAttribute("fill", "#990");
        e.onmouseleave = _ => _.target.getElementsByTagName("text")[0].setAttribute("fill", "#fff");
        e.onclick = _ => {_blip_(); f(_)}
      } else {
        e.getElementsByTagName("text")[0].setAttribute("fill", "#fff");
        e.onmouseenter = null;
        e.onmouseleave = null;
        e.onclick = null
      }
    };

    _textwidget_(mapexit, _ => _showorbit_() );

    _updatemap_ = (x,y) => {
      if (_factionmap_[y][x]._scanned_) {
        if (x == ship.d.mx && y == ship.d.my) {
          _factionmap_[y][x].mapcell.setAttribute("stroke", "#fff")
        } else {
          _factionmap_[y][x].mapcell.setAttribute("stroke", "#fff5")
        };
        _factionmap_[y][x].mapcell.setAttribute("fill", factionCol[_factionmap_[y][x].faction]);
        _factionmap_[y][x].mapcell.setAttribute("fill-opacity", _factionmap_[y][x]._visited_ ? "0.9" : "0.4");
        if (_factionmap_[y][x].clue) {
          if (_factionmap_[y][x]._items_.includes(clue)) {
          _show_(_factionmap_[y][x].clue)
          } else {
            _hide_(_factionmap_[y][x].clue)
          }
        }
      }
    };

    lrs = (x,y,r) => {
      for (y1=_clamp_(y-r,0,32); y1<_clamp_(y+r,0,32); ++y1) {
        for (x1=_clamp_(x-r,0,32); x1<_clamp_(x+r,0,32); ++x1) {
          if (Math.sqrt(_sqr_(x-x1)+_sqr_(y-y1))<=r) { 
            _factionmap_[y1][x1]._scanned_=true;
            _updatemap_(x1,y1) 
          }
        }
      }
    };

    // build map
    for (y = 0; y < 32; ++y) {
      for (x = 0; x < 32; ++x) {

        o = mapcell.cloneNode();
        o.removeAttribute("id");
        o.setAttribute("transform", "translate(" + ((x * 16) +40) + " " + ((y * 16) + 34) + ")");

        o.d = { x: x, y: y };

        if (x == ship.d.mx && y == ship.d.my) {
          o.setAttribute("stroke", "#fff");
          o.setAttribute("stroke-width", 3);
          shipcell = o
        } else {
          o.setAttribute("stroke", _factionmap_[y][x]._scanned_ ? "#fff5" : "#000")
        };

        _factionmap_[y][x].mapcell = o;
        
        _updatemap_(x,y);
        
        o.onmouseenter = _ => {
          d = _.target.d;
          f = _factionmap_[d.y][d.x];
          fuelneed = _calcfuel_(d);
          dist = _calcdistance_(d.x, d.y);
          if (dist > warprange) {
            text("Beyond engine warp range ( " + warprange + " sectors )")
          } else {
            text("Warp requires " + fuelneed + " fuel. "+fuel+" available")
          };
          if (fuelneed <= fuel && dist <= warprange) {
            f.mapcell.setAttribute("stroke", "#fff")
          } else {
            f.mapcell.setAttribute("stroke", "#f00")
          };

          cursorText1.textContent = `[${d.x},${d.y}]`;
          cursorText2.textContent = f._scanned_ ?  _factions_[f.faction].name : "";
          cursorText3.textContent = f._scanned_ ? f._economy_ : "";
          cursorText4.textContent = f._explored_ ?  _places_[f._place_].name : (f._scanned_&&ship.d.scanner>1 ? "Critters: "+f.critters :"");
          if (f._scanned_ && f._items_.includes(clue)) cursorText4.textContent = "Transponder Signal!";
          if (f.yeti) cursorText4.textContent = "YETI LOCATION!"

        };
        o.onmouseleave = _ => {
          d = _.target.d;
          f = _factionmap_[d.y][d.x];
          if (_.target.d.x == ship.d.mx && _.target.d.y == ship.d.my) {
            f.mapcell.setAttribute("stroke", "#fff");
            o.setAttribute("stroke-width", 3)
          } else {
            f.mapcell.setAttribute("stroke", _factionmap_[_.target.d.y][_.target.d.x]._scanned_ ? "#fff5" : "#000");
            o.setAttribute("stroke-width", 1)
          }
        };
        o.onclick = _ => {
          d = _.target.d;
          f = _factionmap_[d.y][d.x];
          fuelneed = _calcfuel_(_.target.d);
          if (fuelneed == 0) {
            _showorbit_()
          } else if (fuelneed <= fuel) {
            fuel -= fuelneed;
            rundistance = Math.max(100, fuelneed * 75);
            ship.d.mx = _.target.d.x;
            ship.d.my = _.target.d.y;
            f.mapcell.setAttribute("stroke", "#ff0");
            shipcell.setAttribute("stroke", "#fff2");
            shipcell = f.mapcell;
            _showwarp_()
          }
        };

        map.appendChild(o);

        if (_factionmap_[y][x]._items_.includes(clue)) {    
          o = transponder.cloneNode();
          o.removeAttribute("id");
          o.setAttribute("transform", "translate(" + ((x * 16) +40) + " " + ((y * 16) + 34) + ")");
          map.appendChild(o);
          if (!_factionmap_[y][x]._scanned_) {
            _hide_(o)
          };
          _factionmap_[y][x].clue = o;
          o.d = _factionmap_[y][x].mapcell.d;
          o.onclick = _factionmap_[y][x].mapcell.onclick;
          o.onmouseenter = _factionmap_[y][x].mapcell.onmouseenter;
          o.onmouseleave = _factionmap_[y][x].mapcell.onmouseleave
        }
      }
    };

    // target boxes
    for (i = 0; i < 8; ++i) {
      o = box.cloneNode();
      o.setAttribute("stroke", "#fff");
      o.setAttribute("stroke-width", "0.3");
      o.removeAttribute("id");
      o.d = { r: 90, x: -200, y: -200, z: 1, t: null,     
        _update_: (o, g) => {
          if (mousedown || missiletime > 0) {
            if (o.d.t) {
              o.d.x = o.d.t.x;
              o.d.y = o.d.t.y;
              o.d.r = o.d.r * 0.75;
              o.d.z = (4 + o.d.z) / 2
            }
          } else {
            if (o.d.t != null) {
              if (maxmissiles - missiles > 0) {
                if (missiletime == 0) {
                  m = _firemissile_();

                  m.d.x = ship.d.x;
                  m.d.y = ship.d.y;
                  m.d.t = o.d.t;
                  m.d.to = o.d.to;

                  o.d.t = null;
                  o.d.x = -100;
                  o.d.y = -100;
                  targets.push(o)
                }
              }
            }
          };
          _update_(o)
        }
      };
      targets.push(o);
      _update_(o);
      l11.appendChild(o)
    };

    _firemissile_ = _ => {
      missiles++;
      hasfired=true;

      o = box.cloneNode();
      o.setAttribute("stroke", "#fff");
      o.setAttribute("stroke-width", "2");
      o.removeAttribute("id");
      o.d = { r: 0, x: -200, y: -200, z: 1, t: null, f:0, l:100, _temp_:true,
        _update_: (o, g) => {
          if (o.d.t && !o.d.t._dead_) {
            o.d.x = (o.d.x * 0.85) + (o.d.t.x * 0.15);
            o.d.y = (o.d.y * 0.85) + (o.d.t.y * 0.15);
            o.d.z = o.d.z * 0.95;
            o.d.f++;

            if (o.d.z < 0.001 || o.d.l-- == 0) {
              o.d._dead_ = true;
              missiles--
            };

            if (o.d.f > 20 && (Math.abs(o.d.x - o.d.t.x) + Math.abs(o.d.y - o.d.t.y)) < 50) {
              _explosion_();
              o.d._dead_ = true;
              o.d.t._dead_ = true;
              _decompose_(o.d.to);

              if (combocount.d.v > 0) {
                combocount.d.c ++
              } else {
                combocount.d.c = 1
              };

              combocount.d.v = 360;

              enemies--;
              missiles--
            };

            _update_(o)
          }
        } 
      };

      _update_(o);
      l11.appendChild(o);

      _objects_.push(o);
      _shoot_();

      missiletime = 4;

      return o
    };

    _doTarget_ = _ => {
      if (mousedown) {
        if (targets.length > 0 && targetc < maxlock) {
          t = targets.pop();
          t.d.t = _.target.d;
          t.d.to = _.target;
          t.d.z = 1000;
          t.d.r = 90;
          _objects_.push(t);
          _lock_(700 + (50 * targetc));
          _.target.onmouseenter = null;
          targetc++;
          bestlock = Math.max(bestlock, targetc);
          cursorText1.textContent = `Lock: ${targetc} / ${maxlock}`
        }
      }
    };

    _doZap_ = o => {
      zap = ground.cloneNode();
      zap.removeAttribute("id");
      zap.setAttribute("filter","url(#g)");
      p="M0 0";
      for (k=1; k<65; k++) p+= `L${(Math.random()*k*2)-k} ${k*10}`;
      zap.setAttribute("d", p);
      zap.d = {x: o.d.x, y: o.d.y, r:0, s:1, z:1, _dead_: true, _temp_: true, _update_: _ => {}};
      _objects_.push(zap);
      _update_(zap);
      l12.appendChild(zap);
      
      if (Math.abs(o.d.x - ship.d.x) < 25) { 
        shields-=(1+(wavecount/3));
        shieldhit += 5;
        _shields_()
      } else {
        _zap_()
      }
    };

    _makeCritter_ = (i, r, s, wave, u) => {
      o = enemybox.cloneNode();
      o.removeAttribute("id");
      
      o.setAttribute("d", _critter_());
      o.setAttribute("fill",cols[(i+r) % cols.length]);

      o.onmouseenter = _doTarget_;

      o.d = { wave: wave, r: 0, x: Math.random() * 640, ry: Math.random() * 640, s: s, z: 0.1, dx:0, dy:0, _temp_:true,_update_:u };

      _objects_.push(o);
      enemies++;
      l12.appendChild(o);

      return o
    };

    _enemywave_ = _ => {
      wave = wavec < 3 ? 0 : Math.round(Math.random()*3);
      _wave1_();
      s = 0.1;
      wavecount++;
      wavec++;

      r = Math.floor(Math.random()*10);

      for (i = 0; i < wavecount*2; ++i) { 

        o = _makeCritter_(i,r,s,wave, (o, g) => {
          o.d.dx = o.d.x;
          o.d.dy = o.d.ry;

          tx = 0;
          ty = 0;

          if (o.d.wave == 0) {
            tx = g.x;
            ty = g.y
          } else if (o.d.wave == 1) {
            tx = (ship.d.x+g.x) / 2;
            ty = g.y
          } else if (o.d.wave == 2) {
            tx = g.x1;
            ty = g.y1
          } else if (o.d.wave == 3) {
            tx = g.x2;
            ty = g.y2
          };
          
          o.d.x = (o.d.x * (1 - o.d.s)) + (tx * o.d.s);
          o.d.ry = (o.d.ry * (1 - o.d.s)) + (ty * o.d.s);

          o.d.dx = o.d.x - o.d.dx;
          o.d.dy = o.d.ry - o.d.dy;

          o.d.z = (o.d.z * 0.95) + (5.0 + Math.sin(n - (o.d.s * 500))) * 0.05;

          if (Math.random() * 1000 < wavecount*10) _doZap_(o);

          if (!o.d._dead_) {
            o.d.y = 250 - o.d.ry + gh * (o.d.z * 2);
            if (o.d.wave <= 1) {
              g.x = o.d.x;
              g.y = o.d.ry
            } else if (o.d.wave == 2) {
              g.x1 = o.d.x;
              g.y1 = o.d.y
            } else if (o.d.wave == 3) {
              g.x2 = o.d.x;
              g.y2 = o.d.y
            }
          } else {
            o.d.y = -100
          };
          _update_(o)
        });
        s+= 0.0005
      }

    };


    // landscape
    slices = 20;
    div = 10;
    for (i = 0; i < slices; ++i) {
      o = ground.cloneNode();
      o.removeAttribute("id");
      o.d = { i: i + 2, sq:_sqr_(i+2),
        _update_: (o, g) => {
          s = "";

          if (!inwarp) {
            // landscape
            for (x = 0; x <= 64; ++x) {
              rx = ((32 - x) * ((slices + 1 - o.d.i) / 10)) / div;

              hrz = sn.n((g.gx + rx)*(0.5+g.f.random[0]), ((o.d.i + g.gy) / div)*(0.5+g.f.random[1]));
              s += `${x == 0 ? "M" : "L"}${x * 10} ${(100 - (gh * 3)) + ((gh / slices) * o.d.sq) + (hrz * o.d.sq / 2)}`
            }

          } else {
            // warp tunnel

            wx = sn.n(g.gx, g.gy/100) * 200;
            for (i=0; i<64; ++i) {
              x = Math.sin(i/63*(Math.PI*2));
              y = Math.cos(i/63*(Math.PI*2));

              rx = ((32 - (i%63)) * ((slices + 1 - o.d.i) / 10)) / div;
              r = 1+(sn.n((g.gx + rx)*(0.5+g.f.random[3]), ((o.d.i + g.gy) / div)*(0.5+g.f.random[2])))/10;
              s += `${i == 0 ? "M" : "L"}${320+((320-ship.d.x+wx)*(o.d.i/15))+(x*((r*o.d.i*30)))} ${320+((320-ship.d.y)*(o.d.i/15))+(y*((r*o.d.i*30)))}`
            }

          };
          o.setAttribute("d", s);
          o.setAttribute("stroke", _factionmap_[ship.d.my][ship.d.mx].pcol);
          l10.appendChild(o)
        }
      };
      _objects_.push(o)
    };

    missiletime = 0;
    gameloop = false;

    focus = true;
    window.onfocus = _ => {focus = true; zzfxX.resume()};
    window.onblur = _ => {focus = false; zzfxX.suspend()};
    n = 0;

    cursor.d = { r: 0, x: 320, y: 320, z: 1,
      _update_: (o, g) => {
        o.d.x = 320 + (mx * 320);
        o.d.y = 320 + (my * 320);
        _update_(o)
      }
    };
    _fxobjects_.push(cursor);
    _update_(cursor);

    vsync.d = { r: 0, x: 0, y: 0, z: 1,
      _update_: (o, g) => {
        o.d.y += 16;
        if (o.d.y > 640) o.d.y = -200;
        _update_(o)
      }
    };
    _fxobjects_.push(vsync);

    _showtitle_();

    c.onmousedown = _ => {
      focus = true;
      mousedown = gameloop
    };
    c.onmouseup = _ => {
      if (gameloop) {
        mousedown = false;
        missiletime = 0;
        targetc = 0;
        clearcursor()
      }
    };

    mx = 0;
    my = 0;
    rect = c.getBoundingClientRect();

    window.onresize = _ => rect = c.getBoundingClientRect();

    c.onmousemove = _ => {
      size = Math.min(rect.width, rect.height) / 2;
      mx = _clamp_(((_.clientX - rect.left) - (rect.width / 2)) / size, -1, 1);
      my = _clamp_(((_.clientY - rect.top) - (rect.height / 2)) / size, -1, 1)
    };

    gx = 100;
    gy = 0;
    gh = 10;

    _cleartemp_ = _ => {
      x = _objects_.length;
      _ = _objects_;
      _objects_ = [];

      _.forEach(o => {
        if (o.d._temp_) {
          o.remove() 
        } else {
          _objects_.push(o)
        }
      })
      ///#if 0
      console.log(`${x-_objects_.length} _objects_ culled`)
      ///#endif
    };

    g = {
      x2c: 320,
      y2c: 200
    };

    // Game loop
    setInterval( _ => {
      if (!focus) return;

      _fxobjects_.forEach(o => o.d._update_(o, g));

      if (researchtime > 0) researchtime--;

      shields = _clamp_(shields+(ship.d.shields/200), 0, 100);

      if (!gameloop) return;

      if (shields > 0 && shields < 100) {
        text(`Shields: ${shields.toFixed(0)}%`)
      } else {
        if (shields <= 0) {
          _show_(tutorial);
          tutorial.textContent = "G A M E O V E R";
          ship.d._dead_=true;
          _gameover_();
          shields = 0;
          gameloop = false;
          setTimeout(_ => location.reload(), 10000);
          return
        }
        //focus = false
      };

      if (shields <= 10 && (Math.floor(n*10)%10)==0) _alert_();

      n += 0.025;
      rundistance -= 1;

      if (Math.random() < 0.05) {
        if (inwarp) {_inwarp_()} else{_running_()}
      };

      gy -= 1;
      if (missiletime > 0) missiletime--;


      g.x= 320 + (Math.sin(n) * 150);
      g.y= 200 + (Math.cos(n) * 150);
      g.x1= 320 + (Math.sin(n*2) * 315);
      g.y1= 100 + n;

      if (Math.random() < 0.01) {
        g.x2c = 110+ (Math.random() * 420);
        g.y2c = 110+ (Math.random() * 300)
      };

      g.x2= g.x2c + (Math.sin(n*3) * 100);
      g.y2= g.y2c + (Math.cos(n*3) * 100);

      g.f= _factionmap_[ship.d.my][ship.d.mx];
      g.gy= gy;
      g.gx= gx;
      g.gh= gh;

      _ = _objects_;
      _objects_ = [];

      _.forEach(o => {
        o.d._update_(o, g);
        if (o.d._dead_) {
          o.remove() 
        } else {
          _objects_.push(o)
        }
      });

      //if (rundistance < -500) {
      //  _cleartemp_();
      //  _showorbit_()
      ///};

      if (enemies == 0) {
        wavetime--;
        if (wavetime == 0) {
          if (inwarp) {
            if (rundistance<=0) {
              _cleartemp_();
              _showorbit_()
            } else {
              wavetime = 25;
              _enemywave_() 
            }            
          } else {
            rundistance = 1000;
            if (waves==0) {
              _cleartemp_();
              _showtrade_();
              return
            } else {
              waves--;
              wavetime = 25;
              _enemywave_()
            }
          }
        }
      };

      if ( _tutorialtext_.length > 0) {
        tutorialt++;
        tutorial.textContent =  _tutorialtext_[0].t;
        if ( _tutorialtext_[0].e != null) {
          if ( _tutorialtext_[0].e()) {
             _tutorialtext_.shift();
            tutorialt = 0;
            if ( _tutorialtext_.length == 0) _hide_(tutorial)
          }
        }
      }

    }, 50);


    // zzfx() - the universal entry point -- returns a AudioBufferSourceNode
    zzfx=(...t)=>zzfxP(zzfxG(...t));
    zzfxP=(...t)=>{let e=zzfxX.createBufferSource(),f=zzfxX.createBuffer(t.length,t[0].length,zzfxR);t.map((d,i)=>f.getChannelData(i).set(d)),e.buffer=f,e.connect(zzfxX.destination),e.start();return e};
    zzfxG=(q=1,k=.05,c=220,e=0,t=0,u=.1,r=0,F=1,v=0,z=0,w=0,A=0,l=0,B=0,x=0,G=0,d=0,y=1,m=0,C=0)=>{let b=2*Math.PI,H=v*=500*b/zzfxR**2,I=(0<x?1:-1)*b/4,D=c*=(1+2*k*Math.random()-k)*b/zzfxR,Z=[],g=0,E=0,a=0,n=1,J=0,K=0,f=0,p,h;e=99+zzfxR*e;m*=zzfxR;t*=zzfxR;u*=zzfxR;d*=zzfxR;z*=500*b/zzfxR**3;x*=b/zzfxR;w*=b/zzfxR;A*=zzfxR;l=zzfxR*l|0;for(h=e+m+t+u+d|0;a<h;Z[a++]=f)++K%(100*G|0)||(f=r?1<r?2<r?3<r?Math.sin((g%b)**3):Math.max(Math.min(Math.tan(g),1),-1):1-(2*g/b%2+2)%2:1-4*Math.abs(Math.round(g/b)-g/b):Math.sin(g),f=(l?1-C+C*Math.sin(2*Math.PI*a/l):1)*(0<f?1:-1)*Math.abs(f)**F*q*zzfxV*(a<e?a/e:a<e+m?1-(a-e)/m*(1-y):a<e+m+t?y:a<h-d?(h-a-d)/u*y:0),f=d?f/2+(d>a?0:(a<h-d?1:(h-a)/d)*Z[a-d|0]/2):f),p=(c+=v+=z)*Math.sin(E*x-I),g+=p-p*B*(1-1E9*(Math.sin(a)+1)%2),E+=p-p*B*(1-1E9*(Math.sin(a)**2+1)%2),n&&++n>A&&(c+=w,D+=w,n=0),!l||++J%l||(c=D,v=H,n=n||1);return Z};
    zzfxV=.3;zzfxR=44100;zzfxX=new(top.AudioContext);

    //! ZzFXM (v2.0.3) | (C) Keith Clark | MIT | https://github.com/keithclark/ZzFXM
    zzfxM=(n,f,t,e=125)=>{let l,o,z,r,g,h,x,a,u,c,d,i,m,p,G,M=0,R=[],b=[],j=[],k=0,q=0,s=1,v={},w=zzfxR/e*60>>2;for(;s;k++)R=[s=a=d=m=0],t.map((e,d)=>{for(x=f[e][k]||[0,0,0],s|=!!f[e][k],G=m+(f[e][0].length-2-!a)*w,p=d==t.length-1,o=2,r=m;o<x.length+p;a=++o){for(g=x[o],u=o==x.length+p-1&&p||c!=(x[0]||0)|g|0,z=0;z<w&&a;z++>w-99&&u?i+=(i<1)/99:0)h=(1-i)*R[M++]/2||0,b[r]=(b[r]||0)-h*q+h,j[r]=(j[r++]||0)+h*q+h;g&&(i=g%1,q=x[1]||0,(g|=0)&&(R=v[[c=x[M=0]||0,g]]=v[[c,g]]||(l=[...n[c]],l[2]*=2**((g-12)/12),g>0?zzfxG(...l):[])))}m=G});return[b,j]};

    
    _lock_ = f => zzfx(...[, , f, .02, , .08, 1, 1.19, 11, , -344, .02, , , , , , .04, .02]); 
    _explosion_ = _ => zzfx(...[, , 585, .01, .23, .21, 4, 4.87, , , , , , .4, , .3, , .76, .13, .44]); 
    _shoot_ = _ => zzfx(...[, , 169, .02, , .24, 1, .77, .2, , , , , 2.1, , .1, , .93, .09, .02]); 
    _wave1_ = _ => zzfx(...[, , 388, .38, .4, .66, , 1.46, .5, -3.8, 4, .02, .15, , , , , .61, .02]); 
    _shields_ = _ => zzfx(...[,,603,.02,,.14,4,1.36,-0.6,.5,,,,,,,.05,.68,.08,.39]); 
    _zap_ = _ => zzfx(...[,,409,.02,,.21,,.64,-0.4,.3,,,,,,,.2,.61,.05,.21]);
    _gowarp_ = _ => zzfx(...[,.3,1016,.38,.5,.5,1,.7,4.8,-6.7,-6,.01,.04,1.2,.1,,.05,1.9,1]);
    _inwarp_ = _ => zzfx(...[.25,25,51,.33,.03,.52,1,0,,-2.6,-318,.04,.01,,,.1,.13,1.1,.1,.43]);
    _blip_ = _ => zzfx(...[2.8,,403,.01,,.07,,1.87,,,,,,.2,4.3,,.11,.66,,.02]); 
    _running_ = _ => zzfx(...[,,43,,.19,1.72,1,1.53,,,,,,.3,,.9,.23,.92,.01,.01]);
    _gameover_ = _ => zzfx(...[,,533,,3,3,3,3.49,.5,.4,,,,.6,.2,.2,,.6,1]);
    _alert_ = _ => zzfx(...[,,150,,.9,0,,.1,,3.5,,,,,1.4,,.33,,.14]);
    _upgrade_ = _ => zzfx(...[,,688,.28,.32,.38,2,,,-5.8,-827,.02,.09,,.1,,.14,.69,.03]);

    // Space by Mattia Fortunati - https://www.mattiafortunati.com/
    _songdata_ = zzfxM(...[[[1.5,0,84,,,,,.7,,,,.5,,6.7,1,.05],[,0,655,,,.09,3,1.65,,,,,,3.8,,,1],[.5,0,80,,,1,3],[.3,0,80,,1,.35,3,,,,,,,,,,,,,1],[.3,0,240,,1,.35,3,,,,,,,,,,,,,1],[.5,0,4e3,,,.03,2,1.25,,,,,.02,6.8,-.3,,.3],[.3,0,80,,.5,.35,3,,,,,.09,.05]],[[[,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,1,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,1,,,,1,,],[1,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,1],[5,,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5],[2,,1,8,5,8,1,8,5,8,1,8,5,8,1,8,5,8,5,12,8,12,5,12,8,12,5,12,8,12,5,12,8,12,1,8,5,8,1,8,5,8,1,8,5,8,1,8,5,8,8,15,12,15,8,15,12,15,8,15,12,15,8,15,12,15],[3,,,1,1,1,,1,1,1,,1,1,1,,1,1,1,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,1,1,1,,1,1,1,,1,1,1,,1,1,1,,8,8,8,,8,8,8,,8,8,8,,8,8,8],[4,,1,,,,,,,,,,,,10,,,,5,,,,,,,,,,,,6,,5,,1,,,,,,1,,5,,1,,5,,10,,8,,,,,,,,,,,,,6,5,3]],[[,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,1,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,1,,,,1,,],[1,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,1],[5,,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5],[2,,1,8,5,8,1,8,5,8,1,8,5,8,1,8,5,8,5,12,8,12,5,12,8,12,5,12,8,12,5,12,8,12,1,8,5,8,1,8,5,8,1,8,5,8,1,8,5,8,8,15,12,15,8,15,12,15,8,15,12,15,8,15,12,15],[3,,,1,1,1,,1,1,1,,1,1,1,,1,1,1,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,1,1,1,,1,1,1,,1,1,1,,1,1,1,,8,8,8,,8,8,8,,8,8,8,,8,8,8],[4,,1,8,5,8,1,,,,,,,,,,,,5,12,8,12,5,,,,,,,,,,,,1,5,8,10,8,,,,,,,,,,,,12,,,,8,,,,,,,,,,,,]],[[,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,1,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,1,,,,1,,],[6,,1,8,5,8,1,8,5,8,1,8,5,8,1,8,5,8,5,12,8,12,5,12,8,12,5,12,8,12,5,12,8,12,1,8,5,8,1,8,5,8,1,8,5,8,1,8,5,8,8,15,12,15,8,15,12,15,8,,,,,,,,],[5,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,5,,5,,,,5,5],[1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,5,,,5],[6,,,,,,,,,,,,,,,,,,,5,5,5,,5,5,5,,,,,,,,,,,,,,,,,,,,,,,,,,8,8,8,,8,8,8,,,,,,,,,]],[[,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,1,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,1,,,,1,,],[1,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,1],[5,,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,5,5,5],[2,,1,8,5,8,1,8,5,8,1,8,5,8,1,8,5,8,5,12,8,12,5,12,8,12,5,12,8,12,5,12,8,12,1,8,5,8,1,8,5,8,1,8,5,8,1,8,5,8,8,15,12,15,8,15,12,15,8,15,12,15,8,15,12,15],[3,,,1,1,1,,1,1,1,,1,1,1,,1,1,1,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,1,1,1,,1,1,1,,1,1,1,,1,1,1,,8,8,8,,8,8,8,,8,8,8,,8,8,8]],[[6,,1,8,5,8,1,8,5,8,1,8,5,8,1,8,5,8,5,12,8,12,5,12,8,12,5,12,8,12,5,12,8,12,1,8,5,8,1,8,5,8,1,8,5,8,1,8,5,8,8,15,12,15,8,15,12,15,8,15,12,15,8,15,12,15],[3,,,1,1,1,,1,1,1,,1,1,1,,1,1,1,,5,5,5,,5,5,5,,5,5,5,,5,5,5,,1,1,1,,1,1,1,,1,1,1,,1,1,1,,8,8,8,,8,8,8,,8,8,8,,8,8,8],[4,,1,,,,,,,,,,,,10,,,,5,,,,,,,,,,,,6,,5,,1,,,,,,,,,,,,10,,,,8,,,,,,,,,,,,,,,,],[,,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,1,,1,,,,1,,],[1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,1,,,1],[5,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,1,,1,,1,,1,,]],[[4,,1,,,,,,,,,,,,10,,,,5,,,,,,,,,,,,,,,,1,,,,,,,,,,,,5,,,,3,,,,,,,,1,,,,,,,,],[,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,],[1,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,],[5,,1,,1,,1,,1,,1,,1,,1,,1,,1,,,,1,,,,1,,,,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,],[6,,1,8,5,8,1,8,5,8,1,8,5,8,1,8,5,8,5,12,8,12,5,12,8,12,5,12,8,12,5,12,8,12,1,8,5,8,1,8,5,8,1,8,5,8,1,8,5,8,5,12,8,12,5,12,8,12,5,12,8,12,5,,8,,],[3,,,1,1,1,,1,1,1,,,,,,,,,,5,5,5,,5,5,5,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,]]],[2,3,0,0,1,1,4,0,1,5],85,])

  </script>
</body>